<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Schedule Viewer (MU Search)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D;
      --pill:#e9f6f0;
    }
    body{
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
      margin:20px;padding:20px;max-width:1200px;background:var(--light-bg);color:var(--text-color)
    }
    #logo-container{text-align:center;margin-bottom:20px}
    #logo{width:300px}
    h1{margin:0 0 16px}
    .card{
      background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;
      padding:24px;margin-top:16px;box-shadow:0 1px 3px rgba(0,0,0,.08)
    }
    label{display:block;font-weight:600;margin-bottom:6px}
    input,select,button,textarea{
      padding:10px;border:1px solid var(--border-color);border-radius:6px;background:#fff;font-size:14px
    }
    button{
      background:var(--primary-color);color:#fff;font-weight:600;cursor:pointer;transition:background .2s
    }
    button:hover{background:var(--secondary-color)}
    button:disabled{background:var(--text-light);cursor:not-allowed}
    .controls{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;align-items:end
    }
    .full-width-btn{width:100%;padding:14px 18px;font-size:16px;margin-top:12px}
    .muted{color:var(--text-light);font-size:12px;margin-top:4px}
    .section-title{margin:0 0 10px;color:var(--secondary-color)}

    #messageContainer{display:none;margin-top:12px}
    .error-message{
      color:#b4231a;background:#fee2e2;border:1px solid:#fecaca;padding:10px;border-radius:6px
    }
    .success-message{
      color:#14532d;background:#dcfce7;border:1px solid:#bbf7d0;padding:10px;border-radius:6px
    }
    .info-message{
      color:#6b4e16;background:#fff7ed;border:1px solid:#ffedd5;padding:10px;border-radius:6px
    }

    .schedule-table{width:100%;border-collapse:collapse;margin-top:16px}
    .schedule-table th,.schedule-table td{
      border:1px solid var(--border-color);padding:8px;font-size:13px
    }
    .schedule-table th{background:var(--light-bg);text-align:left}
    .pill{
      display:inline-flex;align-items:center;padding:4px 8px;border-radius:999px;
      background:var(--pill);font-size:11px;color:var(--secondary-color)
    }
    .schedule-meta{margin-top:8px;font-size:12px;color:var(--text-light)}
    details pre{
      max-height:250px;overflow:auto;background:#0f172a;color:#e5e7eb;
      padding:10px;border-radius:6px;font-size:11px
    }
  </style>
</head>
<body>
  <div id="logo-container">
    <img id="logo" src="https://raw.githubusercontent.com/gmcglynn88/ExternalWorkCreation/main/Consultinglogo.png" alt="Company Logo">
  </div>

  <h1>Schedule Viewer</h1>

  <div id="authCard" class="card">
    <div id="auth-message" class="info-message">Authenticating with Genesys Cloud...</div>
  </div>

  <div id="appContent" style="display:none;">
    <div id="messageContainer"></div>

    <div class="card">
      <h2 class="section-title">Filters</h2>
      <div class="controls">
        <div>
          <label for="businessUnitSelect">Business Unit</label>
          <select id="businessUnitSelect">
            <option value="">Select business unit</option>
          </select>
          <div class="muted">Required</div>
        </div>

        <div>
          <label for="managementUnitSelect">Management Unit</label>
          <select id="managementUnitSelect" disabled>
            <option value="">Select management unit</option>
          </select>
          <div class="muted">Required for schedule search</div>
        </div>

        <div>
          <label for="teamSelect">Team</label>
          <select id="teamSelect">
            <option value="">All teams</option>
          </select>
          <div class="muted">Optional – narrows users by team</div>
        </div>

        <div>
          <label for="userSelect">User</label>
          <select id="userSelect">
            <option value="">Select user</option>
          </select>
          <div class="muted">Required – schedule shown for this user</div>
        </div>

        <div>
          <label for="startDate">Start date</label>
          <input type="date" id="startDate" />
          <div class="muted">e.g. 2025-11-03</div>
        </div>

        <div>
          <label for="endDate">End date</label>
          <input type="date" id="endDate" />
          <div class="muted">e.g. 2025-11-08</div>
        </div>
      </div>

      <button id="loadScheduleBtn" class="full-width-btn">Load Schedule</button>
    </div>

    <div id="results" class="card" style="display:none;"></div>
  </div>

  <script>
    // ===== OAuth Config =====
    const clientId = 'fe305808-b368-4547-8af9-325d28d552bb';
    // IMPORTANT: update this to the URL where THIS file is hosted
    const redirectUri = 'https://gmcglynn88.github.io/Late_Break-Report/';

    const oauthUrl =
      'https://login.mypurecloud.ie/oauth/authorize?client_id=' +
      encodeURIComponent(clientId) +
      '&response_type=token&redirect_uri=' +
      encodeURIComponent(redirectUri);

    const apiBase = 'https://api.mypurecloud.ie';

    let accessToken = null;
    let allUsers = [];
    let usersById = {};
    let allTeams = [];
    let activityCodesByBuId = {}; // Cache for activity codes by business unit ID

    // ===== Auth bootstrap =====
    document.addEventListener('DOMContentLoaded', () => {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      const qparams = new URLSearchParams(window.location.search);

      const oauthError = params.get('error') || qparams.get('error');
      const oauthErrorDesc = params.get('error_description') || qparams.get('error_description');

      if (oauthError) {
        const msg = document.getElementById('auth-message');
        msg.textContent = `OAuth error: ${oauthErrorDesc || oauthError}`;
        msg.className = 'error-message';
        console.error('OAuth error details:', { error: oauthError, description: oauthErrorDesc });
        return;
      }

      accessToken = params.get('access_token');

      if (accessToken) {
        sessionStorage.setItem('purecloud_token', accessToken);
        window.location.hash = '';
        initializeApplication();
      } else if (sessionStorage.getItem('purecloud_token')) {
        accessToken = sessionStorage.getItem('purecloud_token');
        initializeApplication();
      } else {
        window.location.href = oauthUrl;
      }
    });

    function showMessage(msg, type = 'error') {
      const box = document.getElementById('messageContainer');
      box.innerHTML = `<div class="${type}-message">${msg}</div>`;
      box.style.display = 'block';
      if (type === 'success' || type === 'info') {
        setTimeout(() => { box.style.display = 'none'; }, 6000);
      }
    }

    function initializeApplication() {
      document.getElementById('auth-message').textContent = 'Authenticated successfully!';
      document.getElementById('authCard').style.display = 'none';
      document.getElementById('appContent').style.display = 'block';

      initializeScheduleApp();
    }

    function authorizedFetch(url, options = {}) {
      const headers = {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json',
        ...(options.headers || {})
      };
      return fetch(url, { ...options, headers });
    }

    async function authorizedFetchJson(url, options = {}) {
      const response = await authorizedFetch(url, options);
      if (!response.ok) {
        throw new Error(`Error calling ${url}: ${response.status} ${response.statusText}`);
      }
      return response.json();
    }

    async function fetchAllPages(url) {
      let allItems = [];
      let pageNumber = 1;
      let hasMorePages = true;

      while (hasMorePages) {
        const response = await authorizedFetch(`${url}?pageNumber=${pageNumber}&pageSize=100`);
        if (!response.ok) {
          throw new Error(`Error fetching data: ${response.status} ${response.statusText}`);
        }
        const data = await response.json();
        allItems = allItems.concat(data.entities || []);
        if (data.pageCount && data.pageCount > pageNumber) {
          pageNumber++;
        } else {
          hasMorePages = false;
        }
      }
      return allItems;
    }

    async function initializeScheduleApp() {
      document.getElementById('loadScheduleBtn').addEventListener('click', loadSchedule);
      document.getElementById('businessUnitSelect').addEventListener('change', handleBusinessUnitChange);
      document.getElementById('managementUnitSelect').addEventListener('change', handleManagementUnitChange);
      document.getElementById('teamSelect').addEventListener('change', handleTeamChange);

      try {
        await Promise.all([
          populateInitialData()
        ]);
        showMessage('Initial data loaded – set your filters and hit "Load Schedule".', 'info');
      } catch (err) {
        console.error('Error initialising app:', err);
        showMessage(`Error loading initial data: ${err.message}`, 'error');
      }
    }

    async function populateInitialData() {
      const [users, businessUnitsResponse, teams] = await Promise.all([
        fetchAllPages(`${apiBase}/api/v2/users`),
        authorizedFetchJson(`${apiBase}/api/v2/workforcemanagement/businessunits`),
        fetchAllPages(`${apiBase}/api/v2/teams`)
      ]);

      allUsers = (users || []).filter(u => !u.deleted);
      usersById = {};
      allUsers.forEach(u => { usersById[u.id] = u; });

      populateUserSelect(allUsers);
      populateBusinessUnitSelect(businessUnitsResponse);
      populateTeamSelect(teams);
    }

    function populateUserSelect(users) {
      const userSelect = document.getElementById('userSelect');
      userSelect.innerHTML = '<option value="">Select user</option>';
      const sorted = [...users].sort((a, b) => (a.name || '').localeCompare(b.name || ''));
      sorted.forEach(user => {
        const opt = document.createElement('option');
        opt.value = user.id;
        opt.text = user.name || user.id;
        userSelect.add(opt);
      });
    }

    function populateBusinessUnitSelect(businessUnitsResponse) {
      const buSelect = document.getElementById('businessUnitSelect');
      buSelect.innerHTML = '<option value="">Select business unit</option>';
      const list = businessUnitsResponse.entities || businessUnitsResponse.businessUnits || businessUnitsResponse || [];
      list.forEach(bu => {
        const opt = document.createElement('option');
        opt.value = bu.id;
        opt.text = bu.name || bu.id;
        buSelect.add(opt);
      });
    }

    function populateTeamSelect(teams) {
      allTeams = teams || [];
      const teamSelect = document.getElementById('teamSelect');
      teamSelect.innerHTML = '<option value="">All teams</option>';
      const sorted = [...allTeams].sort((a, b) => (a.name || '').localeCompare(b.name || ''));
      sorted.forEach(team => {
        const opt = document.createElement('option');
        opt.value = team.id;
        opt.text = team.name || team.id;
        teamSelect.add(opt);
      });
    }

    async function handleBusinessUnitChange() {
      const buId = document.getElementById('businessUnitSelect').value;
      const muSelect = document.getElementById('managementUnitSelect');
      muSelect.innerHTML = '<option value="">Select management unit</option>';
      muSelect.disabled = true;

      if (!buId) return;

      try {
        // Load activity codes for this business unit
        await loadActivityCodes(buId);
        
        const muResponse = await authorizedFetchJson(
          `${apiBase}/api/v2/workforcemanagement/managementunits?businessUnitId=${encodeURIComponent(buId)}`
        );
        const list = muResponse.entities || muResponse.managementUnits || [];
        list.forEach(mu => {
          const opt = document.createElement('option');
          opt.value = mu.id;
          opt.text = mu.name || mu.id;
          muSelect.add(opt);
        });
        muSelect.disabled = false;
      } catch (err) {
        console.error('Error loading management units:', err);
        showMessage(`Error loading management units: ${err.message}`, 'error');
      }
    }

    // ===== New function to load activity codes from business unit =====
    async function loadActivityCodes(businessUnitId) {
      try {
        console.log(`Loading activity codes for business unit: ${businessUnitId}`);
        const activityCodesResponse = await authorizedFetchJson(
          `${apiBase}/api/v2/workforcemanagement/businessunits/${encodeURIComponent(businessUnitId)}/activitycodes`
        );
        
        const activityCodes = activityCodesResponse.entities || [];
        console.log(`Loaded ${activityCodes.length} activity codes`, activityCodes);
        
        // Create a lookup map by ID
        const activityCodeMap = {};
        activityCodes.forEach(code => {
          activityCodeMap[code.id] = {
            name: code.name,
            category: code.category
          };
        });
        
        // Cache the activity codes for this business unit
        activityCodesByBuId[businessUnitId] = activityCodeMap;
        
        return activityCodeMap;
      } catch (err) {
        console.error('Error loading activity codes:', err);
        // Return empty map but don't fail completely
        activityCodesByBuId[businessUnitId] = {};
        return {};
      }
    }

    // ===== Function to get activity name from code =====
    function getActivityName(businessUnitId, activityCodeId) {
      if (!businessUnitId || !activityCodeId) return 'Unknown Activity';
      
      const activityCodes = activityCodesByBuId[businessUnitId];
      if (activityCodes && activityCodes[activityCodeId]) {
        return activityCodes[activityCodeId].name;
      }
      
      // Fallback for common system codes
      const fallbackNames = {
        '0': 'Work',
        '1': 'Break'
      };
      
      return fallbackNames[activityCodeId] || activityCodeId || 'Unknown Activity';
    }

    async function handleManagementUnitChange() {
      const muId = document.getElementById('managementUnitSelect').value;
      if (!muId) {
        populateUserSelect(allUsers);
        return;
      }

      try {
        const muUsersResponse = await authorizedFetchJson(
          `${apiBase}/api/v2/workforcemanagement/managementunits/${encodeURIComponent(muId)}/users`
        );
        const list = muUsersResponse.entities || muUsersResponse.users || [];
        const enriched = list.map(uRef => usersById[uRef.id] || uRef);
        populateUserSelect(enriched);
      } catch (err) {
        console.error('Error loading MU users:', err);
        showMessage(`Error loading management unit users: ${err.message}`, 'error');
      }
    }

    async function handleTeamChange() {
      const teamId = document.getElementById('teamSelect').value;
      if (!teamId) {
        const muId = document.getElementById('managementUnitSelect').value;
        if (!muId) {
          populateUserSelect(allUsers);
        }
        return;
      }

      try {
        const teamMembersResponse = await authorizedFetchJson(
          `${apiBase}/api/v2/teams/${encodeURIComponent(teamId)}/members`
        );
        const members = teamMembersResponse.entities || teamMembersResponse.members || [];
        const enriched = members.map(m => usersById[m.id] || m);
        populateUserSelect(enriched);
      } catch (err) {
        console.error('Error loading team members:', err);
        showMessage(`Error loading team members: ${err.message}`, 'error');
      }
    }

    // ===== Main schedule search using MU schedules/search =====
    async function loadSchedule() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.style.display = 'block';
      resultsDiv.innerHTML = '';

      const buId = document.getElementById('businessUnitSelect').value;
      const muId = document.getElementById('managementUnitSelect').value;
      const userId = document.getElementById('userSelect').value;
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;

      if (!buId) {
        resultsDiv.innerHTML = `<div class="error-message">Please select a business unit.</div>`;
        return;
      }
      if (!muId) {
        resultsDiv.innerHTML = `<div class="error-message">Please select a management unit.</div>`;
        return;
      }
      if (!userId) {
        resultsDiv.innerHTML = `<div class="error-message">Please select a user.</div>`;
        return;
      }
      if (!startDate || !endDate) {
        resultsDiv.innerHTML = `<div class="error-message">Please select both a start and end date.</div>`;
        return;
      }
      if (endDate < startDate) {
        resultsDiv.innerHTML = `<div class="error-message">End date must be on or after the start date.</div>`;
        return;
      }

      const button = document.getElementById('loadScheduleBtn');
      const originalLabel = button.textContent;
      button.disabled = true;
      button.textContent = 'Loading schedule...';

      const startDateIso = `${startDate}T00:00:00.000Z`;
      const endDateIso = `${endDate}T00:00:00.000Z`;

      try {
        const searchResult = await searchSchedules(muId, userId, startDateIso, endDateIso, true);
        console.log('Raw WFM search result:', searchResult);
        const activities = extractUserActivitiesFromSearchResult(searchResult, userId, buId);
        console.log('Extracted activities count:', activities.length);
        renderScheduleResults(resultsDiv, activities, userId, startDateIso, endDateIso, searchResult);
      } catch (err) {
        console.error('Error loading schedule:', err);
        resultsDiv.innerHTML = `<div class="error-message">Error loading schedule: ${err.message}</div>`;
      } finally {
        button.disabled = false;
        button.textContent = originalLabel;
      }
    }

    async function searchSchedules(managementUnitId, userId, startDateIso, endDateIso, loadFullWeeks) {
      const body = {
        userIds: [userId],
        startDate: startDateIso,
        endDate: endDateIso,
        loadFullWeeks: loadFullWeeks
      };

      const url = `${apiBase}/api/v2/workforcemanagement/managementunits/${encodeURIComponent(managementUnitId)}/schedules/search`;

      return authorizedFetchJson(url, {
        method: 'POST',
        body: JSON.stringify(body)
      });
    }

    // ===== Fixed function to extract activities from search result =====
    function extractUserActivitiesFromSearchResult(response, userId, businessUnitId) {
      console.log('Full response structure:', response);
      
      let userSchedule = null;

      // Handle the nested structure from your sample data
      if (response && response.userSchedules) {
        // Your data structure: userSchedules is an object keyed by userId
        if (response.userSchedules[userId]) {
          userSchedule = response.userSchedules[userId];
        } else {
          // Fallback: take the first user schedule if userId doesn't match key
          const firstUserId = Object.keys(response.userSchedules)[0];
          userSchedule = response.userSchedules[firstUserId];
        }
      }

      const rows = [];

      // If we found a user schedule, extract shifts and full day time off markers
      if (userSchedule) {
        // Process shifts (regular scheduled activities)
        const shifts = Array.isArray(userSchedule.shifts) ? userSchedule.shifts : [];
        console.log(`Found ${shifts.length} shifts for user`, shifts);

        shifts.forEach(shift => {
          const shiftStartDate = shift.startDate ? new Date(shift.startDate) : null;
          const shiftDateStr = shiftStartDate ? shiftStartDate.toISOString().slice(0, 10) : null;
          
          const activities = Array.isArray(shift.activities) ? shift.activities : [];
          console.log(`Shift ${shift.id} has ${activities.length} activities`, activities);

          activities.forEach(activity => {
            const startIso = activity.startDate;
            const lengthMin = activity.lengthInMinutes;

            if (!startIso || lengthMin == null) {
              console.warn('Skipping activity missing startDate or lengthInMinutes:', activity);
              return;
            }

            const start = new Date(startIso);
            const end = new Date(start.getTime() + lengthMin * 60000);

            // Use the API-based activity name lookup
            const activityLabel = activity.description && activity.description.trim().length 
              ? activity.description 
              : getActivityName(businessUnitId, activity.activityCodeId);

            const dateStr = shiftDateStr || start.toISOString().slice(0, 10);

            rows.push({
              date: dateStr,
              start,
              end,
              durationMinutes: lengthMin,
              activityLabel,
              countsAsPaidTime: activity.countsAsPaidTime,
              activityCodeId: activity.activityCodeId,
              type: 'shift'
            });
          });
        });

        // Process full day time off markers (like Sick days)
        const fullDayTimeOffMarkers = Array.isArray(userSchedule.fullDayTimeOffMarkers) ? userSchedule.fullDayTimeOffMarkers : [];
        console.log(`Found ${fullDayTimeOffMarkers.length} full day time off markers`, fullDayTimeOffMarkers);

        fullDayTimeOffMarkers.forEach(marker => {
          const dateStr = marker.managementUnitDate;
          const lengthMin = marker.lengthInMinutes || 480; // Default to 8 hours if not specified
          
          if (!dateStr) {
            console.warn('Skipping marker missing managementUnitDate:', marker);
            return;
          }

          // Create a full day activity (typically 9 AM to 5 PM)
          const start = new Date(`${dateStr}T09:00:00Z`);
          const end = new Date(`${dateStr}T17:00:00Z`);

          // Use the API-based activity name lookup
          const activityLabel = marker.description && marker.description.trim().length 
            ? marker.description 
            : getActivityName(businessUnitId, marker.activityCodeId);

          rows.push({
            date: dateStr,
            start,
            end,
            durationMinutes: lengthMin,
            activityLabel: `${activityLabel} (Full Day)`,
            countsAsPaidTime: marker.isPaid !== false, // Default to true if not specified
            activityCodeId: marker.activityCodeId,
            type: 'fullDayOff'
          });
        });
      }

      rows.sort((a, b) => {
        if (a.date === b.date) {
          return a.start - b.start;
        }
        return a.date.localeCompare(b.date);
      });

      console.log(`Extracted ${rows.length} activities total (${rows.filter(r => r.type === 'shift').length} shifts + ${rows.filter(r => r.type === 'fullDayOff').length} full day off)`);
      return rows;
    }

    function formatTime(d) {
      if (!d) return '';
      return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function formatDuration(mins) {
      if (mins == null || isNaN(mins)) return '';
      const total = Math.max(0, Math.round(mins));
      const h = Math.floor(total / 60);
      const m = total % 60;
      if (h === 0) return `${m}m`;
      if (m === 0) return `${h}h`;
      return `${h}h ${m}m`;
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    function renderScheduleResults(container, activities, userId, startDateIso, endDateIso, rawResult) {
      const user = usersById[userId];
      const userName = user ? user.name : userId;

      const startDateStr = startDateIso.slice(0, 10);
      const endDateStr = endDateIso.slice(0, 10);

      let html = `
        <h2 class="section-title">Schedule for ${escapeHtml(userName)}</h2>
        <div class="schedule-meta">
          <span class="pill">From: ${escapeHtml(startDateStr)}</span>
          &nbsp;
          <span class="pill">To: ${escapeHtml(endDateStr)}</span>
          &nbsp;
          <span class="pill">Source: MU schedules/search</span>
        </div>
      `;

      if (!activities.length) {
        html += `<div class="info-message" style="margin-top:12px;">No activities found for this user in the selected date range.</div>`;
      } else {
        html += `
          <table class="schedule-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Activity</th>
                <th>Start</th>
                <th>End</th>
                <th>Duration</th>
                <th>Type</th>
              </tr>
            </thead>
            <tbody>
        `;
        activities.forEach(row => {
          html += `
            <tr>
              <td>${escapeHtml(row.date)}</td>
              <td>${escapeHtml(row.activityLabel || '')}</td>
              <td>${escapeHtml(formatTime(row.start))}</td>
              <td>${escapeHtml(formatTime(row.end))}</td>
              <td>${escapeHtml(formatDuration(row.durationMinutes))}</td>
              <td>${escapeHtml(row.type === 'fullDayOff' ? 'Full Day Off' : 'Shift')}</td>
            </tr>
          `;
        });
        html += `</tbody></table>`;
      }

      html += `
        <details style="margin-top:16px;">
          <summary class="muted">Raw search JSON (debug)</summary>
          <pre>${escapeHtml(JSON.stringify(rawResult, null, 2))}</pre>
        </details>
      `;

      container.innerHTML = html;
    }
  </script>
</body>
</html>
