<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Attendance Insights - By IPI</title>
  <style>
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D;
      --pill:#e9f6f0;
    }
    body{font-family:"Aptos","Segoe UI",Arial,sans-serif;margin:20px;padding:20px;max-width:1400px;background:var(--light-bg);color:var(--text-color)}
    #logo-container{text-align:center;margin-bottom:20px} #logo{width:300px}
    h1{margin:0 0 16px}
    .card{background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;padding:24px;margin-top:16px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    label{display:block;font-weight:600;margin-bottom:6px}
    select,input,button{padding:10px;border:1px solid var(--border-color);border-radius:6px;background:var(--card-bg);font-size:14px}
    button{background:var(--primary-color);color:#fff;font-weight:600;cursor:pointer;transition:background .2s}
    button:hover{background:var(--secondary-color)} button:disabled{background:var(--text-light);cursor:not-allowed}
    .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px 24px;align-items:start}
    .inline{display:grid;grid-template-columns:1fr auto 1fr;gap:16px;align-items:center} .inline span{color:var(--text-light)}
    .full-width-btn{width:100%;padding:14px 18px;font-size:16px;margin-top:12px}
    .muted{color:var(--text-light)} .mono{font-family:ui-monospace,Consolas,Menlo,monospace}
    .loading{opacity:.6;pointer-events:none}
    .progress-bar{width:100%;height:8px;background:var(--border-color);border-radius:4px;overflow:hidden;margin:10px 0}
    .progress-fill{height:100%;background:var(--primary-color);transition:width .3s}
    .stats{display:flex;gap:16px;margin:16px 0;flex-wrap:wrap}
    .stat-card{flex:1;min-width:180px;border:1px solid var(--border-color);border-radius:8px;padding:16px;text-align:center;background:var(--card-bg)}
    .stat-number{font-size:22px;color:#63AB8F;font-weight:700}
    .stat-label{font-size:13px;color:var(--text-light)}
    .filter-controls{display:flex;gap:12px;margin-top:8px;flex-wrap:wrap}
    .filter-controls > *{flex:1;min-width:160px}
    .future-date{color:#ccc;cursor:not-allowed}
    .attendance-table{width:100%;border-collapse:collapse;margin-top:12px}
    .attendance-table th,.attendance-table td{border-bottom:1px solid var(--border-color);padding:8px 10px;vertical-align:top}
    .attendance-table th{background:var(--primary-color);color:#fff;text-align:left}
    .late-yes{color:#dc2626;font-weight:700}
    .late-no{color:#16a34a;font-weight:700}
    .on-time{color:#16a34a;font-weight:600}
    .late{color:#dc2626;font-weight:600}
    .activity-timeline {background: #f8f9fa; border-radius: 8px; padding: 12px; margin-top: 8px;}
    .activity-item {display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #e9ecef;}
    .activity-item:last-child {border-bottom: none;}
    .activity-time {font-family: ui-monospace, Consolas, Menlo, monospace; color: #495057;}
    .activity-status {font-weight: 600; color: #2c3e50;}
    .schedule-match {background-color: #f0f9ff; border-left: 4px solid #3b82f6;}
    .schedule-mismatch {background-color: #fef2f2; border-left: 4px solid #ef4444;}
    
    /* Tab Styles */
    .tabs {display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 20px;}
    .tab {padding: 12px 24px; background: var(--light-bg); border: 1px solid var(--border-color); border-bottom: none; border-radius: 8px 8px 0 0; margin-right: 4px; cursor: pointer; transition: all 0.2s;}
    .tab:hover {background: var(--card-bg);}
    .tab.active {background: var(--primary-color); color: white; border-color: var(--primary-color);}
    .tab-content {display: none;}
    .tab-content.active {display: block;}
    
    /* Status badges */
    .status-adherent {color: #16a34a; font-weight: 600;}
    .status-nonadherent {color: #dc2626; font-weight: 600;}
    .status-unscheduled {color: #6b7280; font-weight: 600;}
    .status-exception {color: #d97706; font-weight: 600;}
  </style>
</head>
<body>
  <div id="logo-container">
    <img id="logo" src="https://raw.githubusercontent.com/gmcglynn88/ExternalWorkCreation/main/Consultinglogo.png" alt="Company Logo">
  </div>
  <h1>Attendance Insights - By IPI</h1>
  <button id="signinBtn" style="display:none;margin-bottom:12px;">Sign in to Genesys Cloud</button>

  <div id="authStatus" class="card" style="display:none;">
    <div style="text-align:center;padding:20px;">
      <div style="font-size:18px;color:var(--secondary-color);margin-bottom:8px;">üîê Authenticating‚Ä¶</div>
      <div class="muted">Connecting to Genesys Cloud</div>
    </div>
  </div>

  <div id="mainContent" style="display:none;">
    <!-- Tab Navigation -->
    <div class="tabs">
      <div class="tab active" data-tab="adherence">Schedule vs Actual</div>
      <div class="tab" data-tab="details">Detailed Breakdown</div>
    </div>

    <!-- Controls Card -->
    <div class="card">
      <h2 style="margin:0 0 12px;">Select Date Range & Management Unit</h2>
      <div class="controls">
        <div>
          <label>Date Range</label>
          <div class="inline">
            <input id="fromDate" type="date"/>
            <span>to</span>
            <input id="toDate" type="date"/>
          </div>
          <div class="muted" style="margin-top:6px;font-size:13px;">
            Historical adherence data for schedule vs actual comparison.
          </div>
        </div>
        <div>
          <label>Management Unit</label>
          <select id="managementUnitSelect">
            <option value="">Loading management units...</option>
          </select>
          
          <label style="margin-top:12px;">User Filter</label>
          <select id="userSelect">
            <option value="all">All users</option>
          </select>
          
          <input id="userSearch" type="text" placeholder="Search by user name" style="margin-top:8px;width:100%"/>
        </div>
      </div>
      <button id="fetchAdherenceBtn" class="full-width-btn">Fetch Schedule vs Actual Data</button>
    </div>

    <div id="statusMessage" class="muted" style="margin-top:10px;"></div>
    <div id="errorMessage" style="color:#dc2626;margin-top:6px;"></div>

    <div id="progressSection" style="display:none;">
      <div class="card">
        <h3 style="margin:0 0 8px;" id="progressTitle">Processing Historical Adherence</h3>
        <div class="muted" id="progressInfo">Starting adherence query job‚Ä¶</div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
        <div style="display:flex;justify-content:space-between;font-size:14px" class="muted">
          <span id="progressText">0%</span><span id="chunkText">Step 0/0</span>
        </div>
      </div>
    </div>

    <!-- Adherence Tab -->
    <div id="adherenceTab" class="tab-content active">
      <div class="card">
        <h2 style="margin:0 0 12px;">Schedule vs Actual Adherence</h2>
        <div class="stats">
          <div class="stat-card">
            <div class="stat-number" id="totalShifts">0</div>
            <div class="stat-label">Total Scheduled Shifts</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="adherentShifts">0</div>
            <div class="stat-label">Adherent Shifts</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="nonAdherentShifts">0</div>
            <div class="stat-label">Non-Adherent Shifts</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="adherenceRate">0%</div>
            <div class="stat-label">Adherence Rate</div>
          </div>
        </div>
        <div id="adherenceResults"></div>
      </div>
    </div>

    <!-- Details Tab -->
    <div id="detailsTab" class="tab-content">
      <div class="card">
        <h2 style="margin:0 0 12px;">Detailed Activity Breakdown</h2>
        <div class="stats">
          <div class="stat-card">
            <div class="stat-number" id="totalActivities">0</div>
            <div class="stat-label">Total Activities</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="scheduledTime">0h</div>
            <div class="stat-label">Scheduled Time</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="actualTime">0h</div>
            <div class="stat-label">Actual Time</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="exceptionTime">0h</div>
            <div class="stat-label">Exception Time</div>
          </div>
        </div>
        <div id="detailsResults"></div>
      </div>
    </div>
  </div>

  <script>
    // ===== Config =====
    const CONFIG = {
      clientId: 'fe305808-b368-4547-8af9-325d28d552bb',
      redirectUri: 'https://gmcglynn88.github.io/Late_Break-Report/',
      loginHost: 'https://login.mypurecloud.ie',
      apiHost: 'https://api.mypurecloud.ie'
    };

    // ===== State =====
    const state = {
      token: null,
      users: [],
      usersById: {},
      teams: [],
      teamMembersByTeamId: {},
      teamsByUserId: {},
      managementUnits: [],
      activityCodes: {},
      adherenceData: [],
      activityRows: [],
      currentJobId: null
    };

    // ===== Utils =====
    const $ = id => document.getElementById(id);
    const setStatus = (msg,err=false)=>{ 
      $('statusMessage').textContent = err?'':(msg||''); 
      $('errorMessage').textContent = err?(msg||''):''; 
    };
    const fmt = d => { if(!d) return 'N/A'; try{return new Date(d).toLocaleString()}catch{return 'N/A'} };
    const fmtTime = d => { if(!d) return 'N/A'; try{return new Date(d).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}catch{return 'N/A'} };
    const fmtDMY = s => { if(!s||s.length<10) return s||''; const [y,m,d]=s.slice(0,10).split('-'); return `${d}-${m}-${y}`; };
    function setLoading(v){ $('mainContent').classList.toggle('loading', !!v); }
    function updateProgress(p,cur,total){ $('progressFill').style.width = `${p}%`; $('progressText').textContent = `${Math.round(p)}%`; $('chunkText').textContent = `Step ${cur}/${total}`; }
    function showProgress(info, title = "Processing Data"){ 
      $('progressSection').style.display='block'; 
      $('progressTitle').textContent = title;
      $('progressInfo').textContent = info || ''; 
    }
    function hideProgress(){ $('progressSection').style.display='none'; }

    // Format minutes to hours
    function formatHours(minutes) {
      if (!minutes || minutes <= 0) return '0h';
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
    }

    // Format duration
    function formatDuration(minutes) {
      if (!minutes || minutes <= 0) return '0m';
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      if (hours > 0) {
        return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
      }
      return `${mins}m`;
    }

    // Add helper function to escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ===== Tab Management =====
    function setupTabs() {
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          tab.classList.add('active');
          const tabName = tab.getAttribute('data-tab');
          $(`${tabName}Tab`).classList.add('active');
        });
      });
    }

    // ===== Date Range Limiting =====
    function setupDateLimits() {
      const today = new Date().toISOString().split('T')[0];
      $('fromDate').max = today; $('toDate').max = today;
      $('fromDate').addEventListener('change', function() {
        if (this.value > today) this.value = today;
        if ($('toDate').value && this.value > $('toDate').value) $('toDate').value = this.value;
      });
      $('toDate').addEventListener('change', function() {
        if (this.value > today) this.value = today;
        if ($('fromDate').value && this.value < $('fromDate').value) $('fromDate').value = this.value;
      });
    }

    // ===== Auth =====
    function parseTokenFromHash(){
      const params = new URLSearchParams(location.hash.replace(/^#/, ''));
      return { token: params.get('access_token'), error: params.get('error'), errorDescription: params.get('error_description') };
    }
    function authUrl(){
      return `${CONFIG.loginHost}/oauth/authorize?client_id=${encodeURIComponent(CONFIG.clientId)}&response_type=token&redirect_uri=${encodeURIComponent(CONFIG.redirectUri)}`;
    }
    function showMain(){ $('authStatus').style.display='none'; $('mainContent').style.display='block'; }

    function initAuth(){
      const {token, error} = parseTokenFromHash();
      if(location.hash) history.replaceState(null,'',location.pathname);

      if(token){
        sessionStorage.removeItem('gc_auto_auth_attempted');
        state.token = token;
        showMain();
        setupDateLimits();
        setupTabs();
        fetchManagementUnits();
        fetchAllUsers();
        fetchAllTeamsAndMembers();
        return;
      }

      const attempted = sessionStorage.getItem('gc_auto_auth_attempted');
      if(!attempted && !error){
        sessionStorage.setItem('gc_auto_auth_attempted','1');
        $('authStatus').style.display='block';
        location.assign(authUrl());
        return;
      }

      $('signinBtn').style.display = 'inline-block';
      $('signinBtn').onclick = () => { sessionStorage.setItem('gc_auto_auth_attempted','1'); location.assign(authUrl()); };
      $('authStatus').style.display = 'none';
    }

    // ===== API helper =====
    async function api(path, options = {}){
      if(!state.token) throw new Error('Not authenticated');
      const config = {
        headers: {
          'Authorization': `Bearer ${state.token}`,
          ...options.headers
        },
        ...options
      };
      
      const res = await fetch(`${CONFIG.apiHost}${path}`, config);
      if(res.status===401||res.status===403) throw new Error(`Authentication error (${res.status}). Please refresh.`);
      if(!res.ok){ 
        const t = await res.text().catch(()=> '');
        throw new Error(`API Error: ${res.status} ${res.statusText}${t?` - ${t.slice(0,200)}`:''}`);
      }
      return res.json();
    }

    // ===== Management Units =====
    async function fetchManagementUnits(){
      try{
        const data = await api('/api/v2/workforcemanagement/managementunits');
        state.managementUnits = data.entities || [];
        const select = $('managementUnitSelect');
        select.innerHTML = '<option value="">Select Management Unit</option>' +
          state.managementUnits.map(mu => `<option value="${mu.id}">${mu.name}</option>`).join('');
      }catch(e){
        console.error('Failed to fetch management units:', e);
        $('managementUnitSelect').innerHTML = '<option value="">Failed to load management units</option>';
      }
    }

    // ===== Users =====
    async function fetchAllUsers(){
      try{
        setStatus('Loading users‚Ä¶'); setLoading(true);
        let all=[], page=1, size=100;
        while(true){
          const data = await api(`/api/v2/users?pageSize=${size}&pageNumber=${page}`);
          const ents = data?.entities||[];
          all = all.concat(ents);
          if(!data?.nextUri || ents.length<size) break;
          page++;
        }
        state.users = all.map(u=>({id:u.id,name:u.name||'',email:u.email||''})).sort((a,b)=>a.name.localeCompare(b.name));
        state.usersById = {};
        state.users.forEach(u=>{ state.usersById[u.id]=u; });
        populateUserSelect(state.users);
        setStatus(`Loaded ${state.users.length} users`);
      }catch(e){
        setStatus(`Failed to load users: ${e.message}`, true);
        $('userSelect').innerHTML='<option value="all">Failed to load users</option>';
      }finally{ setLoading(false); }
    }

    function populateUserSelect(users){
      const sel=$('userSelect');
      sel.innerHTML = '<option value="all">All users</option>' +
        users.map(u=>`<option value="${u.id}">${u.name||'(Unnamed)'}</option>`).join('');
    }

    // ===== Teams & members =====
    async function fetchAllTeamsAndMembers(){
      try{
        setLoading(true);
        setStatus('Loading teams‚Ä¶');

        let all=[], page=1, size=100;
        while(true){
          const data = await api(`/api/v2/teams?pageSize=${size}&pageNumber=${page}`);
          const ents = data?.entities||[];
          all = all.concat(ents);
          if(!data?.nextUri || ents.length<size) break;
          page++;
        }
        state.teams = all.map(t=>({id:t.id,name:t.name||'(Unnamed team)'})).sort((a,b)=>a.name.localeCompare(b.name));

        state.teamMembersByTeamId = {};
        state.teamsByUserId = {};
        
        setStatus('Users & teams loaded');
      }catch(e){
        console.error(e);
        setStatus('Failed to load teams: ' + e.message, true);
      }finally{
        setLoading(false);
      }
    }

    // ===== Activity Codes =====
    async function fetchActivityCodes(businessUnitId) {
      try {
        console.log('Fetching activity codes for business unit:', businessUnitId);
        const data = await api(`/api/v2/workforcemanagement/businessunits/${businessUnitId}/activitycodes`);
        state.activityCodes = {};
        
        (data.entities || []).forEach(activity => {
          state.activityCodes[activity.id] = {
            name: activity.name,
            category: activity.category
          };
        });
        
        console.log('Loaded activity codes:', state.activityCodes);
        return state.activityCodes;
      } catch (e) {
        console.error('Failed to fetch activity codes:', e);
        return {};
      }
    }

    // ===== HISTORICAL ADHERENCE API INTEGRATION =====
    async function startHistoricalAdherenceQuery(managementUnitId, fromDate, toDate) {
      console.log('Starting historical adherence query...');
      
      const requestBody = {
        startDate: `${fromDate}T00:00:00.000Z`,
        endDate: `${toDate}T23:59:59.999Z`,
        includeExceptions: true
      };

      console.log('Adherence request body:', requestBody);

      try {
        const response = await api(
          `/api/v2/workforcemanagement/managementunits/${managementUnitId}/historicaladherencequery`,
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
          }
        );

        console.log('Adherence query started:', response);
        return response.id; // Returns the job ID
      } catch (e) {
        console.error('Failed to start adherence query:', e);
        throw e;
      }
    }

    async function checkAdherenceJobStatus(jobId) {
      try {
        const response = await api(`/api/v2/workforcemanagement/adherence/historical/jobs/${jobId}`);
        console.log('Job status:', response);
        return response;
      } catch (e) {
        console.error('Failed to check job status:', e);
        throw e;
      }
    }

    async function downloadAdherenceResults(downloadUrl) {
      try {
        console.log('Downloading adherence results from:', downloadUrl);
        const response = await fetch(downloadUrl, {
          headers: {
            'Authorization': `Bearer ${state.token}`
          }
        });
        
        if (!response.ok) {
          throw new Error(`Download failed: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('Downloaded adherence data:', data);
        return data;
      } catch (e) {
        console.error('Failed to download adherence results:', e);
        throw e;
      }
    }

    async function waitForJobCompletion(jobId, maxWaitTime = 120000) {
      const startTime = Date.now();
      const checkInterval = 2000; // Check every 2 seconds
      
      while (Date.now() - startTime < maxWaitTime) {
        const jobStatus = await checkAdherenceJobStatus(jobId);
        
        if (jobStatus.queryState === 'Complete') {
          console.log('Job completed successfully');
          return jobStatus;
        } else if (jobStatus.queryState === 'Failed') {
          throw new Error('Historical adherence query failed');
        } else if (jobStatus.queryState === 'Error') {
          throw new Error('Historical adherence query encountered an error');
        }
        
        // Show progress
        const elapsed = Date.now() - startTime;
        const progress = Math.min((elapsed / maxWaitTime) * 100, 90);
        updateProgress(progress, 2, 3);
        
        // Wait before checking again
        await new Promise(resolve => setTimeout(resolve, checkInterval));
      }
      
      throw new Error('Job timed out waiting for completion');
    }

    // ===== Process Adherence Data =====
    function processAdherenceData(adherenceResults) {
      const adherenceRows = [];
      const activityRows = [];
      
      let totalShifts = 0;
      let adherentShifts = 0;
      let nonAdherentShifts = 0;
      let totalScheduledMinutes = 0;
      let totalActualMinutes = 0;
      let totalExceptionMinutes = 0;

      // Process each user's adherence data
      adherenceResults.forEach(userResult => {
        const userId = userResult.userId;
        const userName = state.usersById[userId]?.name || `User ${userId}`;
        
        // Process scheduled shifts
        if (userResult.scheduledActivities) {
          userResult.scheduledActivities.forEach(shift => {
            totalShifts++;
            totalScheduledMinutes += shift.scheduledActivityMinutes || 0;
            
            const isAdherent = shift.adherenceStatus === 'Adherent';
            if (isAdherent) adherentShifts++;
            else nonAdherentShifts++;
            
            const userTeams = state.teamsByUserId[userId] || [];
            const teamNames = userTeams.map(t => t.name).join(', ');
            
            adherenceRows.push({
              userId,
              userName,
              teamNames,
              date: shift.startDate ? shift.startDate.slice(0, 10) : 'Unknown',
              scheduledStart: shift.startDate,
              scheduledEnd: shift.endDate,
              scheduledActivity: state.activityCodes[shift.activityCodeId]?.name || `Activity ${shift.activityCodeId}`,
              actualStatus: shift.actualActivity ? (state.activityCodes[shift.actualActivity]?.name || `Activity ${shift.actualActivity}`) : 'No Activity',
              adherenceStatus: shift.adherenceStatus || 'Unknown',
              scheduledMinutes: shift.scheduledActivityMinutes || 0,
              actualMinutes: shift.actualActivityMinutes || 0,
              isAdherent: isAdherent
            });
          });
        }
        
        // Process actual activities
        if (userResult.actuals) {
          userResult.actuals.forEach(activity => {
            totalActualMinutes += activity.activityMinutes || 0;
            
            activityRows.push({
              userId,
              userName,
              date: activity.startDate ? activity.startDate.slice(0, 10) : 'Unknown',
              startTime: activity.startDate,
              endTime: activity.endDate,
              activityName: state.activityCodes[activity.activityCodeId]?.name || `Activity ${activity.activityCodeId}`,
              activityMinutes: activity.activityMinutes || 0,
              category: state.activityCodes[activity.activityCodeId]?.category || 'Unknown'
            });
          });
        }
        
        // Process exceptions
        if (userResult.exceptions) {
          userResult.exceptions.forEach(exception => {
            totalExceptionMinutes += exception.durationMinutes || 0;
          });
        }
      });

      const adherenceRate = totalShifts > 0 ? ((adherentShifts / totalShifts) * 100).toFixed(1) : 0;

      return {
        adherenceRows,
        activityRows,
        summary: {
          totalShifts,
          adherentShifts,
          nonAdherentShifts,
          adherenceRate,
          totalScheduledMinutes,
          totalActualMinutes,
          totalExceptionMinutes
        }
      };
    }

    // ===== Render Adherence Data =====
    function renderAdherenceResults() {
      const resultsDiv = $('adherenceResults');
      
      if (!state.adherenceData.length) {
        resultsDiv.innerHTML = '<div class="muted" style="text-align:center;padding:40px"><div style="font-size:48px;margin-bottom:12px">üì≠</div><div>No adherence data available for the selected period.</div></div>';
        return;
      }

      const filteredRows = getFilteredAdherenceRows();
      
      if (!filteredRows.length) {
        resultsDiv.innerHTML = '<div class="muted" style="text-align:center;padding:40px"><div style="font-size:48px;margin-bottom:12px">üîç</div><div>No adherence data found for the selected filters.</div></div>';
        return;
      }

      // Update summary stats
      const summary = state.adherenceDataSummary || {};
      $('totalShifts').textContent = summary.totalShifts || 0;
      $('adherentShifts').textContent = summary.adherentShifts || 0;
      $('nonAdherentShifts').textContent = summary.nonAdherentShifts || 0;
      $('adherenceRate').textContent = `${summary.adherenceRate || 0}%`;

      // Create adherence table
      let tableHtml = `
        <div style="overflow-x: auto;">
          <table class="attendance-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Team</th>
                <th>Date</th>
                <th>Scheduled Activity</th>
                <th>Schedule Start</th>
                <th>Schedule End</th>
                <th>Actual Activity</th>
                <th>Adherence Status</th>
                <th>Scheduled Time</th>
                <th>Actual Time</th>
              </tr>
            </thead>
            <tbody>
      `;

      filteredRows.forEach(row => {
        const statusClass = row.isAdherent ? 'status-adherent' : 'status-nonadherent';
        const statusText = row.isAdherent ? 'Adherent' : 'Non-Adherent';
        
        tableHtml += `
          <tr class="${row.isAdherent ? 'schedule-match' : 'schedule-mismatch'}">
            <td>${escapeHtml(row.userName)}</td>
            <td>${escapeHtml(row.teamNames || 'No Team')}</td>
            <td>${fmtDMY(row.date)}</td>
            <td>${escapeHtml(row.scheduledActivity)}</td>
            <td>${fmtTime(row.scheduledStart)}</td>
            <td>${fmtTime(row.scheduledEnd)}</td>
            <td>${escapeHtml(row.actualStatus)}</td>
            <td><span class="${statusClass}">${statusText}</span></td>
            <td>${formatDuration(row.scheduledMinutes)}</td>
            <td>${formatDuration(row.actualMinutes)}</td>
          </tr>
        `;
      });

      tableHtml += `
            </tbody>
          </table>
        </div>
      `;

      resultsDiv.innerHTML = tableHtml;
    }

    function renderDetailedResults() {
      const resultsDiv = $('detailsResults');
      
      if (!state.activityRows.length) {
        resultsDiv.innerHTML = '<div class="muted" style="text-align:center;padding:40px"><div style="font-size:48px;margin-bottom:12px">üìä</div><div>No detailed activity data available.</div></div>';
        return;
      }

      const filteredRows = getFilteredActivityRows();
      
      // Update detailed stats
      const summary = state.adherenceDataSummary || {};
      $('totalActivities').textContent = state.activityRows.length;
      $('scheduledTime').textContent = formatHours(summary.totalScheduledMinutes || 0);
      $('actualTime').textContent = formatHours(summary.totalActualMinutes || 0);
      $('exceptionTime').textContent = formatHours(summary.totalExceptionMinutes || 0);

      let tableHtml = `
        <div style="overflow-x: auto;">
          <table class="attendance-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Date</th>
                <th>Activity</th>
                <th>Start Time</th>
                <th>End Time</th>
                <th>Duration</th>
                <th>Category</th>
              </tr>
            </thead>
            <tbody>
      `;

      filteredRows.forEach(row => {
        tableHtml += `
          <tr>
            <td>${escapeHtml(row.userName)}</td>
            <td>${fmtDMY(row.date)}</td>
            <td>${escapeHtml(row.activityName)}</td>
            <td>${fmtTime(row.startTime)}</td>
            <td>${fmtTime(row.endTime)}</td>
            <td>${formatDuration(row.activityMinutes)}</td>
            <td>${escapeHtml(row.category)}</td>
          </tr>
        `;
      });

      tableHtml += `
            </tbody>
          </table>
        </div>
      `;

      resultsDiv.innerHTML = tableHtml;
    }

    function getFilteredAdherenceRows() {
      const userId = $('userSelect').value;
      const search = $('userSearch').value.trim().toLowerCase();

      return state.adherenceData.filter(r => {
        if (userId !== 'all' && r.userId !== userId) return false;
        if (search) {
          const hay = (r.userName + ' ' + (r.teamNames || '') + ' ' + r.date).toLowerCase();
          if (!hay.includes(search)) return false;
        }
        return true;
      });
    }

    function getFilteredActivityRows() {
      const userId = $('userSelect').value;
      const search = $('userSearch').value.trim().toLowerCase();

      return state.activityRows.filter(r => {
        if (userId !== 'all' && r.userId !== userId) return false;
        if (search) {
          const hay = (r.userName + ' ' + r.date + ' ' + r.activityName).toLowerCase();
          if (!hay.includes(search)) return false;
        }
        return true;
      });
    }

    // ===== Main Adherence Fetch Function =====
    async function fetchAdherenceData() {
      try {
        const from = $('fromDate').value;
        const to = $('toDate').value || from;
        const managementUnitId = $('managementUnitSelect').value;
        
        if (!from) { setStatus('Please select a start date', true); return; }
        if (!managementUnitId) { setStatus('Please select a management unit', true); return; }
        
        const today = new Date().toISOString().split('T')[0];
        if (from > today || to > today) { setStatus('Date range cannot be in the future', true); return; }
        if (new Date(to) < new Date(from)) { setStatus('End date must be on or after start date', true); return; }

        setStatus('Starting historical adherence query‚Ä¶'); 
        setLoading(true);
        
        showProgress('Starting adherence query job‚Ä¶', 'Historical Adherence');
        updateProgress(10, 1, 3);

        // Step 1: Start the adherence query job
        const jobId = await startHistoricalAdherenceQuery(managementUnitId, from, to);
        state.currentJobId = jobId;
        
        updateProgress(30, 2, 3);
        showProgress('Waiting for job to complete‚Ä¶', 'Historical Adherence');

        // Step 2: Wait for job completion
        const jobResult = await waitForJobCompletion(jobId);
        
        updateProgress(70, 3, 3);
        showProgress('Downloading results‚Ä¶', 'Historical Adherence');

        // Step 3: Download and process results from all URLs
        let allAdherenceResults = [];
        
        for (const downloadUrl of jobResult.downloadUrls) {
          try {
            const results = await downloadAdherenceResults(downloadUrl);
            if (results && Array.isArray(results)) {
              allAdherenceResults = allAdherenceResults.concat(results);
            }
          } catch (downloadError) {
            console.error('Failed to download from one URL, continuing with others:', downloadError);
          }
        }

        if (allAdherenceResults.length === 0) {
          throw new Error('No adherence data found in download URLs');
        }

        // Step 4: Get activity codes for mapping
        const managementUnit = state.managementUnits.find(mu => mu.id === managementUnitId);
        if (managementUnit && managementUnit.businessUnit) {
          await fetchActivityCodes(managementUnit.businessUnit.id);
        }

        // Step 5: Process the data
        const processedData = processAdherenceData(allAdherenceResults);
        state.adherenceData = processedData.adherenceRows;
        state.activityRows = processedData.activityRows;
        state.adherenceDataSummary = processedData.summary;
        
        updateProgress(100, 3, 3);
        hideProgress();
        
        // Render results
        renderAdherenceResults();
        renderDetailedResults();
        
        setStatus(`Adherence data loaded - ${state.adherenceData.length} shifts analyzed`);
        
      } catch (e) {
        console.error('Error in fetchAdherenceData:', e);
        hideProgress();
        setStatus('Error fetching adherence data: ' + e.message, true);
      } finally {
        setLoading(false);
      }
    }

    // ===== Events & Init =====
    $('fetchAdherenceBtn').addEventListener('click', fetchAdherenceData);
    $('userSelect').addEventListener('change', function() {
      if (document.querySelector('.tab.active').getAttribute('data-tab') === 'adherence') {
        renderAdherenceResults();
      } else {
        renderDetailedResults();
      }
    });
    $('userSearch').addEventListener('input', function() {
      if (document.querySelector('.tab.active').getAttribute('data-tab') === 'adherence') {
        renderAdherenceResults();
      } else {
        renderDetailedResults();
      }
    });

    (function init() {
      const today = new Date(); 
      const weekAgo = new Date(); 
      weekAgo.setDate(today.getDate() - 7);
      $('fromDate').value = weekAgo.toISOString().slice(0,10);
      $('toDate').value = today.toISOString().slice(0,10);
      initAuth();
    })();
  </script>
</body>
</html>
