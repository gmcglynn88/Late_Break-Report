<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WFM Helper</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D;
      --pill:#e9f6f0; --warning-bg:#fef3f2; --warning-border:#fecdca; --warning-text:#b42318;
      --success-bg:#f6fef9; --success-border:#75e0a7; --success-text:#079455;
    }
    body{
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
      margin:20px;padding:20px;max-width:1400px;background:var(--light-bg);color:var(--text-color)
    }
    #logo-container{text-align:center;margin-bottom:20px}
    #logo{width:300px}
    h1{margin:0 0 16px}
    .card{
      background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;
      padding:24px;margin-top:16px;box-shadow:0 1px 3px rgba(0,0,0,.08)
    }
    label{display:block;font-weight:600;margin-bottom:6px}
    input,select,button,textarea{
      padding:10px;border:1px solid var(--border-color);border-radius:6px;background:#fff;font-size:14px
    }
    button{
      background:var(--primary-color);color:#fff;font-weight:600;cursor:pointer;transition:background .2s
    }
    button:hover{background:var(--secondary-color)}
    button:disabled{background:var(--text-light);cursor:not-allowed}
    .controls{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;align-items:end
    }
    .full-width-btn{width:100%;padding:14px 18px;font-size:16px;margin-top:12px}
    .muted{color:var(--text-light);font-size:12px;margin-top:4px}
    .section-title{margin:0 0 10px;color:var(--secondary-color)}

    /* Tabs */
    .tabs{display:flex;border-bottom:1px solid var(--border-color);margin-bottom:16px}
    .tab{
      padding:12px 24px;cursor:pointer;border-bottom:3px solid transparent;font-weight:600;
      transition:all 0.2s;color:var(--text-light)
    }
    .tab.active{
      color:var(--primary-color);border-bottom-color:var(--primary-color);background:var(--light-bg)
    }
    .tab-content{display:none}
    .tab-content.active{display:block}

    #messageContainer{display:none;margin-top:12px}
    .error-message{
      color:#b4231a;background:#fee2e2;border:1px solid:#fecaca;padding:10px;border-radius:6px
    }
    .success-message{
      color:#14532d;background:#dcfce7;border:1px solid:#bbf7d0;padding:10px;border-radius:6px
    }
    .info-message{
      color:#6b4e16;background:#fff7ed;border:1px solid:#ffedd5;padding:10px;border-radius:6px
    }

    .schedule-table{width:100%;border-collapse:collapse;margin-top:16px}
    .schedule-table th,.schedule-table td{
      border:1px solid var(--border-color);padding:8px;font-size:13px
    }
    .schedule-table th{background:var(--light-bg);text-align:left;cursor:pointer;position:relative}
    .schedule-table th.sortable:hover{background:#e9ecef}
    .schedule-table th .sort-indicator{margin-left:4px;font-size:10px}
    .pill{
      display:inline-flex;align-items:center;padding:4px 8px;border-radius:999px;
      background:var(--pill);font-size:11px;color:var(--secondary-color)
    }
    .schedule-meta{margin-top:8px;font-size:12px;color:var(--text-light)}
    
    /* Checkbox dropdown */
    .checkbox-dropdown{position:relative;min-width:220px;width:100%}
    .cd-trigger{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border-color);border-radius:6px;background:#fff;padding:10px;cursor:pointer;width:100%;box-sizing:border-box}
    .cd-trigger .label{color:var(--text-color);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
    .cd-trigger .count{background:var(--pill);border:1px solid var(--border-color);border-radius:999px;padding:2px 8px;font-size:12px;color:#2c3e50;flex-shrink:0;margin-left:8px}
    .cd-panel{position:absolute;z-index:1000;margin-top:6px;background:#fff;border:1px solid var(--border-color);border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.12);width:100%;max-height:340px;overflow:hidden;display:none;box-sizing:border-box}
    .cd-panel.open{display:block}
    .cd-header{padding:10px;border-bottom:1px solid var(--border-color);display:flex;gap:8px;align-items:center}
    .cd-search{flex:1;border:1px solid var(--border-color);border-radius:6px;padding:8px;width:100%;box-sizing:border-box}
    .cd-actions{display:flex;gap:8px}
    .cd-actions button{background:#eef6f2;color:#2c3e50;border:1px solid var(--border-color);border-radius:6px;padding:8px 10px;cursor:pointer;white-space:nowrap}
    .cd-selectall{padding:8px 12px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;gap:10px}
    .cd-list{max-height:260px;overflow:auto}
    .cd-item{display:flex;align-items:center;gap:10px;padding:8px 12px;border-bottom:1px solid #f1f3f5}
    .cd-item label{display:flex;align-items:center;gap:10px;cursor:pointer;width:100%}
    .cd-footer{padding:8px 12px;background:#fafafa;border-top:1px solid var(--border-color);font-size:12px;color:var(--text-light);display:flex;justify-content:space-between}
    
    /* Filter by activity */
    .filter-activity-container {
      margin-top: 16px;
      padding: 16px;
      background: var(--light-bg);
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }
    .filter-activity-title {
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--secondary-color);
    }
    
    /* Export buttons */
    .export-buttons {
      display: flex;
      gap: 10px;
      margin: 16px 0;
      justify-content: flex-start;
      flex-wrap: wrap;
    }
    .export-btn {
      background: var(--secondary-color);
      padding: 8px 16px;
      font-size: 14px;
    }
    
    /* Table controls */
    .table-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 16px 0;
      flex-wrap: wrap;
      gap: 10px;
    }
    .sort-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    /* Job status indicator */
    .job-status {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 6px;
      border: 1px solid var(--border-color);
    }
    .job-status.spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(0,0,0,0.1);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Manual download section */
    .manual-download {
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      border-radius: 8px;
      padding: 16px;
      margin: 16px 0;
    }
    .download-links {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 12px;
    }
    .download-link {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      text-decoration: none;
      color: var(--text-color);
    }
    .download-link:hover {
      background: var(--light-bg);
    }
  </style>
</head>
<body>
  <div id="logo-container">
    <img id="logo" src="https://raw.githubusercontent.com/gmcglynn88/ExternalWorkCreation/main/Consultinglogo.png" alt="Company Logo">
  </div>

  <h1>WFM Helper</h1>

  <div id="authCard" class="card">
    <div id="auth-message" class="info-message">Authenticating with Genesys Cloud...</div>
  </div>

  <div id="appContent" style="display:none;">
    <div id="messageContainer"></div>

    <!-- Tabs Navigation -->
    <div class="tabs">
      <div class="tab active" data-tab="schedule">Schedule View</div>
      <div class="tab" data-tab="actual">Actual Activity</div>
      <div class="tab" data-tab="overtime">Overtime Tracking</div>
      <div class="tab" data-tab="absence">Absence Analytics</div>
    </div>

    <!-- Schedule Tab -->
    <div id="schedule-tab" class="tab-content active">
      <div class="card">
        <h2 class="section-title">Filters</h2>
        <div class="controls">
          <div>
            <label for="businessUnitSelect">Business Unit</label>
            <div id="businessUnitDropdown" class="checkbox-dropdown"></div>
            <div class="muted">Required</div>
          </div>

          <div>
            <label for="managementUnitSelect">Management Unit</label>
            <div id="managementUnitDropdown" class="checkbox-dropdown"></div>
            <div class="muted">Required for schedule search</div>
          </div>

          <div>
            <label>Team</label>
            <div id="teamDropdown" class="checkbox-dropdown"></div>
            <div class="muted">Optional – narrows users by team</div>
          </div>

          <div>
            <label>User</label>
            <div id="userDropdown" class="checkbox-dropdown"></div>
            <div class="muted">Required – schedule shown for this user</div>
          </div>

          <div>
            <label for="startDate">Start date</label>
            <input type="date" id="startDate" />
            <div class="muted">e.g. 2025-11-03</div>
          </div>

          <div>
            <label for="endDate">End date</label>
            <input type="date" id="endDate" />
            <div class="muted">e.g. 2025-11-08</div>
          </div>
        </div>

        <button id="loadScheduleBtn" class="full-width-btn">Load Schedule</button>
      </div>

      <div id="results" class="card" style="display:none;">
        <div class="table-controls">
          <div class="sort-controls">
            <label for="scheduleSort">Sort by:</label>
            <select id="scheduleSort">
              <option value="date">Date</option>
              <option value="user">User</option>
              <option value="activity">Activity</option>
              <option value="duration">Duration</option>
            </select>
            <select id="scheduleSortOrder">
              <option value="asc">Ascending</option>
              <option value="desc">Descending</option>
            </select>
          </div>
        </div>
        
        <div class="filter-activity-container">
          <div class="filter-activity-title">Filter by Activity</div>
          <div id="activityFilterDropdown" class="checkbox-dropdown"></div>
        </div>
        
        <div class="export-buttons">
          <button id="exportScheduleBtn" class="export-btn">Export Schedule to CSV</button>
        </div>
        
        <div id="scheduleResultsContent"></div>
      </div>
    </div>

    <!-- Actual Activity Tab -->
    <div id="actual-tab" class="tab-content">
      <div class="card">
        <h2 class="section-title">Actual Activity (Historical Adherence)</h2>
        <div class="controls">
          <div>
            <label for="actualBuSelect">Business Unit</label>
            <div id="actualBuDropdown" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label for="actualMuSelect">Management Unit</label>
            <div id="actualMuDropdown" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label>Team</label>
            <div id="actualTeamDropdown" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label>User</label>
            <div id="actualUserDropdown" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label for="actualStartDate">Start Date</label>
            <input type="date" id="actualStartDate" />
          </div>
          <div>
            <label for="actualEndDate">End Date</label>
            <input type="date" id="actualEndDate" />
          </div>
        </div>
        <button id="loadActualActivityBtn" class="full-width-btn">Load Actual Activity</button>
      </div>

      <div id="actualResults" class="card" style="display:none;">
        <div class="table-controls">
          <div class="sort-controls">
            <label for="actualSort">Sort by:</label>
            <select id="actualSort">
              <option value="date">Date</option>
              <option value="user">User</option>
              <option value="activity">Activity</option>
              <option value="duration">Duration</option>
            </select>
            <select id="actualSortOrder">
              <option value="asc">Ascending</option>
              <option value="desc">Descending</option>
            </select>
          </div>
        </div>
        
        <div class="filter-activity-container">
          <div class="filter-activity-title">Filter by Activity</div>
          <div id="actualActivityFilterDropdown" class="checkbox-dropdown"></div>
        </div>
        
        <div class="export-buttons">
          <button id="exportActualActivityBtn" class="export-btn">Export Actual Activity to CSV</button>
        </div>
        
        <div id="actualResultsContent"></div>
      </div>
    </div>

    <!-- Overtime Tab -->
    <div id="overtime-tab" class="tab-content">
      <div class="card">
        <h2 class="section-title">Overtime Analysis</h2>
        <div class="controls">
          <div>
            <label for="overtimeBuSelect">Business Unit</label>
            <div id="overtimeBuDropdown" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label for="overtimeMuSelect">Management Unit</label>
            <div id="overtimeMuDropdown" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label>Team</label>
            <div id="overtimeTeamDropdown" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label for="overtimeStartDate">Start Date</label>
            <input type="date" id="overtimeStartDate" />
          </div>
          <div>
            <label for="overtimeEndDate">End Date</label>
            <input type="date" id="overtimeEndDate" />
          </div>
        </div>
        <button id="analyzeOvertimeBtn" class="full-width-btn">Analyze Overtime</button>
      </div>

      <div id="overtimeResults" class="card" style="display:none;">
        <div class="table-controls">
          <div class="sort-controls">
            <label for="overtimeSort">Sort by:</label>
            <select id="overtimeSort">
              <option value="user">User</option>
              <option value="totalHours">Total Hours</option>
              <option value="rate1Hours">1.0 Rate Hours</option>
              <option value="rate1_5Hours">1.5 Rate Hours</option>
              <option value="rate2Hours">2.0 Rate Hours</option>
            </select>
            <select id="overtimeSortOrder">
              <option value="desc">Descending</option>
              <option value="asc">Ascending</option>
            </select>
          </div>
        </div>
        
        <div class="filter-activity-container">
          <div class="filter-activity-title">Filter by Overtime Activity</div>
          <div id="overtimeActivityFilterDropdown" class="checkbox-dropdown"></div>
        </div>
        
        <div class="export-buttons">
          <button id="exportOvertimeSummaryBtn" class="export-btn">Export Summary to CSV</button>
          <button id="exportOvertimeDetailsBtn" class="export-btn">Export Details to CSV</button>
        </div>
        
        <div id="overtimeResultsContent"></div>
      </div>
    </div>

    <!-- Absence Tab -->
    <div id="absence-tab" class="tab-content">
      <div class="card">
        <h2 class="section-title">Absence Analytics</h2>
        <div class="controls">
          <div>
            <label for="absenceBuSelect">Business Unit</label>
            <div id="absenceBuDropdown" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label for="absenceMuSelect">Management Unit</label>
            <div id="absenceMuDropdown" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label>Team</label>
            <div id="absenceTeamDropdown" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label for="absenceStartDate">Start Date</label>
            <input type="date" id="absenceStartDate" />
          </div>
          <div>
            <label for="absenceEndDate">End Date</label>
            <input type="date" id="absenceEndDate" />
          </div>
          <div>
            <label for="absenceThreshold">Sickness Threshold (days)</label>
            <input type="number" id="absenceThreshold" value="2" min="0" step="0.5" />
            <div class="muted">Number of <b>sick</b> days to hit review</div>
          </div>
        </div>
        <button id="analyzeAbsenceBtn" class="full-width-btn">Analyze Absence</button>
      </div>

      <div id="absenceResults" class="card" style="display:none;">
        <div class="table-controls">
          <div class="sort-controls">
            <label for="absenceSort">Sort by:</label>
            <select id="absenceSort">
              <option value="user">User</option>
              <option value="totalHours">Total Hours</option>
              <option value="absenceDays">Absence Days</option>
              <option value="instances">Instances</option>
            </select>
            <select id="absenceSortOrder">
              <option value="desc">Descending</option>
              <option value="asc">Ascending</option>
            </select>
          </div>
        </div>
        
        <div class="filter-activity-container">
          <div class="filter-activity-title">Filter by Absence Type</div>
          <div id="absenceActivityFilterDropdown" class="checkbox-dropdown"></div>
        </div>
        
        <div class="export-buttons">
          <button id="exportAbsenceBtn" class="export-btn">Export Summary to CSV</button>
          <button id="exportAbsenceDetailsBtn" class="export-btn">Export Details to CSV</button>
        </div>
        
        <div id="absenceResultsContent"></div>
      </div>
    </div>
  </div>

  <script>
    // ===== OAuth Config =====
    const clientId = 'fe305808-b368-4547-8af9-325d28d552bb';
    const redirectUri = 'https://gmcglynn88.github.io/Late_Break-Report/';
    const oauthUrl = 'https://login.mypurecloud.ie/oauth/authorize?client_id=' + encodeURIComponent(clientId) + '&response_type=token&redirect_uri=' + encodeURIComponent(redirectUri);
    const apiBase = 'https://api.mypurecloud.ie';

    let accessToken = null;
    let allUsers = [];
    let usersById = {};
    let allTeams = [];
    let activityCodesByBuId = {};
    let businessUnits = [];
    let managementUnits = [];
    
    // Data storage
    let currentScheduleData = [];
    let currentActualActivityData = [];
    let currentOvertimeData = [];
    let currentAbsenceData = [];
    let currentDisplayedData = {
      schedule: [],
      actual: [],
      overtime: [],
      absence: []
    };
    
    // Checkbox dropdown instances
    const dropdowns = {};

    // ===== Date Formatting Functions =====
    function formatDate(dateString) {
      if (!dateString) return '';
      
      // If already dd-mm-yyyy, just return
      if (typeof dateString === 'string' && dateString.match(/^\d{2}-\d{2}-\d{4}$/)) {
        return dateString;
      }
      
      // If api yyyy-mm-dd -> convert to dd-mm-yyyy
      if (typeof dateString === 'string' && dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
        const parts = dateString.split('-');
        return `${parts[2]}-${parts[1]}-${parts[0]}`;
      }
      
      if (dateString instanceof Date) {
        const day = String(dateString.getDate()).padStart(2, '0');
        const month = String(dateString.getMonth() + 1).padStart(2, '0');
        const year = dateString.getFullYear();
        return `${day}-${month}-${year}`;
      }
      
      return dateString;
    }

    function convertToApiFormat(dateStr) {
      if (!dateStr) return '';
      if (dateStr.match(/^\d{2}-\d{2}-\d{4}$/)) {
        const parts = dateStr.split('-');
        return `${parts[2]}-${parts[1]}-${parts[0]}`;
      }
      // assume already yyyy-mm-dd
      return dateStr;
    }

    // ===== Initialize with current week dates =====
    function getCurrentWeekDates() {
      const today = new Date();
      const startOfWeek = new Date(today);
      // Monday as first day of week
      startOfWeek.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1));
      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(startOfWeek.getDate() + 6);
      
      // IMPORTANT: return ISO (yyyy-mm-dd) for <input type="date">
      return {
        start: startOfWeek.toISOString().split('T')[0],
        end: endOfWeek.toISOString().split('T')[0]
      };
    }

    // ===== Tab Management =====
    function initializeTabs() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          tab.classList.add('active');
          const tabId = tab.getAttribute('data-tab');
          document.getElementById(`${tabId}-tab`).classList.add('active');
        });
      });
    }

    // ===== Auth bootstrap =====
    document.addEventListener('DOMContentLoaded', () => {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      const qparams = new URLSearchParams(window.location.search);

      const oauthError = params.get('error') || qparams.get('error');
      const oauthErrorDesc = params.get('error_description') || qparams.get('error_description');

      if (oauthError) {
        const msg = document.getElementById('auth-message');
        msg.textContent = `OAuth error: ${oauthErrorDesc || oauthError}`;
        msg.className = 'error-message';
        console.error('OAuth error details:', { error: oauthError, description: oauthErrorDesc });
        return;
      }

      accessToken = params.get('access_token');

      if (accessToken) {
        sessionStorage.setItem('purecloud_token', accessToken);
        window.location.hash = '';
        initializeApplication();
      } else if (sessionStorage.getItem('purecloud_token')) {
        accessToken = sessionStorage.getItem('purecloud_token');
        initializeApplication();
      } else {
        window.location.href = oauthUrl;
      }
    });

    function showMessage(msg, type = 'error') {
      const box = document.getElementById('messageContainer');
      box.innerHTML = `<div class="${type}-message">${msg}</div>`;
      box.style.display = 'block';
      if (type === 'success' || type === 'info') {
        setTimeout(() => { box.style.display = 'none'; }, 6000);
      }
    }

    function initializeApplication() {
      console.log('Initializing application...');
      document.getElementById('auth-message').textContent = 'Authenticated successfully!';
      document.getElementById('authCard').style.display = 'none';
      document.getElementById('appContent').style.display = 'block';

      initializeTabs();
      initializeDropdowns();
      initializeEventListeners();
      
      // Load initial data
      populateInitialData();
    }

    function authorizedFetch(url, options = {}) {
      const headers = {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json',
        ...(options.headers || {})
      };
      return fetch(url, { ...options, headers });
    }

    async function authorizedFetchJson(url, options = {}) {
      const response = await authorizedFetch(url, options);
      if (!response.ok) {
        console.error('API error', url, response.status, response.statusText);
        throw new Error(`Error calling ${url}: ${response.status} ${response.statusText}`);
      }
      return response.json();
    }

    async function fetchAllPages(baseUrl) {
      let allItems = [];
      let pageNumber = 1;
      let hasMorePages = true;

      while (hasMorePages) {
        const url = `${baseUrl}?pageNumber=${pageNumber}&pageSize=100`;
        const response = await authorizedFetch(url);
        if (!response.ok) {
          console.error('Error fetching paged data', url, response.status, response.statusText);
          throw new Error(`Error fetching data: ${response.status} ${response.statusText}`);
        }
        const data = await response.json();
        const entities = Array.isArray(data.entities) ? data.entities : [];
        allItems = allItems.concat(entities);
        if (data.pageCount && data.pageCount > pageNumber) {
          pageNumber++;
        } else {
          hasMorePages = false;
        }
      }
      return allItems;
    }

    // ===== Checkbox Dropdown Implementation =====
    function createCheckboxDropdown(containerId, { placeholder, searchPlaceholder, onSelectionChange } = {}){
      const root = document.getElementById(containerId);
      if (!root) {
        console.error(`Container ${containerId} not found`);
        return null;
      }
      
      root.innerHTML = '';

      const trigger = document.createElement('div');
      trigger.className = 'cd-trigger';
      trigger.innerHTML = `<span class="label">${placeholder}</span><span class="count">0 selected</span>`;
      root.appendChild(trigger);

      const panel = document.createElement('div');
      panel.className = 'cd-panel';
      panel.innerHTML = `
        <div class="cd-header">
          <input type="text" class="cd-search" placeholder="${searchPlaceholder}" />
          <div class="cd-actions">
            <button type="button" data-cd="clear">Clear</button>
          </div>
        </div>
        <div class="cd-selectall">
          <label><input type="checkbox" data-cd="selectall"/> Select all</label>
        </div>
        <div class="cd-list"></div>
        <div class="cd-footer">
          <span data-cd="summary">0 selected</span>
          <span>Click outside to close</span>
        </div>
      `;
      root.appendChild(panel);

      const list = panel.querySelector('.cd-list');
      const search = panel.querySelector('.cd-search');
      const clearBtn = panel.querySelector('[data-cd="clear"]');
      const selectAll = panel.querySelector('[data-cd="selectall"]');
      const summary = panel.querySelector('[data-cd="summary"]');

      let options = [];
      let selected = new Set();

      function render(filter=''){
        const ft = (filter || '').trim().toLowerCase();
        list.innerHTML = '';
        const filtered = !ft ? options : options.filter(o => (o.label||'').toLowerCase().includes(ft));
        if (!filtered.length){ 
          list.innerHTML = `<div class="cd-item" style="color:#6C757D">No matches</div>`; 
          return; 
        }
        filtered.forEach(o=>{
          const id = `${containerId}__${o.value}`;
          const row = document.createElement('div');
          row.className = 'cd-item';
          row.innerHTML = `
            <label for="${id}">
              <input type="checkbox" id="${id}" value="${o.value}" ${selected.has(o.value)?'checked':''}/>
              <span>${o.label || o.value}</span>
            </label>
          `;
          const cb = row.querySelector('input');
          cb.addEventListener('change', ()=>{
            if (cb.checked) selected.add(o.value); else selected.delete(o.value);
            updateSummary(); 
            updateSelectAllState();
            if (onSelectionChange) {
              onSelectionChange(Array.from(selected));
            }
          });
          list.appendChild(row);
        });
      }
      
      function updateSummary(){
        trigger.querySelector('.count').textContent = `${selected.size} selected`;
        summary.textContent = `${selected.size} selected`;
      }
      
      function updateSelectAllState(){
        const total = options.length, count = selected.size;
        selectAll.indeterminate = count>0 && count<total;
        selectAll.checked = total>0 && count===total;
      }

      trigger.addEventListener('click', ()=>{ 
        panel.classList.toggle('open'); 
        if (panel.classList.contains('open')) {
          search.focus(); 
        }
      });
      
      document.addEventListener('click', (e)=>{ 
        if (!root.contains(e.target)) panel.classList.remove('open'); 
      });
      
      search.addEventListener('input', ()=> render(search.value));
      
      clearBtn.addEventListener('click', ()=>{ 
        selected.clear(); 
        render(search.value); 
        updateSummary(); 
        updateSelectAllState();
        if (onSelectionChange) {
          onSelectionChange([]);
        }
      });
      
      selectAll.addEventListener('change', ()=>{
        if (selectAll.checked) {
          options.forEach(o=> selected.add(o.value));
        } else {
          selected.clear();
        }
        render(search.value); 
        updateSummary();
        if (onSelectionChange) {
          onSelectionChange(Array.from(selected));
        }
      });

      function setOptions(newOptions){
        options = Array.isArray(newOptions) ? newOptions : [];
        // remove any selections that no longer exist
        selected.forEach(v=>{ if (!options.some(o=>o.value===v)) selected.delete(v); });
        render(search.value); 
        updateSummary(); 
        updateSelectAllState();
      }
      
      function getSelectedValues(){ return Array.from(selected); }
      
      function clearSelection() { 
        selected.clear(); 
        render(search.value); 
        updateSummary(); 
        updateSelectAllState();
      }

      // initial empty render
      render('');
      return { setOptions, getSelectedValues, clearSelection };
    }

    function initializeDropdowns() {
      console.log('Initializing dropdowns...');
      
      // Schedule tab dropdowns
      dropdowns.businessUnit = createCheckboxDropdown('businessUnitDropdown', { 
        placeholder: 'Select business units', 
        searchPlaceholder: 'Search business units...',
        onSelectionChange: handleBusinessUnitChange
      });
      
      dropdowns.managementUnit = createCheckboxDropdown('managementUnitDropdown', { 
        placeholder: 'Select management units', 
        searchPlaceholder: 'Search management units...',
        onSelectionChange: handleManagementUnitChange
      });
      
      dropdowns.team = createCheckboxDropdown('teamDropdown', { 
        placeholder: 'Select teams', 
        searchPlaceholder: 'Search teams...' 
      });
      
      dropdowns.user = createCheckboxDropdown('userDropdown', { 
        placeholder: 'Select users', 
        searchPlaceholder: 'Search users...' 
      });
      
      // Actual Activity tab dropdowns
      dropdowns.actualBu = createCheckboxDropdown('actualBuDropdown', { 
        placeholder: 'Select business units', 
        searchPlaceholder: 'Search business units...',
        onSelectionChange: (selected) => handleAnalyticsBuChange(selected, 'actual')
      });
      
      dropdowns.actualMu = createCheckboxDropdown('actualMuDropdown', { 
        placeholder: 'Select management units', 
        searchPlaceholder: 'Search management units...',
        onSelectionChange: (selected) => handleActualManagementUnitChange(selected)
      });
      
      dropdowns.actualTeam = createCheckboxDropdown('actualTeamDropdown', { 
        placeholder: 'Select teams', 
        searchPlaceholder: 'Search teams...' 
      });
      
      dropdowns.actualUser = createCheckboxDropdown('actualUserDropdown', { 
        placeholder: 'Select users', 
        searchPlaceholder: 'Search users...' 
      });
      
      // Overtime tab dropdowns
      dropdowns.overtimeBu = createCheckboxDropdown('overtimeBuDropdown', { 
        placeholder: 'Select business units', 
        searchPlaceholder: 'Search business units...',
        onSelectionChange: (selected) => handleAnalyticsBuChange(selected, 'overtime')
      });
      
      dropdowns.overtimeMu = createCheckboxDropdown('overtimeMuDropdown', { 
        placeholder: 'Select management units', 
        searchPlaceholder: 'Search management units...' 
      });
      
      dropdowns.overtimeTeam = createCheckboxDropdown('overtimeTeamDropdown', { 
        placeholder: 'Select teams', 
        searchPlaceholder: 'Search teams...' 
      });
      
      // Absence tab dropdowns
      dropdowns.absenceBu = createCheckboxDropdown('absenceBuDropdown', { 
        placeholder: 'Select business units', 
        searchPlaceholder: 'Search business units...',
        onSelectionChange: (selected) => handleAnalyticsBuChange(selected, 'absence')
      });
      
      dropdowns.absenceMu = createCheckboxDropdown('absenceMuDropdown', { 
        placeholder: 'Select management units', 
        searchPlaceholder: 'Search management units...' 
      });
      
      dropdowns.absenceTeam = createCheckboxDropdown('absenceTeamDropdown', { 
        placeholder: 'Select teams', 
        searchPlaceholder: 'Search teams...' 
      });
      
      // Activity filter dropdowns
      dropdowns.activityFilter = createCheckboxDropdown('activityFilterDropdown', { 
        placeholder: 'Filter by activity type', 
        searchPlaceholder: 'Search activities...' 
      });
      
      dropdowns.actualActivityFilter = createCheckboxDropdown('actualActivityFilterDropdown', { 
        placeholder: 'Filter by activity type', 
        searchPlaceholder: 'Search activities...' 
      });
      
      dropdowns.overtimeActivityFilter = createCheckboxDropdown('overtimeActivityFilterDropdown', { 
        placeholder: 'Filter by overtime activity', 
        searchPlaceholder: 'Search overtime activities...' 
      });
      
      dropdowns.absenceActivityFilter = createCheckboxDropdown('absenceActivityFilterDropdown', { 
        placeholder: 'Filter by absence type', 
        searchPlaceholder: 'Search absence types...' 
      });
      
      console.log('Dropdown instances created:', Object.keys(dropdowns));
    }

    function initializeEventListeners() {
      // Schedule tab
      document.getElementById('loadScheduleBtn').addEventListener('click', loadSchedule);
      document.getElementById('exportScheduleBtn').addEventListener('click', exportScheduleToCSV);
      
      // Actual Activity tab
      document.getElementById('loadActualActivityBtn').addEventListener('click', function() {
        loadActualActivity().catch(err => {
          console.error('Historical adherence failed:', err);
          showMessage(`Failed to load actual activity: ${err.message}`, 'error');
        });
      });
      document.getElementById('exportActualActivityBtn').addEventListener('click', exportActualActivityToCSV);
      
      // Overtime tab
      document.getElementById('analyzeOvertimeBtn').addEventListener('click', analyzeOvertime);
      document.getElementById('exportOvertimeSummaryBtn').addEventListener('click', exportOvertimeSummaryToCSV);
      document.getElementById('exportOvertimeDetailsBtn').addEventListener('click', exportOvertimeDetailsToCSV);
      
      // Absence tab
      document.getElementById('analyzeAbsenceBtn').addEventListener('click', analyzeAbsence);
      document.getElementById('exportAbsenceBtn').addEventListener('click', exportAbsenceToCSV);
      document.getElementById('exportAbsenceDetailsBtn').addEventListener('click', exportAbsenceDetailsToCSV);
      
      // Initialize sorting
      initializeSorting();
    }

    function initializeSorting() {
      // Schedule tab sorting
      document.getElementById('scheduleSort').addEventListener('change', () => applySorting('schedule'));
      document.getElementById('scheduleSortOrder').addEventListener('change', () => applySorting('schedule'));
      
      // Actual Activity tab sorting
      document.getElementById('actualSort').addEventListener('change', () => applySorting('actual'));
      document.getElementById('actualSortOrder').addEventListener('change', () => applySorting('actual'));
    }

    function applySorting(tabType) {
      // Sorting implementation would go here
      console.log(`Sorting ${tabType} data`);
    }

    async function populateInitialData() {
      try {
        console.log('Loading initial data...');
        
        // Set default dates first (ISO yyyy-mm-dd for inputs)
        const currentWeek = getCurrentWeekDates();
        document.getElementById('startDate').value = currentWeek.start;
        document.getElementById('endDate').value = currentWeek.end;
        document.getElementById('actualStartDate').value = currentWeek.start;
        document.getElementById('actualEndDate').value = currentWeek.end;
        document.getElementById('overtimeStartDate').value = currentWeek.start;
        document.getElementById('overtimeEndDate').value = currentWeek.end;
        document.getElementById('absenceStartDate').value = currentWeek.start;
        document.getElementById('absenceEndDate').value = currentWeek.end;

        // Load business units, users, and teams
        const [users, businessUnitsResponse, teams] = await Promise.all([
          fetchAllPages(`${apiBase}/api/v2/users`),
          authorizedFetchJson(`${apiBase}/api/v2/workforcemanagement/businessunits`),
          fetchAllPages(`${apiBase}/api/v2/teams`)
        ]);

        allUsers = (users || []).filter(u => !u.deleted);
        usersById = {};
        allUsers.forEach(u => { usersById[u.id] = u; });
        
        // Be defensive about business units shape
        let buArray = [];
        if (Array.isArray(businessUnitsResponse.entities)) {
          buArray = businessUnitsResponse.entities;
        } else if (Array.isArray(businessUnitsResponse.businessUnits)) {
          buArray = businessUnitsResponse.businessUnits;
        } else if (Array.isArray(businessUnitsResponse.results)) {
          buArray = businessUnitsResponse.results;
        } else if (Array.isArray(businessUnitsResponse)) {
          buArray = businessUnitsResponse;
        }
        businessUnits = buArray;

        allTeams = teams || [];

        console.log(`Users loaded: ${allUsers.length}, BUs: ${businessUnits.length}, Teams: ${allTeams.length}`);

        if (!businessUnits.length) {
          console.warn('No business units returned from API – BU dropdown will be empty');
        }

        // Populate dropdowns
        populateUserDropdown(allUsers);
        populateBusinessUnitDropdown(businessUnits);
        populateTeamDropdown(allTeams);
        
        showMessage('Initial data loaded – set your filters and hit "Load Schedule".', 'info');
      } catch (err) {
        console.error('Error initialising app:', err);
        showMessage(`Error loading initial data: ${err.message}`, 'error');
      }
    }

    function populateUserDropdown(users) {
      const validUsers = (users || [])
        .filter(u => u && u.name && u.name.trim() && u.name !== 'Unknown User')
        .map(u => ({ value: u.id, label: u.name || u.email || 'Unknown User' }))
        .sort((a,b)=>a.label.localeCompare(b.label));
      
      if (dropdowns.user && dropdowns.user.setOptions) {
        dropdowns.user.setOptions(validUsers);
      }
      if (dropdowns.actualUser && dropdowns.actualUser.setOptions) {
        dropdowns.actualUser.setOptions(validUsers);
      }
    }

    function populateBusinessUnitDropdown(businessUnits) {
      const buOpts = (businessUnits || [])
        .filter(bu => bu && bu.id)
        .map(bu => ({ value: bu.id, label: bu.name || bu.id }))
        .sort((a,b)=>a.label.localeCompare(b.label));
      
      if (dropdowns.businessUnit) dropdowns.businessUnit.setOptions(buOpts);
      if (dropdowns.actualBu) dropdowns.actualBu.setOptions(buOpts);
      if (dropdowns.overtimeBu) dropdowns.overtimeBu.setOptions(buOpts);
      if (dropdowns.absenceBu) dropdowns.absenceBu.setOptions(buOpts);
    }

    function populateTeamDropdown(teams) {
      const teamOpts = (teams||[])
        .filter(t => t && t.id)
        .map(t => ({ value: t.id, label: t.name || t.id }))
        .sort((a,b)=>a.label.localeCompare(b.label));
      
      if (dropdowns.team) dropdowns.team.setOptions(teamOpts);
      if (dropdowns.actualTeam) dropdowns.actualTeam.setOptions(teamOpts);
      if (dropdowns.overtimeTeam) dropdowns.overtimeTeam.setOptions(teamOpts);
      if (dropdowns.absenceTeam) dropdowns.absenceTeam.setOptions(teamOpts);
    }

    // ===== Business Unit Change Handlers =====
    async function handleBusinessUnitChange(selectedBuIds) {
      console.log('Business Unit selection changed:', selectedBuIds);
      
      if (dropdowns.managementUnit) {
        dropdowns.managementUnit.clearSelection();
        dropdowns.managementUnit.setOptions([]);
      }

      if (!selectedBuIds || selectedBuIds.length === 0) return;

      try {
        await loadActivityCodes(selectedBuIds[0]);
        
        const muResponse = await authorizedFetchJson(
          `${apiBase}/api/v2/workforcemanagement/managementunits?businessUnitId=${encodeURIComponent(selectedBuIds[0])}`
        );
        const list = Array.isArray(muResponse.entities) ? muResponse.entities
                    : Array.isArray(muResponse.managementUnits) ? muResponse.managementUnits
                    : Array.isArray(muResponse.results) ? muResponse.results
                    : [];
        const muOpts = list
          .filter(mu => mu && mu.id)
          .map(mu => ({ value: mu.id, label: mu.name || mu.id }));
        
        console.log(`Loaded ${muOpts.length} management units for business unit ${selectedBuIds[0]}`);
        
        if (dropdowns.managementUnit) {
          dropdowns.managementUnit.setOptions(muOpts);
        }
      } catch (err) {
        console.error('Error loading management units:', err);
        showMessage(`Error loading management units: ${err.message}`, 'error');
      }
    }

    async function handleManagementUnitChange(selectedMuIds) {
      console.log('Management Unit selection changed:', selectedMuIds);
      
      if (!selectedMuIds || selectedMuIds.length === 0) {
        populateUserDropdown(allUsers);
        return;
      }

      try {
        const muUsersResponse = await authorizedFetchJson(
          `${apiBase}/api/v2/workforcemanagement/managementunits/${encodeURIComponent(selectedMuIds[0])}/users`
        );
        const list = Array.isArray(muUsersResponse.entities) ? muUsersResponse.entities
                    : Array.isArray(muUsersResponse.users) ? muUsersResponse.users
                    : [];
        const enriched = list.map(uRef => usersById[uRef.id] || uRef);
        console.log(`Loaded ${enriched.length} users for management unit ${selectedMuIds[0]}`);
        populateUserDropdown(enriched);
      } catch (err) {
        console.error('Error loading MU users:', err);
        showMessage(`Error loading management unit users: ${err.message}`, 'error');
      }
    }

    async function handleAnalyticsBuChange(selectedBuIds, tabType) {
      console.log(`Analytics Business Unit selection changed for ${tabType}:`, selectedBuIds);
      
      let muDropdown;
      switch(tabType) {
        case 'actual':
          muDropdown = dropdowns.actualMu;
          break;
        case 'overtime':
          muDropdown = dropdowns.overtimeMu;
          break;
        case 'absence':
          muDropdown = dropdowns.absenceMu;
          break;
      }
      
      if (muDropdown) {
        muDropdown.clearSelection();
        muDropdown.setOptions([]);
      }

      if (!selectedBuIds || selectedBuIds.length === 0) return;

      try {
        await loadActivityCodes(selectedBuIds[0]);
        
        const muResponse = await authorizedFetchJson(
          `${apiBase}/api/v2/workforcemanagement/managementunits?businessUnitId=${encodeURIComponent(selectedBuIds[0])}`
        );
        const list = Array.isArray(muResponse.entities) ? muResponse.entities
                    : Array.isArray(muResponse.managementUnits) ? muResponse.managementUnits
                    : Array.isArray(muResponse.results) ? muResponse.results
                    : [];
        const muOpts = list
          .filter(mu => mu && mu.id)
          .map(mu => ({ value: mu.id, label: mu.name || mu.id }));
        
        console.log(`Loaded ${muOpts.length} management units for analytics ${tabType} tab`);
        
        if (muDropdown) {
          muDropdown.setOptions(muOpts);
        }
      } catch (err) {
        console.error('Error loading management units for analytics:', err);
        showMessage(`Error loading management units: ${err.message}`, 'error');
      }
    }

    async function handleActualManagementUnitChange(selectedMuIds) {
      console.log('Actual Activity Management Unit selection changed:', selectedMuIds);
      
      if (!selectedMuIds || selectedMuIds.length === 0) {
        if (dropdowns.actualUser) {
          dropdowns.actualUser.setOptions([]);
        }
        return;
      }

      try {
        const muUsersResponse = await authorizedFetchJson(
          `${apiBase}/api/v2/workforcemanagement/managementunits/${encodeURIComponent(selectedMuIds[0])}/users`
        );
        const list = Array.isArray(muUsersResponse.entities) ? muUsersResponse.entities
                    : Array.isArray(muUsersResponse.users) ? muUsersResponse.users
                    : [];
        const enriched = list.map(uRef => usersById[uRef.id] || uRef);
        console.log(`Loaded ${enriched.length} users for actual activity management unit ${selectedMuIds[0]}`);
        
        const validUsers = enriched
          .filter(u => u && u.name && u.name.trim() && u.name !== 'Unknown User')
          .map(u => ({ value: u.id, label: u.name || u.email || 'Unknown User' }))
          .sort((a,b)=>a.label.localeCompare(b.label));
        
        if (dropdowns.actualUser) {
          dropdowns.actualUser.setOptions(validUsers);
        }
      } catch (err) {
        console.error('Error loading actual activity MU users:', err);
        showMessage(`Error loading management unit users: ${err.message}`, 'error');
      }
    }

    // ===== Activity Codes =====
    async function loadActivityCodes(businessUnitId) {
      try {
        console.log(`Loading activity codes for business unit: ${businessUnitId}`);
        const activityCodesResponse = await authorizedFetchJson(
          `${apiBase}/api/v2/workforcemanagement/businessunits/${encodeURIComponent(businessUnitId)}/activitycodes`
        );
        
        let activityCodes = [];
        
        if (activityCodesResponse.activityCodes && typeof activityCodesResponse.activityCodes === 'object') {
          activityCodes = Object.values(activityCodesResponse.activityCodes);
        } else if (Array.isArray(activityCodesResponse.entities)) {
          activityCodes = activityCodesResponse.entities;
        } else if (Array.isArray(activityCodesResponse)) {
          activityCodes = activityCodesResponse;
        } else {
          for (const key in activityCodesResponse) {
            if (Array.isArray(activityCodesResponse[key])) {
              activityCodes = activityCodesResponse[key];
              break;
            }
          }
        }
        
        const activityCodeMap = {};
        activityCodes.forEach(code => {
          if (code && code.id) {
            activityCodeMap[code.id] = {
              name: code.name ? code.name.trim() : code.id,
              category: code.category || 'Unknown'
            };
          }
        });
        
        activityCodesByBuId[businessUnitId] = activityCodeMap;
        return activityCodeMap;
      } catch (err) {
        console.error('Error loading activity codes:', err);
        activityCodesByBuId[businessUnitId] = {};
        return {};
      }
    }

    function getActivityName(businessUnitId, activityCodeId) {
      if (!businessUnitId || !activityCodeId) return 'Unknown Activity';
      
      const systemCodes = {
        '0': 'On Queue',
        '1': 'Break', 
        '2': 'Meal',
        '3': 'Meeting',
        '4': 'Off Queue',
        '5': 'Time Off',
        '6': 'Training',
        '7': 'Agent Unavailable'
      };
      
      if (systemCodes[activityCodeId]) {
        return systemCodes[activityCodeId];
      }
      
      const activityCodes = activityCodesByBuId[businessUnitId];
      if (activityCodes && activityCodes[activityCodeId]) {
        return activityCodes[activityCodeId].name;
      }
      
      return activityCodeId;
    }

    // ===== Actual Activity Functions =====
    async function loadActualActivity() {
      const buIds = dropdowns.actualBu ? dropdowns.actualBu.getSelectedValues() : [];
      const muIds = dropdowns.actualMu ? dropdowns.actualMu.getSelectedValues() : [];
      const userIds = dropdowns.actualUser ? dropdowns.actualUser.getSelectedValues() : [];
      const startDateRaw = document.getElementById('actualStartDate').value;
      const endDateRaw = document.getElementById('actualEndDate').value;

      const startDateApi = convertToApiFormat(startDateRaw);
      const endDateApi = convertToApiFormat(endDateRaw);

      if (buIds.length === 0 || muIds.length === 0 || userIds.length === 0 || !startDateApi || !endDateApi) {
        showMessage('Please select business unit, management unit, users, and date range', 'error');
        return;
      }

      const start = new Date(startDateApi);
      const end = new Date(endDateApi);
      const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
      
      if (daysDiff > 31) {
        showMessage('Historical adherence queries are limited to 31 days maximum', 'error');
        return;
      }

      const button = document.getElementById('loadActualActivityBtn');
      const originalLabel = button.textContent;
      button.disabled = true;
      button.textContent = 'Loading actual activity...';

      try {
        await loadActivityCodes(buIds[0]);
        
        const jobId = await createHistoricalAdherenceQuery(muIds[0], userIds, startDateApi, endDateApi);
        const jobResult = await pollHistoricalAdherenceJob(jobId);
        const actualActivityData = await processJobResults(jobResult, buIds[0]);
        
        currentActualActivityData = actualActivityData;
        currentDisplayedData.actual = [...actualActivityData];
        renderActualActivityResults(actualActivityData, startDateRaw, endDateRaw);
        
        showMessage('Actual activity data loaded successfully', 'success');
      } catch (err) {
        console.error('Error loading actual activity:', err);
        throw err;
      } finally {
        button.disabled = false;
        button.textContent = originalLabel;
      }
    }

    async function createHistoricalAdherenceQuery(managementUnitId, userIds, startDate, endDate) {
      const body = {
        startDate: `${startDate}T00:00:00.000Z`,
        endDate: `${endDate}T23:59:59.999Z`,
        timeZone: 'UTC',
        userIds: userIds
      };

      console.log('Creating historical adherence query with body:', body);

      const url = `${apiBase}/api/v2/workforcemanagement/managementunits/${encodeURIComponent(managementUnitId)}/historicaladherencequery`;

      try {
        const response = await authorizedFetchJson(url, {
          method: 'POST',
          body: JSON.stringify(body)
        });

        console.log('Historical adherence query response:', response);

        if (response && response.id) {
          console.log(`Historical adherence job created with ID: ${response.id}`);
          return response.id;
        } else {
          throw new Error('Failed to create historical adherence query job - no job ID returned');
        }
      } catch (err) {
        console.error('Error creating historical adherence query:', err);
        throw new Error(`Failed to create historical adherence query: ${err.message}`);
      }
    }

    async function pollHistoricalAdherenceJob(jobId) {
      const url = `${apiBase}/api/v2/workforcemanagement/adherence/historical/jobs/${encodeURIComponent(jobId)}`;
      
      console.log(`Starting to poll historical adherence job: ${jobId}`);
      
      return new Promise((resolve, reject) => {
        let attempts = 0;
        const maxAttempts = 90; // 3 minutes maximum (2 seconds * 90)
        
        const checkJobStatus = async () => {
          attempts++;
          
          try {
            console.log(`Checking job status (attempt ${attempts})...`);
            const response = await authorizedFetchJson(url);
            
            console.log('Job status response:', response);
            
            if (!response) {
              reject(new Error('Empty response from job status check'));
              return;
            }
            
            const jobState = response.queryState || response.state || response.status;
            
            console.log(`Detected job state: ${jobState}`);
            
            if (jobState === 'Complete' || jobState === 'COMPLETE' || jobState === 'Completed' || jobState === 'COMPLETED') {
              console.log('Job completed successfully');
              resolve(response);
            } else if (jobState === 'Failed' || jobState === 'FAILED' || jobState === 'Error' || jobState === 'ERROR') {
              const errorMessage = response.errorMessage || response.message || 'Historical adherence job failed';
              console.error('Job failed:', errorMessage);
              reject(new Error(errorMessage));
            } else if (jobState === 'Processing' || jobState === 'PROCESSING' || jobState === 'Running' || jobState === 'RUNNING') {
              // Still processing, check again after delay
              if (attempts >= maxAttempts) {
                reject(new Error('Job polling timeout - job took too long to complete'));
              } else {
                setTimeout(checkJobStatus, 2000);
              }
            } else {
              // Unknown state, log and continue polling
              console.log(`Job in unknown state: ${jobState}, continuing to poll...`);
              if (attempts >= maxAttempts) {
                reject(new Error(`Job polling timeout - stuck in state: ${jobState}`));
              } else {
                setTimeout(checkJobStatus, 2000);
              }
            }
          } catch (err) {
            console.error('Error checking job status:', err);
            if (attempts >= maxAttempts) {
              reject(new Error(`Job polling failed after ${maxAttempts} attempts: ${err.message}`));
            } else {
              setTimeout(checkJobStatus, 2000);
            }
          }
        };
        
        // Start polling
        checkJobStatus();
      });
    }

    async function processJobResults(jobResult, businessUnitId) {
      if (!jobResult.downloadUrls || jobResult.downloadUrls.length === 0) {
        throw new Error('No download URLs found in job result');
      }

      const allActualActivities = [];
      
      // Since direct fetch has CORS issues, provide manual download option
      // and try to use a serverless function as fallback
      for (const downloadUrl of jobResult.downloadUrls) {
        try {
          console.log('Attempting to download from:', downloadUrl);
          
          // Try using a serverless function approach
          const serverlessUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(downloadUrl)}`;
          const response = await fetch(serverlessUrl);
          
          if (!response.ok) {
            throw new Error(`Serverless download failed: ${response.status} ${response.statusText}`);
          }
          
          const data = await response.json();
          
          // Process the data
          if (data && data.data) {
            processDataChunk(data, allActualActivities, businessUnitId);
          }
        } catch (error) {
          console.error('Error with serverless approach:', error);
          
          // If serverless fails, provide manual download option
          console.log('Providing manual download option for URL:', downloadUrl);
          provideManualDownloadOption(jobResult.downloadUrls, businessUnitId);
          throw new Error('CORS issue detected. Use the manual download links provided above to get the data.');
        }
      }
      
      return allActualActivities;
    }

    function processDataChunk(data, allActualActivities, businessUnitId) {
      if (data && data.data) {
        data.data.forEach(userData => {
          if (userData.actuals && userData.actuals.length > 0) {
            const userName = usersById[userData.userId]?.name || userData.userId;
            const startDate = new Date(userData.startDate);
            
            userData.actuals.forEach(actual => {
              const startTime = new Date(startDate.getTime() + (actual.startOffsetSeconds * 1000));
              const endTime = new Date(startDate.getTime() + (actual.endOffsetSeconds * 1000));
              const durationMinutes = Math.round((endTime - startTime) / (1000 * 60));
              
              let activityName = actual.actualActivityCategory || 'Unknown Activity';
              if (actual.actualActivityCodeId) {
                const mappedName = getActivityName(businessUnitId, actual.actualActivityCodeId);
                if (mappedName && mappedName !== actual.actualActivityCodeId) {
                  activityName = mappedName;
                }
              }
              
              allActualActivities.push({
                userId: userData.userId,
                userName: userName,
                date: formatDate(startTime.toISOString().slice(0, 10)),
                startTime: startTime,
                endTime: endTime,
                durationMinutes: durationMinutes,
                activityLabel: activityName,
                activityCodeId: actual.actualActivityCodeId,
                activityCategory: actual.actualActivityCategory,
                systemPresence: actual.systemPresence
              });
            });
          }
        });
      }
    }

    function provideManualDownloadOption(downloadUrls, businessUnitId) {
      const container = document.getElementById('actualResults');
      const contentContainer = document.getElementById('actualResultsContent');
      container.style.display = 'block';
      
      let html = `
        <div class="manual-download">
          <h3 class="section-title">Manual Download Required</h3>
          <p>Due to CORS restrictions, the data needs to be downloaded manually. Please follow these steps:</p>
          <ol>
            <li>Click each download link below to open the JSON data in a new tab</li>
            <li>Copy the JSON content from each tab</li>
            <li>Paste the JSON content into the text area below</li>
            <li>Click "Process Data" to load the results</li>
          </ol>
          
          <div class="download-links">
      `;
      
      downloadUrls.forEach((url, index) => {
        html += `
          <a href="${url}" target="_blank" class="download-link">
            <span>📥</span>
            <span>Download Data Part ${index + 1}</span>
          </a>
        `;
      });
      
      html += `
          </div>
          
          <div style="margin-top: 16px;">
            <label for="jsonDataInput">Paste JSON Data Here:</label>
            <textarea id="jsonDataInput" rows="10" style="width: 100%; margin-top: 8px; font-family: monospace;" placeholder="Paste the JSON data from the download links here..."></textarea>
            <button id="processJsonDataBtn" style="margin-top: 8px;">Process Data</button>
          </div>
        </div>
      `;
      
      contentContainer.innerHTML = html;
      
      // Add event listener for processing manually pasted JSON
      document.getElementById('processJsonDataBtn').addEventListener('click', function() {
        const jsonInput = document.getElementById('jsonDataInput').value;
        if (!jsonInput) {
          showMessage('Please paste JSON data first', 'error');
          return;
        }
        
        try {
          const data = JSON.parse(jsonInput);
          const allActualActivities = [];
          processDataChunk(data, allActualActivities, businessUnitId);
          
          if (allActualActivities.length > 0) {
            currentActualActivityData = allActualActivities;
            currentDisplayedData.actual = [...allActualActivities];
            renderActualActivityResults(allActualActivities, 
              document.getElementById('actualStartDate').value, 
              document.getElementById('actualEndDate').value
            );
            showMessage('Data processed successfully!', 'success');
          } else {
            showMessage('No activity data found in the provided JSON', 'error');
          }
        } catch (err) {
          showMessage('Invalid JSON data: ' + err.message, 'error');
        }
      });
    }

    function renderActualActivityResults(data, startDateInputFormat, endDateInputFormat) {
      const container = document.getElementById('actualResults');
      const contentContainer = document.getElementById('actualResultsContent');
      container.style.display = 'block';
      
      if (!data || data.length === 0) {
        contentContainer.innerHTML = `
          <div class="info-message">
            No actual activity data found for the selected period.
          </div>
        `;
        return;
      }
      
      data.sort((a, b) => {
        if (a.date === b.date) {
          return a.startTime - b.startTime;
        }
        return a.date.localeCompare(b.date);
      });

      const niceStart = formatDate(convertToApiFormat(startDateInputFormat));
      const niceEnd = formatDate(convertToApiFormat(endDateInputFormat));
      
      let html = `
        <h3 class="section-title">Actual Activity (Historical Adherence)</h3>
        <div class="schedule-meta">
          <span class="pill">Period: ${niceStart} to ${niceEnd}</span>
          &nbsp;
          <span class="pill">Total Activities: ${data.length}</span>
          &nbsp;
          <span class="pill">Source: Historical Adherence API</span>
        </div>
        
        <table class="schedule-table">
          <thead>
            <tr>
              <th class="sortable" data-sort="userName">User</th>
              <th class="sortable" data-sort="date">Date</th>
              <th class="sortable" data-sort="activityLabel">Activity</th>
              <th>Start</th>
              <th>End</th>
              <th class="sortable" data-sort="durationMinutes">Duration</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      data.forEach(row => {
        html += `
          <tr>
            <td>${escapeHtml(row.userName)}</td>
            <td>${escapeHtml(row.date)}</td>
            <td>${escapeHtml(row.activityLabel || '')}</td>
            <td>${escapeHtml(formatTime(row.startTime))}</td>
            <td>${escapeHtml(formatTime(row.endTime))}</td>
            <td>${escapeHtml(formatDuration(row.durationMinutes))}</td>
          </tr>
        `;
      });
      
      html += `</tbody></table>`;
      
      contentContainer.innerHTML = html;
      
      const allActivities = [...new Set(data.map(a => a.activityLabel))].sort();
      if (dropdowns.actualActivityFilter && allActivities.length > 0) {
        const activityOpts = allActivities.map(a => ({ value: a, label: a }));
        dropdowns.actualActivityFilter.setOptions(activityOpts);
      }
    }

    // ===== Export Functions =====
    function exportToCSV(data, filename) {
      if (!data || data.length === 0) {
        showMessage('No data to export', 'error');
        return;
      }

      const headers = Object.keys(data[0]);
      const csvContent = [
        headers.join(','),
        ...data.map(row => 
          headers.map(header => {
            let value = row[header];
            if (value instanceof Date) {
              value = value.toISOString();
            }
            value = value == null ? '' : String(value);
            return value.includes(',') ? `"${value.replace(/"/g,'""')}"` : value;
          }).join(',')
        )
      ].join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function exportScheduleToCSV() {
      if (currentDisplayedData.schedule.length === 0) {
        showMessage('No schedule data to export', 'error');
        return;
      }

      let exportData = currentDisplayedData.schedule;
      const selectedActivities = dropdowns.activityFilter ? dropdowns.activityFilter.getSelectedValues() : [];
      if (selectedActivities.length > 0) {
        exportData = currentDisplayedData.schedule.filter(activity => 
          selectedActivities.includes(activity.activityLabel)
        );
      }

      const csvData = exportData.map(activity => ({
        Date: activity.date,
        User: activity.userName,
        Activity: activity.activityLabel,
        Start: formatTime(activity.start),
        End: formatTime(activity.end),
        Duration: formatDuration(activity.durationMinutes)
      }));

      exportToCSV(csvData, `schedule_${new Date().toISOString().split('T')[0]}.csv`);
    }

    function exportActualActivityToCSV() {
      if (currentDisplayedData.actual.length === 0) {
        showMessage('No actual activity data to export', 'error');
        return;
      }

      let exportData = currentDisplayedData.actual;
      const selectedActivities = dropdowns.actualActivityFilter ? dropdowns.actualActivityFilter.getSelectedValues() : [];
      if (selectedActivities.length > 0) {
        exportData = currentDisplayedData.actual.filter(activity => 
          selectedActivities.includes(activity.activityLabel)
        );
      }

      const csvData = exportData.map(activity => ({
        Date: activity.date,
        User: activity.userName,
        Activity: activity.activityLabel,
        Start: formatTime(activity.startTime),
        End: formatTime(activity.endTime),
        Duration: formatDuration(activity.durationMinutes)
      }));

      exportToCSV(csvData, `actual_activity_${new Date().toISOString().split('T')[0]}.csv`);
    }

    // ===== Placeholder functions for other tabs =====
    async function loadSchedule() {
      showMessage('Schedule loading functionality would be implemented here', 'info');
    }

    async function analyzeOvertime() {
      showMessage('Overtime analysis functionality would be implemented here', 'info');
    }

    async function analyzeAbsence() {
      showMessage('Absence analysis functionality would be implemented here', 'info');
    }

    function exportOvertimeSummaryToCSV() {
      showMessage('Overtime summary export would be implemented here', 'info');
    }

    function exportOvertimeDetailsToCSV() {
      showMessage('Overtime details export would be implemented here', 'info');
    }

    function exportAbsenceToCSV() {
      showMessage('Absence export would be implemented here', 'info');
    }

    function exportAbsenceDetailsToCSV() {
      showMessage('Absence details export would be implemented here', 'info');
    }

    // ===== Utility Functions =====
    function formatTime(d) {
      if (!d) return 'All Day';
      return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function formatDuration(mins) {
      if (mins == null || isNaN(mins)) return '';
      const total = Math.max(0, Math.round(mins));
      const h = Math.floor(total / 60);
      const m = total % 60;
      if (h === 0) return `${m}m`;
      if (m === 0) return `${h}h`;
      return `${h}h ${m}m`;
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }
  </script>
</body>
</html>
