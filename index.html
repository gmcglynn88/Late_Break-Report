<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Attendance Insights - By IPI</title>
  <style>
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D;
      --pill:#e9f6f0;
    }
    body{font-family:"Aptos","Segoe UI",Arial,sans-serif;margin:20px;padding:20px;max-width:1400px;background:var(--light-bg);color:var(--text-color)}
    #logo-container{text-align:center;margin-bottom:20px} #logo{width:300px}
    h1{margin:0 0 16px}
    .card{background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;padding:24px;margin-top:16px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    label{display:block;font-weight:600;margin-bottom:6px}
    select,input,button{padding:10px;border:1px solid var(--border-color);border-radius:6px;background:var(--card-bg);font-size:14px}
    button{background:var(--primary-color);color:#fff;font-weight:600;cursor:pointer;transition:background .2s}
    button:hover{background:var(--secondary-color)} button:disabled{background:var(--text-light);cursor:not-allowed}
    .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px 24px;align-items:start}
    .inline{display:grid;grid-template-columns:1fr auto 1fr;gap:16px;align-items:center} .inline span{color:var(--text-light)}
    .full-width-btn{width:100%;padding:14px 18px;font-size:16px;margin-top:12px}
    .muted{color:var(--text-light)} .mono{font-family:ui-monospace,Consolas,Menlo,monospace}
    .loading{opacity:.6;pointer-events:none}
    .progress-bar{width:100%;height:8px;background:var(--border-color);border-radius:4px;overflow:hidden;margin:10px 0}
    .progress-fill{height:100%;background:var(--primary-color);transition:width .3s}
    .stats{display:flex;gap:16px;margin:16px 0;flex-wrap:wrap}
    .stat-card{flex:1;min-width:180px;border:1px solid var(--border-color);border-radius:8px;padding:16px;text-align:center;background:var(--card-bg)}
    .stat-number{font-size:22px;color:#63AB8F;font-weight:700}
    .stat-label{font-size:13px;color:var(--text-light)}
    .filter-controls{display:flex;gap:12px;margin-top:8px;flex-wrap:wrap}
    .filter-controls > *{flex:1;min-width:160px}
    .future-date{color:#ccc;cursor:not-allowed}
    .attendance-table{width:100%;border-collapse:collapse;margin-top:12px}
    .attendance-table th,.attendance-table td{border-bottom:1px solid var(--border-color);padding:8px 10px;vertical-align:top}
    .attendance-table th{background:var(--primary-color);color:#fff;text-align:left}
    .late-yes{color:#dc2626;font-weight:700}
    .late-no{color:#16a34a;font-weight:700}
    .on-time{color:#16a34a;font-weight:600}
    .late{color:#dc2626;font-weight:600}
    .activity-timeline {background: #f8f9fa; border-radius: 8px; padding: 12px; margin-top: 8px;}
    .activity-item {display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #e9ecef;}
    .activity-item:last-child {border-bottom: none;}
    .activity-time {font-family: ui-monospace, Consolas, Menlo, monospace; color: #495057;}
    .activity-status {font-weight: 600; color: #2c3e50;}
    .schedule-match {background-color: #f0f9ff; border-left: 4px solid #3b82f6;}
    .schedule-mismatch {background-color: #fef2f2; border-left: 4px solid #ef4444;}
    
    /* Tab Styles */
    .tabs {display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 20px;}
    .tab {padding: 12px 24px; background: var(--light-bg); border: 1px solid var(--border-color); border-bottom: none; border-radius: 8px 8px 0 0; margin-right: 4px; cursor: pointer; transition: all 0.2s;}
    .tab:hover {background: var(--card-bg);}
    .tab.active {background: var(--primary-color); color: white; border-color: var(--primary-color);}
    .tab-content {display: none;}
    .tab-content.active {display: block;}
    
    /* Debug Styles */
    .debug-info {background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; padding: 12px; margin-top: 12px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;}
    .debug-toggle {background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 8px;}
    
    /* API Method Selector */
    .method-selector {display: flex; gap: 12px; margin-top: 12px; flex-wrap: wrap;}
    .method-option {flex: 1; min-width: 120px;}
    .method-option input {margin-right: 6px;}
  </style>
</head>
<body>
  <div id="logo-container">
    <img id="logo" src="https://raw.githubusercontent.com/gmcglynn88/ExternalWorkCreation/main/Consultinglogo.png" alt="Company Logo">
  </div>
  <h1>Attendance Insights - By IPI</h1>
  <button id="signinBtn" style="display:none;margin-bottom:12px;">Sign in to Genesys Cloud</button>

  <div id="authStatus" class="card" style="display:none;">
    <div style="text-align:center;padding:20px;">
      <div style="font-size:18px;color:var(--secondary-color);margin-bottom:8px;">üîê Authenticating‚Ä¶</div>
      <div class="muted">Connecting to Genesys Cloud</div>
    </div>
  </div>

  <div id="mainContent" style="display:none;">
    <!-- Tab Navigation -->
    <div class="tabs">
      <div class="tab active" data-tab="schedules">Schedules Only</div>
      <div class="tab" data-tab="attendance">Schedule vs Actual</div>
    </div>

    <!-- Controls Card -->
    <div class="card">
      <h2 style="margin:0 0 12px;">Select Date Range & Filters</h2>
      <div class="controls">
        <div>
          <label>Date Range</label>
          <div class="inline">
            <input id="fromDate" type="date"/>
            <span>to</span>
            <input id="toDate" type="date"/>
          </div>
          <div class="muted" style="margin-top:6px;font-size:13px;">
            Best used on small ranges (e.g. 1‚Äì7 days).
          </div>
        </div>
        <div>
          <label>Business Unit & Management Unit</label>
          <div class="filter-controls">
            <select id="businessUnitSelect">
              <option value="">Loading business units...</option>
            </select>
            <select id="managementUnitSelect">
              <option value="">Select business unit first</option>
            </select>
          </div>
          <label style="margin-top:12px;">Team & User Filters</label>
          <div class="filter-controls">
            <select id="teamSelect">
              <option value="all">All teams</option>
            </select>
            <select id="userSelect">
              <option value="all">All users</option>
            </select>
          </div>
          <input id="userSearch" type="text" placeholder="Search by user or team name" style="margin-top:8px;width:100%"/>
        </div>
      </div>

      <!-- API Method Selector -->
      <div class="method-selector">
        <label style="width: 100%; margin-bottom: 8px;">API Method:</label>
        <div class="method-option">
          <input type="radio" id="methodDirect" name="apiMethod" value="direct" checked>
          <label for="methodDirect">Direct API</label>
        </div>
        <div class="method-option">
          <input type="radio" id="methodProxy" name="apiMethod" value="proxy">
          <label for="methodProxy">CORS Proxy</label>
        </div>
        <div class="method-option">
          <input type="radio" id="methodAnalytics" name="apiMethod" value="analytics">
          <label for="methodAnalytics">Analytics Only</label>
        </div>
      </div>

      <button id="fetchSchedulesBtn" class="full-width-btn">Fetch Schedules Only</button>
      <button id="fetchAttendanceBtn" class="full-width-btn" style="display:none; margin-top: 8px;">Run Attendance Report</button>
      
      <!-- Debug Section -->
      <div style="margin-top: 16px;">
        <button class="debug-toggle" onclick="toggleDebug()">Toggle Debug Info</button>
        <div id="debugInfo" class="debug-info" style="display: none;">
          <div><strong>Debug Information:</strong></div>
          <div id="debugContent"></div>
        </div>
      </div>
    </div>

    <div id="statusMessage" class="muted" style="margin-top:10px;"></div>
    <div id="errorMessage" style="color:#dc2626;margin-top:6px;"></div>

    <div id="progressSection" style="display:none;">
      <div class="card">
        <h3 style="margin:0 0 8px;" id="progressTitle">Fetching Data</h3>
        <div class="muted" id="progressInfo">Requesting data‚Ä¶</div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
        <div style="display:flex;justify-content:space-between;font-size:14px" class="muted">
          <span id="progressText">0%</span><span id="chunkText">Step 0/0</span>
        </div>
      </div>
    </div>

    <!-- Schedules Only Tab -->
    <div id="schedulesTab" class="tab-content active">
      <div class="card">
        <h2 style="margin:0 0 12px;">Scheduled Activities</h2>
        <div class="stats">
          <div class="stat-card">
            <div class="stat-number" id="totalScheduledShifts">0</div>
            <div class="stat-label">Total Scheduled Shifts</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="scheduledUsers">0</div>
            <div class="stat-label">Users with Schedules</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="uniqueActivities">0</div>
            <div class="stat-label">Unique Activities</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="avgShiftLength">0h</div>
            <div class="stat-label">Avg Shift Length</div>
          </div>
        </div>
        <div id="schedulesResults"></div>
      </div>
    </div>

    <!-- Attendance Tab -->
    <div id="attendanceTab" class="tab-content">
      <div class="card">
        <h2 style="margin:0 0 12px;">Schedule vs Actual Activities</h2>
        <div class="stats">
          <div class="stat-card">
            <div class="stat-number" id="totalShifts">0</div>
            <div class="stat-label">Total Shifts</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="lateShifts">0</div>
            <div class="stat-label">Late Shifts</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="uniqueUsers">0</div>
            <div class="stat-label">Unique Users</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="avgLateMinutes">0</div>
            <div class="stat-label">Avg Late Minutes</div>
          </div>
        </div>
        <div id="attendanceResults"></div>
      </div>
    </div>
  </div>

  <script>
    // ===== Config =====
    const CONFIG = {
      clientId: 'fe305808-b368-4547-8af9-325d28d552bb',
      redirectUri: 'https://gmcglynn88.github.io/Late_Break-Report/',
      loginHost: 'https://login.mypurecloud.ie',
      apiHost: 'https://api.mypurecloud.ie',
      // CORS proxy options
      corsProxies: [
        'https://cors-anywhere.herokuapp.com/',
        'https://api.allorigins.win/raw?url='
      ]
    };

    // Definition of "late"
    const ATTENDANCE_CONFIG = {
      lateThresholdMinutes: 5,      // >= 5 mins after scheduled start
    };

    // ===== State =====
    const state = {
      token: null,
      users: [],
      usersById: {},
      teams: [],
      teamMembersByTeamId: {},
      teamsByUserId: {},
      businessUnits: [],
      managementUnits: [],
      scheduleData: {},
      activityCodes: {}, // Store activity code mappings
      attendanceRows: [],
      scheduleRows: [], // Store schedule-only data
      debugLog: []
    };

    // ===== Debug Functions =====
    function addDebugLog(message, data = null) {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = {
        timestamp,
        message,
        data: data ? JSON.stringify(data, null, 2) : null
      };
      state.debugLog.push(logEntry);
      updateDebugDisplay();
    }

    function updateDebugDisplay() {
      const debugContent = $('debugContent');
      debugContent.innerHTML = state.debugLog.map(entry => 
        `<div><strong>[${entry.timestamp}]</strong> ${entry.message}</div>` +
        (entry.data ? `<pre style="margin: 4px 0; padding: 8px; background: white; border-radius: 4px; font-size: 10px;">${entry.data}</pre>` : '')
      ).join('');
    }

    function toggleDebug() {
      const debugInfo = $('debugInfo');
      debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
    }

    // ===== API Helper with CORS Proxy Support =====
    function getApiMethod() {
      return document.querySelector('input[name="apiMethod"]:checked').value;
    }

    function getApiUrl(path) {
      const method = getApiMethod();
      const fullUrl = `${CONFIG.apiHost}${path}`;
      
      if (method === 'proxy') {
        // Use CORS proxy
        const proxyUrl = CONFIG.corsProxies[0];
        return `${proxyUrl}${encodeURIComponent(fullUrl)}`;
      }
      
      return fullUrl;
    }

    async function api(path, options = {}) {
      if(!state.token) throw new Error('Not authenticated');
      
      const url = getApiUrl(path);
      const config = {
        headers: {
          'Authorization': `Bearer ${state.token}`,
          ...options.headers
        },
        ...options
      };
      
      addDebugLog(`API Request: ${path}`, { 
        method: options.method || 'GET', 
        url: url,
        apiMethod: getApiMethod()
      });
      
      try {
        const res = await fetch(url, config);
        
        addDebugLog(`API Response: ${res.status} ${res.statusText}`, {
          url: url,
          status: res.status,
          statusText: res.statusText,
          apiMethod: getApiMethod()
        });
        
        if(res.status===401||res.status===403) throw new Error(`Authentication error (${res.status}). Please refresh.`);
        if(!res.ok){ 
          const t = await res.text().catch(()=> '');
          throw new Error(`API Error: ${res.status} ${res.statusText}${t?` - ${t.slice(0,200)}`:''}`);
        }
        return res.json();
      } catch (error) {
        addDebugLog(`API Error: ${error.message}`, { path, error: error.toString(), apiMethod: getApiMethod() });
        throw error;
      }
    }

    // ===== Alternative Schedule Fetching Methods =====
    async function fetchSchedulesAlternative(businessUnitId, managementUnitId, fromDate, toDate) {
      const method = getApiMethod();
      addDebugLog(`Using alternative schedule fetching method: ${method}`);
      
      if (method === 'analytics') {
        return await fetchSchedulesFromAnalytics(businessUnitId, managementUnitId, fromDate, toDate);
      } else {
        return await fetchSchedulesDirect(businessUnitId, managementUnitId, fromDate, toDate);
      }
    }

    async function fetchSchedulesDirect(businessUnitId, managementUnitId, fromDate, toDate) {
      addDebugLog('Trying direct schedule fetch with GET requests');
      
      const scheduleData = {
        userSchedules: {},
        schedulePeriods: []
      };

      try {
        // First, fetch activity codes
        await fetchActivityCodes(businessUnitId);

        // Get users from the management unit
        const muUsersResponse = await api(`/api/v2/workforcemanagement/managementunits/${managementUnitId}/users`);
        const muUsers = muUsersResponse.entities || [];
        addDebugLog(`Found ${muUsers.length} users in management unit`);

        if (muUsers.length === 0) {
          return scheduleData;
        }

        // Try to get published schedules using GET endpoints
        showProgress('Looking for published schedules...', 'Fetching Schedules');
        
        // Get business unit weeks to find schedule IDs
        try {
          const weeksResponse = await api(`/api/v2/workforcemanagement/businessunits/${businessUnitId}/weeks`);
          const weeks = weeksResponse.entities || [];
          addDebugLog(`Found ${weeks.length} weeks in business unit`);
          
          // Look for schedules in relevant weeks
          for (const week of weeks.slice(0, 5)) { // Check recent weeks
            try {
              const schedulesResponse = await api(`/api/v2/workforcemanagement/businessunits/${businessUnitId}/weeks/${week.id}/schedules`);
              const schedules = schedulesResponse.entities || [];
              addDebugLog(`Found ${schedules.length} schedules in week ${week.id}`);
              
              for (const schedule of schedules) {
                if (schedule.user && muUsers.some(u => u.id === schedule.user.id)) {
                  const userId = schedule.user.id;
                  if (!scheduleData.userSchedules[userId]) {
                    scheduleData.userSchedules[userId] = { shifts: [] };
                  }
                  // Add schedule info (we'll need to process activities later)
                  scheduleData.userSchedules[userId].shifts.push({
                    scheduleId: schedule.id,
                    weekId: week.id,
                    user: schedule.user
                  });
                }
              }
            } catch (weekError) {
              addDebugLog(`Error fetching schedules for week ${week.id}`, { error: weekError.message });
            }
          }
        } catch (weeksError) {
          addDebugLog('Error fetching weeks', { error: weeksError.message });
        }

        return scheduleData;

      } catch (e) {
        addDebugLog('Direct schedule fetch failed', { error: e.message });
        throw e;
      }
    }

    async function fetchSchedulesFromAnalytics(businessUnitId, managementUnitId, fromDate, toDate) {
      addDebugLog('Trying to infer schedules from analytics data');
      
      const scheduleData = {
        userSchedules: {},
        schedulePeriods: []
      };

      try {
        // Use analytics data to infer schedules
        const body = {
          interval: `${fromDate}T00:00:00/${toDate}T23:59:59`,
          order: "asc",
          orderBy: "conversationStart",
          paging: { pageSize: 50, pageNumber: 1 }
        };

        addDebugLog('Fetching analytics data to infer schedules');
        const analyticsResponse = await fetch(getApiUrl('/api/v2/analytics/users/details/query'), {
          method: 'POST',
          headers: { 
            'Authorization': `Bearer ${state.token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });

        if (!analyticsResponse.ok) {
          throw new Error(`Analytics error: ${analyticsResponse.status}`);
        }

        const analyticsData = await analyticsResponse.json();
        addDebugLog(`Received analytics data with ${analyticsData.userDetails?.length || 0} user details`);

        // Process analytics data to create inferred schedules
        if (analyticsData.userDetails) {
          analyticsData.userDetails.forEach(userDetail => {
            const userId = userDetail.userId;
            if (userId && userDetail.routingStatus) {
              const activities = userDetail.routingStatus.filter(activity => 
                activity.startTime && activity.status
              );
              
              if (activities.length > 0) {
                scheduleData.userSchedules[userId] = {
                  shifts: activities.map(activity => ({
                    startDate: activity.startTime,
                    endDate: activity.endTime || new Date(new Date(activity.startTime).getTime() + 3600000).toISOString(), // Default 1 hour
                    activityName: activity.status,
                    lengthMinutes: 60, // Default duration
                    paid: true,
                    inferred: true // Mark as inferred from analytics
                  }))
                };
              }
            }
          });
        }

        addDebugLog(`Inferred ${Object.keys(scheduleData.userSchedules).length} user schedules from analytics`);
        return scheduleData;

      } catch (e) {
        addDebugLog('Analytics-based schedule inference failed', { error: e.message });
        throw e;
      }
    }

    // ===== Utils =====
    const $ = id => document.getElementById(id);
    const setStatus = (msg,err=false)=>{ 
      $('statusMessage').textContent = err?'':(msg||''); 
      $('errorMessage').textContent = err?(msg||''):''; 
      if (msg) addDebugLog(msg, err ? {error: true} : null);
    };
    const fmt = d => { if(!d) return 'N/A'; try{return new Date(d).toLocaleString()}catch{return 'N/A'} };
    const fmtTime = d => { if(!d) return 'N/A'; try{return new Date(d).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}catch{return 'N/A'} };
    const fmtDMY = s => { if(!s||s.length<10) return s||''; const [y,m,d]=s.slice(0,10).split('-'); return `${d}-${m}-${y}`; };
    function setLoading(v){ $('mainContent').classList.toggle('loading', !!v); }
    function updateProgress(p,cur,total){ $('progressFill').style.width = `${p}%`; $('progressText').textContent = `${Math.round(p)}%`; $('chunkText').textContent = `Step ${cur}/${total}`; }
    function showProgress(info, title = "Fetching Data"){ 
      $('progressSection').style.display='block'; 
      $('progressTitle').textContent = title;
      $('progressInfo').textContent = info || ''; 
    }
    function hideProgress(){ $('progressSection').style.display='none'; }

    // Format duration as HH:MM:SS
    function formatDuration(ms) {
      if (!ms || ms <= 0) return '00:00:00';
      const seconds = Math.floor(ms / 1000);
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // Format hours from minutes
    function formatHours(minutes) {
      if (!minutes || minutes <= 0) return '0h';
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
    }

    // Add helper function to escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ===== Tab Management =====
    function setupTabs() {
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          // Remove active class from all tabs and contents
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          // Add active class to clicked tab and corresponding content
          tab.classList.add('active');
          const tabName = tab.getAttribute('data-tab');
          $(`${tabName}Tab`).classList.add('active');
          
          // Show/hide appropriate buttons
          if (tabName === 'schedules') {
            $('fetchSchedulesBtn').style.display = 'block';
            $('fetchAttendanceBtn').style.display = 'none';
          } else {
            $('fetchSchedulesBtn').style.display = 'none';
            $('fetchAttendanceBtn').style.display = 'block';
          }
        });
      });
    }

    // ===== Date Range Limiting =====
    function setupDateLimits() {
      const today = new Date().toISOString().split('T')[0];
      $('fromDate').max = today; $('toDate').max = today;
      $('fromDate').addEventListener('change', function() {
        if (this.value > today) this.value = today;
        if ($('toDate').value && this.value > $('toDate').value) $('toDate').value = this.value;
      });
      $('toDate').addEventListener('change', function() {
        if (this.value > today) this.value = today;
        if ($('fromDate').value && this.value < $('fromDate').value) $('fromDate').value = this.value;
      });
    }

    // ===== Auth =====
    function parseTokenFromHash(){
      const params = new URLSearchParams(location.hash.replace(/^#/, ''));
      return { token: params.get('access_token'), error: params.get('error'), errorDescription: params.get('error_description') };
    }
    function authUrl(){
      return `${CONFIG.loginHost}/oauth/authorize?client_id=${encodeURIComponent(CONFIG.clientId)}&response_type=token&redirect_uri=${encodeURIComponent(CONFIG.redirectUri)}`;
    }
    function showMain(){ $('authStatus').style.display='none'; $('mainContent').style.display='block'; }

    function initAuth(){
      const {token, error} = parseTokenFromHash();
      if(location.hash) history.replaceState(null,'',location.pathname);

      if(token){
        sessionStorage.removeItem('gc_auto_auth_attempted');
        state.token = token;
        showMain();
        setupDateLimits();
        setupTabs();
        fetchBusinessUnits();
        fetchAllUsers();
        fetchAllTeamsAndMembers();
        addDebugLog('Authentication successful');
        return;
      }

      const attempted = sessionStorage.getItem('gc_auto_auth_attempted');
      if(!attempted && !error){
        sessionStorage.setItem('gc_auto_auth_attempted','1');
        $('authStatus').style.display='block';
        location.assign(authUrl());
        return;
      }

      $('signinBtn').style.display = 'inline-block';
      $('signinBtn').onclick = () => { sessionStorage.setItem('gc_auto_auth_attempted','1'); location.assign(authUrl()); };
      $('authStatus').style.display = 'none';
    }

    // ===== Business Units =====
    async function fetchBusinessUnits(){
      try{
        const data = await api('/api/v2/workforcemanagement/businessunits');
        state.businessUnits = data.entities || [];
        const select = $('businessUnitSelect');
        select.innerHTML = '<option value="">Select Business Unit</option>' +
          state.businessUnits.map(bu => `<option value="${bu.id}">${bu.name}</option>`).join('');
        addDebugLog(`Loaded ${state.businessUnits.length} business units`);
      }catch(e){
        console.error('Failed to fetch business units:', e);
        $('businessUnitSelect').innerHTML = '<option value="">Failed to load business units</option>';
        addDebugLog('Failed to fetch business units', { error: e.message });
      }
    }

    // ===== Management Units =====
    async function fetchManagementUnits(businessUnitId){
      try{
        const data = await api(`/api/v2/workforcemanagement/managementunits?businessUnitId=${businessUnitId}`);
        state.managementUnits = data.entities || [];
        const select = $('managementUnitSelect');
        select.innerHTML = '<option value="">Select Management Unit</option>' +
          state.managementUnits.map(mu => `<option value="${mu.id}">${mu.name}</option>`).join('');
        addDebugLog(`Loaded ${state.managementUnits.length} management units for business unit ${businessUnitId}`);
      }catch(e){
        console.error('Failed to fetch management units:', e);
        $('managementUnitSelect').innerHTML = '<option value="">Failed to load management units</option>';
        addDebugLog('Failed to fetch management units', { businessUnitId, error: e.message });
      }
    }

    // ===== Activity Codes =====
    async function fetchActivityCodes(businessUnitId) {
      try {
        addDebugLog(`Fetching activity codes for business unit: ${businessUnitId}`);
        const data = await api(`/api/v2/workforcemanagement/businessunits/${businessUnitId}/activitycodes`);
        state.activityCodes = {};
        
        (data.entities || []).forEach(activity => {
          state.activityCodes[activity.id] = {
            name: activity.name,
            category: activity.category
          };
        });
        
        addDebugLog(`Loaded ${Object.keys(state.activityCodes).length} activity codes`, state.activityCodes);
        return state.activityCodes;
      } catch (e) {
        console.error('Failed to fetch activity codes:', e);
        addDebugLog('Failed to fetch activity codes', { businessUnitId, error: e.message });
        return {};
      }
    }

    // ===== Process Schedule Data for Display =====
    function processScheduleData(scheduleData) {
      const rows = [];
      const uniqueActivities = new Set();
      let totalShiftLength = 0;
      let shiftCount = 0;

      addDebugLog('Processing schedule data for display', scheduleData);

      Object.keys(scheduleData.userSchedules).forEach(userId => {
        const userSchedule = scheduleData.userSchedules[userId];
        const userName = state.usersById[userId]?.name || `User ${userId}`;
        
        userSchedule.shifts.forEach(shift => {
          uniqueActivities.add(shift.activityName);
          totalShiftLength += shift.lengthMinutes || 60; // Default to 60 minutes if not specified
          shiftCount++;

          const userTeams = state.teamsByUserId[userId] || [];
          const teamNames = userTeams.map(t => t.name).join(', ');
          const teamIds = userTeams.map(t => t.id);

          const row = {
            userId,
            userName,
            teamNames,
            teamIds,
            date: shift.startDate ? shift.startDate.slice(0, 10) : 'Unknown',
            scheduledActivity: shift.activityName || 'Unknown Activity',
            scheduledStart: shift.startDate,
            scheduledEnd: shift.endDate,
            lengthMinutes: shift.lengthMinutes || 60,
            paid: shift.paid !== undefined ? shift.paid : true,
            inferred: shift.inferred || false
          };

          rows.push(row);
        });
      });

      addDebugLog(`Processed ${rows.length} schedule rows`, {
        uniqueActivities: uniqueActivities.size,
        totalShifts: shiftCount,
        avgShiftLength: shiftCount > 0 ? Math.round(totalShiftLength / shiftCount) : 0
      });

      return {
        rows,
        uniqueActivities: uniqueActivities.size,
        totalShifts: shiftCount,
        avgShiftLength: shiftCount > 0 ? Math.round(totalShiftLength / shiftCount) : 0
      };
    }

    // ===== Render Schedule Data =====
    function renderSchedules() {
      const resultsDiv = $('schedulesResults');
      
      addDebugLog(`Rendering schedules, total rows: ${state.scheduleRows.length}`);
      
      if (!state.scheduleRows.length) {
        resultsDiv.innerHTML = '<div class="muted" style="text-align:center;padding:40px"><div style="font-size:48px;margin-bottom:12px">üì≠</div><div>No schedule data available for the selected period.</div><div class="muted" style="margin-top:8px;">Try different API methods or date ranges.</div></div>';
        return;
      }

      const rows = getFilteredScheduleRows();
      addDebugLog(`Filtered schedule rows: ${rows.length}`);

      if (!rows.length) {
        $('totalScheduledShifts').textContent = '0';
        $('scheduledUsers').textContent = '0';
        $('uniqueActivities').textContent = '0';
        $('avgShiftLength').textContent = '0h';
        resultsDiv.innerHTML = '<div class="muted" style="text-align:center;padding:40px"><div style="font-size:48px;margin-bottom:12px">üîç</div><div>No schedule data found for the selected filters.</div></div>';
        return;
      }

      // Calculate stats
      const totalShifts = rows.length;
      const scheduledUsers = new Set(rows.map(r => r.userId)).size;
      const uniqueActivities = new Set(rows.map(r => r.scheduledActivity)).size;
      const totalMinutes = rows.reduce((sum, r) => sum + r.lengthMinutes, 0);
      const avgShiftLength = totalShifts > 0 ? Math.round(totalMinutes / totalShifts) : 0;

      $('totalScheduledShifts').textContent = totalShifts;
      $('scheduledUsers').textContent = scheduledUsers;
      $('uniqueActivities').textContent = uniqueActivities;
      $('avgShiftLength').textContent = formatHours(avgShiftLength);

      // Create table with schedule data
      let tableHtml = '';
      try {
        tableHtml = `
          <div style="overflow-x: auto;">
            <table class="attendance-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Team</th>
                  <th>Date</th>
                  <th>Scheduled Activity</th>
                  <th>Start Time</th>
                  <th>End Time</th>
                  <th>Duration</th>
                  <th>Type</th>
                </tr>
              </thead>
              <tbody>
                ${rows.map(r => {
                  try {
                    const duration = formatHours(r.lengthMinutes);
                    const type = r.inferred ? 'Inferred' : 'Scheduled';
                    const typeClass = r.inferred ? 'muted' : 'on-time';
                    
                    return `
                      <tr>
                        <td>${escapeHtml(r.userName)}</td>
                        <td>${escapeHtml(r.teamNames || 'No Team')}</td>
                        <td>${fmtDMY(r.date)}</td>
                        <td>${escapeHtml(r.scheduledActivity)}</td>
                        <td>${r.scheduledStart ? fmtTime(r.scheduledStart) : 'N/A'}</td>
                        <td>${r.scheduledEnd ? fmtTime(r.scheduledEnd) : 'N/A'}</td>
                        <td>${duration}</td>
                        <td><span class="${typeClass}">${type}</span></td>
                      </tr>
                    `;
                  } catch (e) {
                    console.warn('Error rendering schedule row:', r, e);
                    return '<tr><td colspan="8" style="color: red;">Error rendering row</td></tr>';
                  }
                }).join('')}
              </tbody>
            </table>
          </div>
        `;
      } catch (e) {
        console.error('Error generating schedule table HTML:', e);
        tableHtml = '<div style="color: red; padding: 20px; text-align: center;">Error generating schedule table</div>';
      }
      
      resultsDiv.innerHTML = tableHtml;
      addDebugLog('Schedule table rendered successfully');
    }

    function getFilteredScheduleRows() {
      const teamId = $('teamSelect').value;
      const userId = $('userSelect').value;
      const search = $('userSearch').value.trim().toLowerCase();

      return state.scheduleRows.filter(r => {
        if (teamId !== 'all' && !(r.teamIds || []).includes(teamId)) return false;
        if (userId !== 'all' && r.userId !== userId) return false;
        if (search) {
          const hay = (r.userName + ' ' + (r.teamNames || '') + ' ' + r.date + ' ' + r.scheduledActivity).toLowerCase();
          if (!hay.includes(search)) return false;
        }
        return true;
      });
    }

    // ===== Fetch Schedules Only =====
    async function fetchSchedules() {
      try {
        const from = $('fromDate').value;
        const to = $('toDate').value || from;
        const businessUnitId = $('businessUnitSelect').value;
        const managementUnitId = $('managementUnitSelect').value;
        
        if (!from) { setStatus('Please select a start date', true); return; }
        if (!businessUnitId) { setStatus('Please select a business unit', true); return; }
        if (!managementUnitId) { setStatus('Please select a management unit', true); return; }
        
        const today = new Date().toISOString().split('T')[0];
        if (from > today || to > today) { setStatus('Date range cannot be in the future', true); return; }
        if (new Date(to) < new Date(from)) { setStatus('End date must be on or after start date', true); return; }

        setStatus('Fetching schedules‚Ä¶'); 
        setLoading(true);
        
        showProgress('Fetching schedule data‚Ä¶', 'Fetching Schedules');
        updateProgress(50, 1, 2);

        // Fetch schedule data using alternative methods
        const scheduleData = await fetchSchedulesAlternative(businessUnitId, managementUnitId, from, to);
        
        updateProgress(100, 2, 2);
        showProgress('Processing schedule data‚Ä¶', 'Fetching Schedules');

        // Process schedule data for display
        const processedData = processScheduleData(scheduleData);
        state.scheduleRows = processedData.rows;
        
        hideProgress();
        renderSchedules();
        
        if (state.scheduleRows.length) {
          setStatus(`Schedules loaded - ${state.scheduleRows.length} shifts found`);
        } else {
          setStatus('No schedule data found for the selected period. Try a different API method.');
        }
      } catch (e) {
        console.error('Error in fetchSchedules:', e);
        hideProgress();
        setStatus('Error fetching schedules: ' + e.message, true);
      } finally {
        setLoading(false);
      }
    }

    // ===== Existing Attendance Functions (simplified) =====
    async function fetchAttendance() {
      // Your existing attendance function here
      console.log('Fetching attendance data...');
      setStatus('Attendance feature coming soon...');
    }

    // ===== Events & Init =====
    $('fetchSchedulesBtn').addEventListener('click', fetchSchedules);
    $('fetchAttendanceBtn').addEventListener('click', fetchAttendance);
    $('businessUnitSelect').addEventListener('change', function() {
      if (this.value) {
        fetchManagementUnits(this.value);
      }
    });
    $('teamSelect').addEventListener('change', function() {
      if (document.querySelector('.tab.active').getAttribute('data-tab') === 'schedules') {
        renderSchedules();
      }
    });
    $('userSelect').addEventListener('change', function() {
      if (document.querySelector('.tab.active').getAttribute('data-tab') === 'schedules') {
        renderSchedules();
      }
    });
    $('userSearch').addEventListener('input', function() {
      if (document.querySelector('.tab.active').getAttribute('data-tab') === 'schedules') {
        renderSchedules();
      }
    });

    (function init() {
      const today = new Date(); 
      const weekAgo = new Date(); 
      weekAgo.setDate(today.getDate() - 7);
      $('fromDate').value = weekAgo.toISOString().slice(0,10);
      $('toDate').value = today.toISOString().slice(0,10);
      initAuth();
    })();
  </script>
</body>
</html>
