<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Attendance Insights - By IPI</title>
  <style>
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D;
      --pill:#e9f6f0;
    }
    body{font-family:"Aptos","Segoe UI",Arial,sans-serif;margin:20px;padding:20px;max-width:1400px;background:var(--light-bg);color:var(--text-color)}
    #logo-container{text-align:center;margin-bottom:20px} #logo{width:300px}
    h1{margin:0 0 16px}
    .card{background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;padding:24px;margin-top:16px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    label{display:block;font-weight:600;margin-bottom:6px}
    select,input,button{padding:10px;border:1px solid var(--border-color);border-radius:6px;background:var(--card-bg);font-size:14px}
    button{background:var(--primary-color);color:#fff;font-weight:600;cursor:pointer;transition:background .2s}
    button:hover{background:var(--secondary-color)} button:disabled{background:var(--text-light);cursor:not-allowed}
    .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px 24px;align-items:start}
    .inline{display:grid;grid-template-columns:1fr auto 1fr;gap:16px;align-items:center} .inline span{color:var(--text-light)}
    .full-width-btn{width:100%;padding:14px 18px;font-size:16px;margin-top:12px}
    .muted{color:var(--text-light)} .mono{font-family:ui-monospace,Consolas,Menlo,monospace}
    .loading{opacity:.6;pointer-events:none}
    .progress-bar{width:100%;height:8px;background:var(--border-color);border-radius:4px;overflow:hidden;margin:10px 0}
    .progress-fill{height:100%;background:var(--primary-color);transition:width .3s}
    .stats{display:flex;gap:16px;margin:16px 0;flex-wrap:wrap}
    .stat-card{flex:1;min-width:180px;border:1px solid var(--border-color);border-radius:8px;padding:16px;text-align:center;background:var(--card-bg)}
    .stat-number{font-size:22px;color:#63AB8F;font-weight:700}
    .stat-label{font-size:13px;color:var(--text-light)}
    .filter-controls{display:flex;gap:12px;margin-top:8px;flex-wrap:wrap}
    .filter-controls > *{flex:1;min-width:160px}
    .future-date{color:#ccc;cursor:not-allowed}
    .attendance-table{width:100%;border-collapse:collapse;margin-top:12px}
    .attendance-table th,.attendance-table td{border-bottom:1px solid var(--border-color);padding:8px 10px;vertical-align:top}
    .attendance-table th{background:var(--primary-color);color:#fff;text-align:left}
    .late-yes{color:#dc2626;font-weight:700}
    .late-no{color:#16a34a;font-weight:700}
  </style>
</head>
<body>
  <div id="logo-container">
    <img id="logo" src="https://raw.githubusercontent.com/gmcglynn88/ExternalWorkCreation/main/Consultinglogo.png" alt="Company Logo">
  </div>
  <h1>Attendance Insights - By IPI</h1>
  <button id="signinBtn" style="display:none;margin-bottom:12px;">Sign in to Genesys Cloud</button>

  <div id="authStatus" class="card" style="display:none;">
    <div style="text-align:center;padding:20px;">
      <div style="font-size:18px;color:var(--secondary-color);margin-bottom:8px;">üîê Authenticating‚Ä¶</div>
      <div class="muted">Connecting to Genesys Cloud</div>
    </div>
  </div>

  <div id="mainContent" style="display:none;">
    <div class="card">
      <h2 style="margin:0 0 12px;">Select Date Range & Filters</h2>
      <div class="controls">
        <div>
          <label>Date Range</label>
          <div class="inline">
            <input id="fromDate" type="date"/>
            <span>to</span>
            <input id="toDate" type="date"/>
          </div>
          <div class="muted" style="margin-top:6px;font-size:13px;">
            For best results, run one day or a small range at a time.
          </div>
        </div>
        <div>
          <label>Team & User Filters</label>
          <div class="filter-controls">
            <select id="teamSelect">
              <option value="all">All teams</option>
            </select>
            <select id="userSelect">
              <option value="all">All users</option>
            </select>
          </div>
          <input id="userSearch" type="text" placeholder="Search by user or team name" style="margin-top:8px;width:100%"/>
        </div>
      </div>
      <button id="fetchBtn" class="full-width-btn">Run Attendance Report</button>
    </div>

    <div id="statusMessage" class="muted" style="margin-top:10px;"></div>
    <div id="errorMessage" style="color:#dc2626;margin-top:6px;"></div>

    <div id="progressSection" style="display:none;">
      <div class="card">
        <h3 style="margin:0 0 8px;">Fetching Analytics</h3>
        <div class="muted" id="progressInfo">Requesting user statistics‚Ä¶</div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
        <div style="display:flex;justify-content:space-between;font-size:14px" class="muted">
          <span id="progressText">0%</span><span id="chunkText">Step 0/0</span>
        </div>
      </div>
    </div>

    <div id="resultsSection" style="display:none;">
      <div class="card">
        <h2 style="margin:0 0 12px;">Attendance Results</h2>
        <div class="stats">
          <div class="stat-card">
            <div class="stat-number" id="totalDays">0</div>
            <div class="stat-label">User-Days in Range</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="lateDays">0</div>
            <div class="stat-label">Late User-Days</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="uniqueUsers">0</div>
            <div class="stat-label">Unique Users</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="avgLateMinutes">0</div>
            <div class="stat-label">Avg Late Minutes (late days only)</div>
          </div>
        </div>
        <div id="attendanceResults"></div>
      </div>
    </div>
  </div>

  <script>
    // ===== Config (adjust clientId/redirectUri as needed) =====
    const CONFIG = {
      clientId: 'fe305808-b368-4547-8af9-325d28d552bb',
      redirectUri: 'https://gmcglynn88.github.io/AttendanceExplorer/',
      loginHost: 'https://login.mypurecloud.ie',
      apiHost: 'https://api.mypurecloud.ie'
    };

    // Tweaks for what "late" and "break" mean
    const ATTENDANCE_CONFIG = {
      workdayStartHour: 9,          // 9am local
      lateThresholdMinutes: 5,      // only count as late if >= 5 mins past start
      longBreakMinutes: 20          // gap between conversations >= 20 mins = break
    };

    // ===== State =====
    const state = {
      token: null,
      users: [],
      usersById: {},
      teams: [],
      teamMembersByTeamId: {},
      teamsByUserId: {}, // userId -> [{id,name}]
      attendanceRows: []
    };

    // ===== Utils =====
    const $ = id => document.getElementById(id);
    const setStatus = (msg,err=false)=>{ $('statusMessage').textContent = err?'':(msg||''); $('errorMessage').textContent = err?(msg||''):''; };
    const fmt = d => { if(!d) return 'N/A'; try{return new Date(d).toLocaleString()}catch{return 'N/A'} };
    const fmtDMY = s => { if(!s||s.length<10) return s||''; const [y,m,d]=s.slice(0,10).split('-'); return `${d}-${m}-${y}`; };
    const formatSeconds = ms => { if(!ms) return '0s'; const s=Math.floor(ms/1000), m=Math.floor(s/60), h=Math.floor(m/60); if(h) return `${h}h ${m%60}m`; if(m) return `${m}m ${s%60}s`; return `${s}s`; };
    function setLoading(v){ $('mainContent').classList.toggle('loading', !!v); }
    function updateProgress(p,cur,total){ $('progressFill').style.width = `${p}%`; $('progressText').textContent = `${Math.round(p)}%`; $('chunkText').textContent = `Step ${cur}/${total}`; }
    function showProgress(info){ $('progressSection').style.display='block'; $('resultsSection').style.display='none'; $('progressInfo').textContent = info || ''; }
    function hideProgress(){ $('progressSection').style.display='none'; }

    // ===== Date Range Limiting =====
    function setupDateLimits() {
      const today = new Date().toISOString().split('T')[0];
      $('fromDate').max = today; $('toDate').max = today;
      $('fromDate').addEventListener('change', function() {
        if (this.value > today) this.value = today;
        if ($('toDate').value && this.value > $('toDate').value) $('toDate').value = this.value;
      });
      $('toDate').addEventListener('change', function() {
        if (this.value > today) this.value = today;
        if ($('fromDate').value && this.value < $('fromDate').value) $('fromDate').value = this.value;
      });
    }

    // ===== Auth (implicit) =====
    function parseTokenFromHash(){
      const params = new URLSearchParams(location.hash.replace(/^#/, ''));
      return { token: params.get('access_token'), error: params.get('error'), errorDescription: params.get('error_description') };
    }
    function authUrl(){
      return `${CONFIG.loginHost}/oauth/authorize?client_id=${encodeURIComponent(CONFIG.clientId)}&response_type=token&redirect_uri=${encodeURIComponent(CONFIG.redirectUri)}`;
    }
    function showMain(){ $('authStatus').style.display='none'; $('mainContent').style.display='block'; }

    function initAuth(){
      const {token, error} = parseTokenFromHash();
      if(location.hash) history.replaceState(null,'',location.pathname);

      if(token){
        sessionStorage.removeItem('gc_auto_auth_attempted');
        state.token = token;
        showMain();
        setupDateLimits();
        fetchAllUsers();
        fetchAllTeamsAndMembers();
        return;
      }

      const attempted = sessionStorage.getItem('gc_auto_auth_attempted');
      if(!attempted && !error){
        sessionStorage.setItem('gc_auto_auth_attempted','1');
        location.assign(authUrl());
        return;
      }

      $('signinBtn').style.display = 'inline-block';
      $('signinBtn').onclick = () => { sessionStorage.setItem('gc_auto_auth_attempted','1'); location.assign(authUrl()); };
      $('authStatus').style.display = 'none';
    }

    // ===== API helper =====
    async function api(path){
      if(!state.token) throw new Error('Not authenticated');
      const res = await fetch(`${CONFIG.apiHost}${path}`, { headers:{Authorization:`Bearer ${state.token}`} });
      if(res.status===401||res.status===403) throw new Error(`Authentication error (${res.status}). Please refresh.`);
      if(!res.ok){ const t = await res.text().catch(()=> ''); throw new Error(`API Error: ${res.status} ${res.statusText}${t?` - ${t.slice(0,200)}`:''}`); }
      return res.json();
    }

    // ===== Users =====
    async function fetchAllUsers(){
      try{
        setStatus('Loading users‚Ä¶'); setLoading(true);
        let all=[], page=1, size=100;
        while(true){
          const data = await api(`/api/v2/users?pageSize=${size}&pageNumber=${page}`);
          const ents = data?.entities||[];
          all = all.concat(ents);
          if(!data?.nextUri || ents.length<size) break;
          page++;
        }
        state.users = all.map(u=>({id:u.id,name:u.name||'',email:u.email||''})).sort((a,b)=>a.name.localeCompare(b.name));
        state.usersById = {};
        state.users.forEach(u=>{ state.usersById[u.id]=u; });
        populateUserSelect(state.users);
        setStatus(`Loaded ${state.users.length} users`);
      }catch(e){
        setStatus(`Failed to load users: ${e.message}`, true);
        $('userSelect').innerHTML='<option value="all">Failed to load users</option>';
      }finally{ setLoading(false); }
    }
    function populateUserSelect(users){
      const sel=$('userSelect');
      sel.innerHTML = '<option value="all">All users</option>' +
        users.map(u=>`<option value="${u.id}">${u.name||'(Unnamed)'}</option>`).join('');
    }

    // ===== Teams & members =====
    function populateTeamSelect(teams){
      const sel=$('teamSelect');
      sel.innerHTML = '<option value="all">All teams</option>' +
        teams.map(t=>`<option value="${t.id}">${t.name||'(Unnamed team)'}</option>`).join('');
    }

    async function fetchTeamMembers(teamId){
      let members = [];
      let page=1, size=100;
      while(true){
        const data = await api(`/api/v2/teams/${teamId}/members?pageSize=${size}&pageNumber=${page}`);
        const ents = data?.entities || data?.members || [];
        members = members.concat(ents);
        if(!data?.nextUri || ents.length<size) break;
        page++;
      }
      return members.map(m => ({
        id: m.id || m.user?.id,
        name: m.name || m.user?.name || ''
      })).filter(m=>m.id);
    }

    async function fetchAllTeamsAndMembers(){
      try{
        setLoading(true);
        setStatus('Loading teams‚Ä¶');
        let all=[], page=1, size=100;
        while(true){
          const data = await api(`/api/v2/teams?pageSize=${size}&pageNumber=${page}`);
          const ents = data?.entities||[];
          all = all.concat(ents);
          if(!data?.nextUri || ents.length<size) break;
          page++;
        }
        state.teams = all.map(t=>({id:t.id,name:t.name||'(Unnamed team)'})).sort((a,b)=>a.name.localeCompare(b.name));
        populateTeamSelect(state.teams);

        state.teamMembersByTeamId = {};
        state.teamsByUserId = {};

        let step = 0;
        for(const team of state.teams){
          step++;
          updateProgress( (step/state.teams.length)*100, step, state.teams.length );
          try{
            const members = await fetchTeamMembers(team.id);
            state.teamMembersByTeamId[team.id] = members;
            for(const m of members){
              if(!state.teamsByUserId[m.id]) state.teamsByUserId[m.id] = [];
              state.teamsByUserId[m.id].push({id:team.id,name:team.name});
            }
          }catch(e){
            console.warn('Failed to fetch members for team', team.id, e);
          }
        }
        hideProgress();
        setStatus('Users & teams loaded');
      }catch(e){
        hideProgress();
        console.error(e);
        setStatus('Failed to load teams: ' + e.message, true);
      }finally{
        setLoading(false);
      }
    }

    function onTeamChange(){
      const teamId = $('teamSelect').value;
      if(teamId === 'all'){
        populateUserSelect(state.users);
      }else{
        const members = state.teamMembersByTeamId[teamId] || [];
        const memberIds = new Set(members.map(m=>m.id));
        populateUserSelect(state.users.filter(u=>memberIds.has(u.id)));
      }
      renderAttendance(); // re-filter current results
    }

    // ===== Attendance processing =====
    function buildAttendanceRows(analyticsData){
      const rows = [];
      const details = analyticsData?.userDetails || analyticsData?.results || [];
      if(!Array.isArray(details)) return rows;

      const longBreakMs = ATTENDANCE_CONFIG.longBreakMinutes * 60 * 1000;
      const lateThresholdMs = ATTENDANCE_CONFIG.lateThresholdMinutes * 60 * 1000;

      for(const d of details){
        const userId = d.userId || d.user?.id;
        if(!userId) continue;
        const userName = state.usersById[userId]?.name || d.user?.name || `User ${userId}`;
        const convsRaw = d.conversations || d.conversationDetails || [];
        const convs = convsRaw.filter(c=>c.conversationStart && c.conversationEnd);
        if(!convs.length) continue;

        // group by date
        const byDate = {};
        for(const c of convs){
          const start = c.conversationStart;
          if(!start) continue;
          const day = start.slice(0,10); // YYYY-MM-DD
          if(!byDate[day]) byDate[day]=[];
          byDate[day].push(c);
        }

        const userTeams = state.teamsByUserId[userId] || [];
        const teamNames = userTeams.map(t=>t.name).join(', ');
        const teamIds = userTeams.map(t=>t.id);

        for(const [day, list] of Object.entries(byDate)){
          list.sort((a,b)=> new Date(a.conversationStart) - new Date(b.conversationStart));
          const firstStart = list[0].conversationStart;
          const lastEnd = list[list.length-1].conversationEnd;

          let breakCount = 0;
          let longestBreakMs = 0;
          for(let i=0;i<list.length-1;i++){
            const gap = new Date(list[i+1].conversationStart) - new Date(list[i].conversationEnd);
            if(gap > longBreakMs){
              breakCount++;
              if(gap > longestBreakMs) longestBreakMs = gap;
            }
          }

          const workdayStart = new Date(day + 'T' + String(ATTENDANCE_CONFIG.workdayStartHour).padStart(2,'0') + ':00:00');
          let lateMs = new Date(firstStart) - workdayStart;
          if(lateMs < lateThresholdMs) lateMs = 0;
          const isLate = lateMs > 0;

          rows.push({
            userId,
            userName,
            teamNames,
            teamIds,
            date: day,
            firstActivity: firstStart,
            lastActivity: lastEnd,
            conversationCount: list.length,
            isLate,
            lateMs,
            breakCount,
            longestBreakMs,
            spanMs: new Date(lastEnd) - new Date(firstStart)
          });
        }
      }
      return rows;
    }

    function getFilteredRows(){
      const teamId = $('teamSelect').value;
      const userId = $('userSelect').value;
      const search = $('userSearch').value.trim().toLowerCase();

      return state.attendanceRows.filter(r=>{
        if(teamId !== 'all' && !(r.teamIds || []).includes(teamId)) return false;
        if(userId !== 'all' && r.userId !== userId) return false;
        if(search){
          const hay = (r.userName + ' ' + (r.teamNames || '') + ' ' + r.date).toLowerCase();
          if(!hay.includes(search)) return false;
        }
        return true;
      });
    }

    function renderAttendance(){
      const resultsDiv = $('attendanceResults');
      if(!state.attendanceRows.length){
        $('resultsSection').style.display='none';
        return;
      }
      const rows = getFilteredRows();
      $('resultsSection').style.display='block';

      if(!rows.length){
        $('totalDays').textContent = '0';
        $('lateDays').textContent = '0';
        $('uniqueUsers').textContent = '0';
        $('avgLateMinutes').textContent = '0';
        resultsDiv.innerHTML = '<div class="muted" style="text-align:center;padding:40px"><div style="font-size:48px;margin-bottom:12px">üì≠</div><div>No activity found for the selected filters.</div></div>';
        return;
      }

      const totalDays = rows.length;
      const lateDays = rows.filter(r=>r.isLate).length;
      const uniqueUsers = new Set(rows.map(r=>r.userId)).size;
      const totalLateMs = rows.filter(r=>r.isLate).reduce((sum,r)=>sum+r.lateMs,0);
      const avgLateMinutes = lateDays ? (totalLateMs/lateDays/60000).toFixed(1) : '0';

      $('totalDays').textContent = totalDays;
      $('lateDays').textContent = lateDays;
      $('uniqueUsers').textContent = uniqueUsers;
      $('avgLateMinutes').textContent = avgLateMinutes;

      const breakThreshold = ATTENDANCE_CONFIG.longBreakMinutes;

      const tableHtml = `
        <table class="attendance-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>User</th>
              <th>Team(s)</th>
              <th>First Activity</th>
              <th>Last Activity</th>
              <th>Span</th>
              <th>Conversations</th>
              <th>Late?</th>
              <th>Late (mins)</th>
              <th>Breaks ‚â• ${breakThreshold}m</th>
              <th>Longest Break (mins)</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r=>{
              const lateClass = r.isLate ? 'late-yes' : 'late-no';
              const spanHours = r.spanMs>0 ? (r.spanMs/3600000).toFixed(2) : '0';
              const lateMins = (r.lateMs/60000).toFixed(1);
              const longBreakMins = (r.longestBreakMs/60000).toFixed(1);
              return `
                <tr>
                  <td>${fmtDMY(r.date)}</td>
                  <td>${r.userName}</td>
                  <td>${r.teamNames || '-'}</td>
                  <td>${fmt(r.firstActivity)}</td>
                  <td>${fmt(r.lastActivity)}</td>
                  <td>${spanHours}</td>
                  <td>${r.conversationCount}</td>
                  <td><span class="${lateClass}">${r.isLate ? 'Yes' : 'No'}</span></td>
                  <td>${lateMins}</td>
                  <td>${r.breakCount}</td>
                  <td>${longBreakMins}</td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
      resultsDiv.innerHTML = tableHtml;
    }

    // ===== Fetch attendance (analytics users details) =====
    async function fetchAttendance(){
      try{
        const from=$('fromDate').value, to=$('toDate').value||from;
        if(!from){ setStatus('Please select a start date', true); return; }
        const today = new Date().toISOString().split('T')[0];
        if(from > today || to > today) { setStatus('Date range cannot be in the future', true); return; }
        if(new Date(to) < new Date(from)){ setStatus('End date must be on or after start date', true); return; }

        setStatus('Running attendance report‚Ä¶'); setLoading(true);
        showProgress('Requesting user analytics‚Ä¶');
        updateProgress(10,1,3);

        const body = {
          interval: `${from}T00:00:00/${to}T23:59:59`
          // You can add additional filters/metrics here if needed
        };

        const res = await fetch(CONFIG.apiHost + '/api/v2/analytics/users/details/query', {
          method:'POST',
          headers:{Authorization:'Bearer ' + state.token,'Content-Type':'application/json'},
          body:JSON.stringify(body)
        });
        if(!res.ok){
          const t = await res.text().catch(()=> '');
          throw new Error('Analytics error: ' + res.status + ' ' + res.statusText + (t?' - ' + t.slice(0,200):''));
        }
        updateProgress(60,2,3);
        const data = await res.json();

        state.attendanceRows = buildAttendanceRows(data);
        updateProgress(100,3,3);
        hideProgress();
        renderAttendance();
        if(state.attendanceRows.length){
          setStatus('Attendance report completed');
        }else{
          setStatus('No activity found for the selected period');
        }
      }catch(e){
        console.error(e);
        hideProgress();
        setStatus('Error fetching attendance: ' + e.message, true);
      }finally{
        setLoading(false);
      }
    }

    // ===== Events & Init =====
    $('fetchBtn').addEventListener('click', fetchAttendance);
    $('teamSelect').addEventListener('change', onTeamChange);
    $('userSelect').addEventListener('change', renderAttendance);
    $('userSearch').addEventListener('input', renderAttendance);

    (function init(){
      const today=new Date(); const weekAgo=new Date(); weekAgo.setDate(today.getDate()-7);
      $('fromDate').value = weekAgo.toISOString().slice(0,10);
      $('toDate').value = today.toISOString().slice(0,10);
      initAuth();
    })();
  </script>
</body>
</html>
