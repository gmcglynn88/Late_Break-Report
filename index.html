<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WFM Helper</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  
  <!-- MAIN STYLES (Common to all tabs) -->
  <style>
    :root {
      --primary-color: #63AB8F;
      --secondary-color: #4A8C7D;
      --border-color: #DEE2E6;
      --light-bg: #F8F9FA;
      --card-bg: #FFFFFF;
      --text-color: #2C3E50;
      --text-light: #6C757D;
      --pill: #e9f6f0;
      --warning-bg: #fef3f2;
      --warning-border: #fecdca;
      --warning-text: #b42318;
      --success-bg: #f6fef9;
      --success-border: #75e0a7;
      --success-text: #079455;
    }
    
    body {
      font-family: 'Aptos', 'Segoe UI', system-ui, -apple-system, Arial, sans-serif;
      margin: 20px;
      padding: 20px;
      max-width: 1400px;
      background: var(--light-bg);
      color: var(--text-color)
    }
    
    #logo-container {
      text-align: center;
      margin-bottom: 20px
    }
    
    #logo {
      width: 300px
    }
    
    h1 {
      margin: 0 0 16px
    }
    
    .card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      margin-top: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,.08)
    }
    
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px
    }
    
    input, select, button, textarea {
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: #fff;
      font-size: 14px
    }
    
    button {
      background: var(--primary-color);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: background .2s
    }
    
    button:hover {
      background: var(--secondary-color)
    }
    
    button:disabled {
      background: var(--text-light);
      cursor: not-allowed
    }
    
    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
      align-items: end
    }
    
    .full-width-btn {
      width: 100%;
      padding: 14px 18px;
      font-size: 16px;
      margin-top: 12px
    }
    
    .muted {
      color: var(--text-light);
      font-size: 12px;
      margin-top: 4px
    }
    
    .section-title {
      margin: 0 0 10px;
      color: var(--secondary-color)
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 16px
    }
    
    .tab {
      padding: 12px 24px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      font-weight: 600;
      transition: all 0.2s;
      color: var(--text-light)
    }
    
    .tab.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
      background: var(--light-bg)
    }
    
    .tab-content {
      display: none
    }
    
    .tab-content.active {
      display: block
    }
    
    #messageContainer {
      display: none;
      margin-top: 12px
    }
    
    .error-message {
      color: #b4231a;
      background: #fee2e2;
      border: 1px solid #fecaca;
      padding: 10px;
      border-radius: 6px
    }
    
    .success-message {
      color: #14532d;
      background: #dcfce7;
      border: 1px solid #bbf7d0;
      padding: 10px;
      border-radius: 6px
    }
    
    .info-message {
      color: #6b4e16;
      background: #fff7ed;
      border: 1px solid #ffedd5;
      padding: 10px;
      border-radius: 6px
    }
    
    /* Common Table Styles */
    .schedule-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px
    }
    
    .schedule-table th,
    .schedule-table td {
      border: 1px solid var(--border-color);
      padding: 8px;
      font-size: 13px
    }
    
    .schedule-table th {
      background: var(--light-bg);
      text-align: left;
      cursor: pointer;
      position: relative
    }
    
    .schedule-table th.sortable:hover {
      background: #e9ecef
    }
    
    .pill {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 999px;
      background: var(--pill);
      font-size: 11px;
      color: var(--secondary-color)
    }
    
    .schedule-meta {
      margin-top: 8px;
      font-size: 12px;
      color: var(--text-light)
    }
    
    /* Checkbox Dropdown (Common) */
    .checkbox-dropdown {
      position: relative;
      min-width: 220px;
      width: 100%
    }
    
    .cd-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: #fff;
      padding: 10px;
      cursor: pointer;
      width: 100%;
      box-sizing: border-box
    }
    
    .cd-trigger .label {
      color: var(--text-color);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1
    }
    
    .cd-trigger .count {
      background: var(--pill);
      border: 1px solid var(--border-color);
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 12px;
      color: #2c3e50;
      flex-shrink: 0;
      margin-left: 8px
    }
    
    .cd-panel {
      position: absolute;
      z-index: 1000;
      margin-top: 6px;
      background: #fff;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0,0,0,.12);
      width: 100%;
      max-height: 340px;
      overflow: hidden;
      display: none;
      box-sizing: border-box
    }
    
    .cd-panel.open {
      display: block
    }
    
    .cd-header {
      padding: 10px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      gap: 8px;
      align-items: center
    }
    
    .cd-search {
      flex: 1;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 8px;
      width: 100%;
      box-sizing: border-box
    }
    
    .cd-actions {
      display: flex;
      gap: 8px
    }
    
    .cd-actions button {
      background: #eef6f2;
      color: #2c3e50;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 8px 10px;
      cursor: pointer;
      white-space: nowrap
    }
    
    .cd-selectall {
      padding: 8px 12px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 10px
    }
    
    .cd-list {
      max-height: 260px;
      overflow: auto
    }
    
    .cd-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-bottom: 1px solid #f1f3f5
    }
    
    .cd-item label {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      width: 100%
    }
    
    .cd-footer {
      padding: 8px 12px;
      background: #fafafa;
      border-top: 1px solid var(--border-color);
      font-size: 12px;
      color: var(--text-light);
      display: flex;
      justify-content: space-between
    }
    
    /* Filter by activity */
    .filter-activity-container {
      margin-top: 16px;
      padding: 16px;
      background: var(--light-bg);
      border-radius: 8px;
      border: 1px solid var(--border-color)
    }
    
    .filter-activity-title {
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--secondary-color)
    }
    
    /* Table controls */
    .table-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 16px 0;
      flex-wrap: wrap;
      gap: 10px
    }
    
    .sort-controls {
      display: flex;
      gap: 10px;
      align-items: center
    }
    
    /* Export buttons */
    .export-buttons {
      display: flex;
      gap: 10px;
      margin: 16px 0;
      justify-content: flex-start;
      flex-wrap: wrap
    }
    
    .export-btn {
      background: var(--secondary-color);
      padding: 8px 16px;
      font-size: 14px
    }
  </style>
</head>
<body>
  <div id="logo-container">
    <img id="logo" src="https://raw.githubusercontent.com/gmcglynn88/ExternalWorkCreation/main/Consultinglogo.png" alt="Company Logo">
  </div>

  <h1>WFM Helper</h1>

  <div id="authCard" class="card">
    <div id="auth-message" class="info-message">Authenticating with Genesys Cloud...</div>
  </div>

  <div id="appContent" style="display:none;">
    <div id="messageContainer"></div>

    <!-- Tabs Navigation -->
    <div class="tabs">
      <div class="tab active" data-tab="schedule">Schedule View</div>
      <div class="tab" data-tab="actual">Actual Activity</div>
      <div class="tab" data-tab="overtime">Overtime Tracking</div>
      <div class="tab" data-tab="absence">Absence Analytics</div>
      <div class="tab" data-tab="late">Late Report</div>
      <div class="tab" data-tab="timeowed">Time Owed</div>
    </div>

    <!-- SCHEDULE TAB -->
    <div id="schedule-tab" class="tab-content active">
      <style>
        /* Schedule Tab Specific Styles */
        #schedule-tab .warning-row {
          background: var(--warning-bg) !important;
          border-left: 4px solid var(--warning-text)
        }
        
        #schedule-tab .absence-badge {
          background: #ea580c;
          color: white;
          padding: 2px 8px;
          border-radius: 12px;
          font-size: 11px;
          font-weight: 600
        }
        
        #schedule-tab .overtime-badge {
          background: #dc2626;
          color: white;
          padding: 2px 8px;
          border-radius: 12px;
          font-size: 11px;
          font-weight: 600
        }
      </style>
      
      <div class="card">
        <h2 class="section-title">Filters</h2>
        <div class="controls">
          <div>
            <label for="businessUnitSelect">Business Unit</label>
            <div id="businessUnitDropdown" class="checkbox-dropdown"></div>
            <div class="muted">Required</div>
          </div>

          <div>
            <label for="managementUnitSelect">Management Unit</label>
            <div id="managementUnitDropdown" class="checkbox-dropdown"></div>
            <div class="muted">Required for schedule search</div>
          </div>

          <div>
            <label>Team</label>
            <div id="teamDropdown" class="checkbox-dropdown"></div>
            <div class="muted">Optional – narrows users by team</div>
          </div>

          <div>
            <label>User</label>
            <div id="userDropdown" class="checkbox-dropdown"></div>
            <div class="muted">Required – schedule shown for this user</div>
          </div>

          <div>
            <label for="startDate">Start date</label>
            <input type="date" id="startDate" />
            <div class="muted">e.g. 03-11-2025</div>
          </div>

          <div>
            <label for="endDate">End date</label>
            <input type="date" id="endDate" />
            <div class="muted">e.g. 08-11-2025</div>
          </div>
        </div>

        <button id="loadScheduleBtn" class="full-width-btn">Load Schedule</button>
      </div>

      <div id="results" class="card" style="display:none;">
        <div class="table-controls">
          <div class="sort-controls">
            <label for="scheduleSort">Sort by:</label>
            <select id="scheduleSort">
              <option value="date">Date</option>
              <option value="user">User</option>
              <option value="activity">Activity</option>
              <option value="duration">Duration</option>
            </select>
            <select id="scheduleSortOrder">
              <option value="asc">Ascending</option>
              <option value="desc">Descending</option>
            </select>
          </div>
        </div>
        
        <div class="filter-activity-container">
          <div class="filter-activity-title">Filter by Activity</div>
          <div id="activityFilterDropdown" class="checkbox-dropdown"></div>
        </div>
        
        <div class="export-buttons">
          <button id="exportScheduleBtn" class="export-btn">Export Schedule to CSV</button>
        </div>
        
        <div id="scheduleResultsContent"></div>
      </div>
    </div>

    <!-- ACTUAL ACTIVITY TAB -->
    <div id="actual-tab" class="tab-content">
      <style>
        /* Actual Activity Tab Specific Styles */
        #actual-tab .warning-row {
          background: var(--warning-bg) !important;
          border-left: 4px solid var(--warning-text)
        }
        
        #actual-tab .chart-wrapper {
          margin: 20px 0;
          background: white;
          border-radius: 8px;
          padding: 20px;
          border: 1px solid var(--border-color)
        }
        
        #actual-tab .chart-bar {
          display: flex;
          align-items: center;
          margin-bottom: 12px
        }
        
        #actual-tab .chart-bar-label {
          width: 150px;
          font-size: 14px;
          font-weight: 500
        }
        
        #actual-tab .chart-bar-container {
          flex: 1;
          height: 24px;
          background: #f1f5f9;
          border-radius: 12px;
          overflow: hidden
        }
        
        #actual-tab .chart-bar-fill {
          height: 100%;
          background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
          border-radius: 12px;
          transition: width 0.5s ease;
          display: flex;
          align-items: center;
          justify-content: flex-end;
          padding-right: 8px;
          color: white;
          font-size: 12px;
          font-weight: 600
        }
        
        #actual-tab .chart-bar-value {
          width: 80px;
          text-align: right;
          font-size: 14px;
          font-weight: 600
        }
      </style>
      
      <div class="card">
        <h2 class="section-title">Actual Activity (Historical Adherence)</h2>
        <div class="controls">
          <div>
            <label for="actualBuSelect">Business Unit</label>
            <div id="actualBuDropdown" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label for="actualMuSelect">Management Unit</label>
            <div id="actualMuDropdown" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label>Team</label>
            <div id="actualTeamDropdown" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label>User</label>
            <div id="actualUserDropdown" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label for="actualStartDate">Start Date</label>
            <input type="date" id="actualStartDate" />
          </div>
          <div>
            <label for="actualEndDate">End Date</label>
            <input type="date" id="actualEndDate" />
          </div>
        </div>
        <button id="loadActualActivityBtn" class="full-width-btn">Load Actual Activity</button>
      </div>

      <div id="actualResults" class="card" style="display:none;">
        <div class="table-controls">
          <div class="sort-controls">
            <label for="actualSort">Sort by:</label>
            <select id="actualSort">
              <option value="date">Date</option>
              <option value="user">User</option>
              <option value="activity">Activity</option>
              <option value="duration">Duration</option>
            </select>
            <select id="actualSortOrder">
              <option value="asc">Ascending</option>
              <option value="desc">Descending</option>
            </select>
          </div>
        </div>
        
        <div class="filter-activity-container">
          <div class="filter-activity-title">Filter by Activity</div>
          <div id="actualActivityFilterDropdown" class="checkbox-dropdown"></div>
        </div>
        
        <div class="export-buttons">
          <button id="exportActualActivityBtn" class="export-btn">Export Actual Activity to CSV</button>
        </div>
        
        <div id="actualResultsContent"></div>
      </div>
    </div>

    <!-- OVERTIME TAB -->
    <div id="overtime-tab" class="tab-content">
      <style>
        /* Overtime Tab Specific Styles */
        #overtime-tab .warning-row {
          background: var(--warning-bg) !important;
          border-left: 4px solid var(--warning-text)
        }
        
        #overtime-tab .overtime-metrics {
          display: flex;
          gap: 16px;
          margin-bottom: 20px;
          flex-wrap: wrap
        }
        
        #overtime-tab .overtime-metric-card {
          background: white;
          border: 1px solid var(--border-color);
          border-radius: 8px;
          padding: 16px;
          text-align: center;
          flex: 1;
          min-width: 150px
        }
        
        #overtime-tab .metric-label {
          font-size: 12px;
          color: var(--text-light);
          text-transform: uppercase
        }
        
        #overtime-tab .metric-value {
          font-size: 24px;
          font-weight: bold;
          color: var(--primary-color);
          margin: 8px 0;
          transition: color 0.2s
        }
        
        #overtime-tab .chart-wrapper {
          margin: 20px 0;
          background: white;
          border-radius: 8px;
          padding: 20px;
          border: 1px solid var(--border-color)
        }
        
        #overtime-tab .chart-bar {
          display: flex;
          align-items: center;
          margin-bottom: 12px
        }
        
        #overtime-tab .chart-bar-label {
          width: 150px;
          font-size: 14px;
          font-weight: 500
        }
        
        #overtime-tab .chart-bar-container {
          flex: 1;
          height: 24px;
          background: #f1f5f9;
          border-radius: 12px;
          overflow: hidden
        }
        
        #overtime-tab .chart-bar-fill {
          height: 100%;
          background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
          border-radius: 12px;
          transition: width 0.5s ease;
          display: flex;
          align-items: center;
          justify-content: flex-end;
          padding-right: 8px;
          color: white;
          font-size: 12px;
          font-weight: 600
        }
        
        #overtime-tab .chart-bar-value {
          width: 80px;
          text-align: right;
          font-size: 14px;
          font-weight: 600
        }
        
        #overtime-tab .overtime-details {
          margin-top: 8px;
          padding-left: 16px;
          border-left: 2px solid var(--border-color)
        }
        
        #overtime-tab .overtime-activity {
          display: flex;
          justify-content: space-between;
          padding: 4px 0;
          border-bottom: 1px solid #f0f0f0
        }
        
        #overtime-tab .overtime-activity:last-child {
          border-bottom: none
        }
        
        #overtime-tab .overtime-date {
          font-weight: 500
        }
        
        #overtime-tab .overtime-duration {
          color: var(--text-light)
        }
      </style>
      
      <div class="card">
        <h2 class="section-title">Overtime Analysis</h2>
        <div class="controls">
          <div>
            <label for="overtimeBuSelect">Business Unit</label>
            <div id="overtimeBuDropdown" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label for="overtimeMuSelect">Management Unit</label>
            <div id="overtimeMuDropdown" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label>Team</label>
            <div id="overtimeTeamDropdown" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label for="overtimeStartDate">Start Date</label>
            <input type="date" id="overtimeStartDate" />
          </div>
          <div>
            <label for="overtimeEndDate">End Date</label>
            <input type="date" id="overtimeEndDate" />
          </div>
        </div>
        <button id="analyzeOvertimeBtn" class="full-width-btn">Analyze Overtime</button>
      </div>

      <div id="overtimeResults" class="card" style="display:none;">
        <div class="table-controls">
          <div class="sort-controls">
            <label for="overtimeSort">Sort by:</label>
            <select id="overtimeSort">
              <option value="user">User</option>
              <option value="totalHours">Total Hours</option>
              <option value="rate1Hours">1.0 Rate Hours</option>
              <option value="rate1_5Hours">1.5 Rate Hours</option>
              <option value="rate2Hours">2.0 Rate Hours</option>
            </select>
            <select id="overtimeSortOrder">
              <option value="desc">Descending</option>
              <option value="asc">Ascending</option>
            </select>
          </div>
        </div>
        
        <div class="filter-activity-container">
          <div class="filter-activity-title">Filter by Overtime Activity</div>
          <div id="overtimeActivityFilterDropdown" class="checkbox-dropdown"></div>
        </div>
        
        <div class="export-buttons">
          <button id="exportOvertimeSummaryBtn" class="export-btn">Export Summary to CSV</button>
          <button id="exportOvertimeDetailsBtn" class="export-btn">Export Details to CSV</button>
        </div>
        
        <div id="overtimeResultsContent"></div>
      </div>
    </div>

    <!-- ABSENCE TAB -->
    <div id="absence-tab" class="tab-content">
      <style>
        /* Absence Tab Specific Styles */
        #absence-tab .warning-row {
          background: var(--warning-bg) !important;
          border-left: 4px solid var(--warning-text)
        }
        
        #absence-tab .analytics-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 20px;
          margin: 20px 0
        }
        
        @media (max-width: 768px) {
          #absence-tab .analytics-grid {
            grid-template-columns: 1fr
          }
        }
        
        #absence-tab .metric-card {
          background: white;
          border: 1px solid var(--border-color);
          border-radius: 8px;
          padding: 16px;
          text-align: center;
          cursor: pointer;
          transition: all 0.2s ease
        }
        
        #absence-tab .metric-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(0,0,0,0.1)
        }
        
        #absence-tab .metric-card.clickable .metric-value {
          color: var(--primary-color);
          text-decoration: underline
        }
        
        #absence-tab .metric-value {
          font-size: 24px;
          font-weight: bold;
          color: var(--primary-color);
          margin: 8px 0;
          transition: color 0.2s
        }
        
        #absence-tab .metric-label {
          font-size: 12px;
          color: var(--text-light);
          text-transform: uppercase
        }
        
        #absence-tab .absence-badge {
          background: #ea580c;
          color: white;
          padding: 2px 8px;
          border-radius: 12px;
          font-size: 11px;
          font-weight: 600
        }
        
        #absence-tab .chart-wrapper {
          margin: 20px 0;
          background: white;
          border-radius: 8px;
          padding: 20px;
          border: 1px solid var(--border-color)
        }
        
        #absence-tab .chart-bar {
          display: flex;
          align-items: center;
          margin-bottom: 12px
        }
        
        #absence-tab .chart-bar-label {
          width: 150px;
          font-size: 14px;
          font-weight: 500
        }
        
        #absence-tab .chart-bar-container {
          flex: 1;
          height: 24px;
          background: #f1f5f9;
          border-radius: 12px;
          overflow: hidden
        }
        
        #absence-tab .chart-bar-fill {
          height: 100%;
          background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
          border-radius: 12px;
          transition: width 0.5s ease;
          display: flex;
          align-items: center;
          justify-content: flex-end;
          padding-right: 8px;
          color: white;
          font-size: 12px;
          font-weight: 600
        }
        
        #absence-tab .chart-bar-value {
          width: 80px;
          text-align: right;
          font-size: 14px;
          font-weight: 600
        }
        
        #absence-tab .absence-details {
          margin-top: 8px;
          padding-left: 16px;
          border-left: 2px solid var(--border-color)
        }
        
        #absence-tab .absence-day {
          display: flex;
          justify-content: space-between;
          padding: 4px 0;
          border-bottom: 1px solid #f0f0f0
        }
        
        #absence-tab .absence-day:last-child {
          border-bottom: none
        }
        
        #absence-tab .absence-date {
          font-weight: 500
        }
        
        #absence-tab .absence-duration {
          color: var(--text-light)
        }
        
        #absence-tab .drilldown-active {
          background: var(--light-bg) !important;
          border: 2px solid var(--primary-color) !important
        }
        
        #absence-tab .drilldown-badge {
          background: var(--primary-color);
          color: white;
          padding: 2px 8px;
          border-radius: 12px;
          font-size: 11px;
          margin-left: 8px
        }
        
        /* Toggle buttons for detailed view */
        #absence-tab .view-toggle {
          display: flex;
          gap: 10px;
          margin: 16px 0
        }
        
        #absence-tab .view-toggle-btn {
          background: var(--light-bg);
          border: 1px solid var(--border-color);
          color: var(--text-color);
          padding: 8px 16px;
          border-radius: 6px;
          cursor: pointer;
          transition: all 0.2s
        }
        
        #absence-tab .view-toggle-btn.active {
          background: var(--primary-color);
          color: white;
          border-color: var(--primary-color)
        }
      </style>
      
      <div class="card">
        <h2 class="section-title">Absence Analytics</h2>
        <div class="controls">
          <div>
            <label for="absenceBuSelect">Business Unit</label>
            <div id="absenceBuDropdown" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label for="absenceMuSelect">Management Unit</label>
            <div id="absenceMuDropdown" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label>Team</label>
            <div id="absenceTeamDropdown" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label for="absenceStartDate">Start Date</label>
            <input type="date" id="absenceStartDate" />
          </div>
          <div>
            <label for="absenceEndDate">End Date</label>
            <input type="date" id="absenceEndDate" />
          </div>
          <div>
            <label for="absenceThreshold">Alert Threshold (days)</label>
            <input type="number" id="absenceThreshold" value="2" min="0" step="0.5" />
            <div class="muted">Threshold in days (e.g., 2 = 2 days)</div>
          </div>
        </div>
        <button id="analyzeAbsenceBtn" class="full-width-btn">Analyze Absence</button>
      </div>

      <div id="absenceResults" class="card" style="display:none;">
        <div class="table-controls">
          <div class="sort-controls">
            <label for="absenceSort">Sort by:</label>
            <select id="absenceSort">
              <option value="user">User</option>
              <option value="totalHours">Total Hours</option>
              <option value="absenceDays">Absence Days</option>
              <option value="instances">Instances</option>
            </select>
            <select id="absenceSortOrder">
              <option value="desc">Descending</option>
              <option value="asc">Ascending</option>
            </select>
          </div>
        </div>
        
        <div class="filter-activity-container">
          <div class="filter-activity-title">Filter by Absence Type</div>
          <div id="absenceActivityFilterDropdown" class="checkbox-dropdown"></div>
        </div>
        
        <div class="export-buttons">
          <button id="exportAbsenceBtn" class="export-btn">Export Summary to CSV</button>
          <button id="exportAbsenceDetailsBtn" class="export-btn">Export Details to CSV</button>
        </div>

        <!-- View Toggle -->
        <div class="view-toggle">
          <button class="view-toggle-btn active" data-view="summary">Summary View</button>
          <button class="view-toggle-btn" data-view="detailed">Detailed Table</button>
        </div>
        
        <div id="absenceResultsContent"></div>
      </div>
    </div>

    <!-- LATE REPORT TAB -->
    <div id="late-tab" class="tab-content">
      <style>
        /* Late Report Tab Specific Styles */
        #late-tab .status-late {
          background-color: #fee2e2;
          color: #b42318;
          padding: 4px 8px;
          border-radius: 4px;
          font-weight: 600
        }
        
        #late-tab .status-early {
          background-color: #fffbeb;
          color: #b45309;
          padding: 4px 8px;
          border-radius: 4px;
          font-weight: 600
        }
        
        #late-tab .status-adherent {
          background-color: #f0f9ff;
          color: #0c4a6e;
          padding: 4px 8px;
          border-radius: 4px;
          font-weight: 600
        }
        
        #late-tab .status-awol {
          background-color: #f3e8ff;
          color: #7e22ce;
          padding: 4px 8px;
          border-radius: 4px;
          font-weight: 600
        }
      </style>
      
      <div class="card">
        <h2 class="section-title">Late Report Configuration</h2>
        <div class="controls">
          <div>
            <label for="lateBuSelect">Business Unit</label>
            <div id="lateBuDropdown" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label for="lateMuSelect">Management Unit</label>
            <div id="lateMuDropdown" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label>Team</label>
            <div id="lateTeamDropdown" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label>User</label>
            <div id="lateUserDropdown" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label for="lateStartDate">Start Date</label>
            <input type="date" id="lateStartDate" />
          </div>
          <div>
            <label for="lateEndDate">End Date</label>
            <input type="date" id="lateEndDate" />
          </div>
          <div>
            <label for="lateThreshold">Late Threshold (seconds)</label>
            <input type="number" id="lateThreshold" value="30" min="0" step="1" />
            <div class="muted">Seconds allowed before being marked late</div>
          </div>
        </div>
        <button id="generateLateReportBtn" class="full-width-btn">Generate Late Report</button>
      </div>

      <div id="lateResults" class="card" style="display:none;">
        <div class="table-controls">
          <div class="sort-controls">
            <label for="lateSort">Sort by:</label>
            <select id="lateSort">
              <option value="userName">User</option>
              <option value="date">Date</option>
              <option value="status">Status</option>
              <option value="durationLate">Duration Late</option>
            </select>
            <select id="lateSortOrder">
              <option value="asc">Ascending</option>
              <option value="desc">Descending</option>
            </select>
          </div>
        </div>
        
        <div class="export-buttons">
          <button id="exportLateReportBtn" class="export-btn">Export Late Report to CSV</button>
        </div>
        
        <div id="lateResultsContent"></div>
      </div>
    </div>

    <!-- TIME OWED TAB -->
    <div id="timeowed-tab" class="tab-content">
      <style>
        /* Time Owed Tab Specific Styles */
        #timeowed-tab .status-logged-out-early {
          background-color: #fef3c7;
          color: #92400e;
          padding: 4px 8px;
          border-radius: 4px;
          font-weight: 600
        }
        
        #timeowed-tab .status-time-owed {
          background-color: #fee2e2;
          color: #dc2626;
          padding: 4px 8px;
          border-radius: 4px;
          font-weight: 600
        }
        
        #timeowed-tab .status-completed {
          background-color: #dcfce7;
          color: #166534;
          padding: 4px 8px;
          border-radius: 4px;
          font-weight: 600
        }
        
        #timeowed-tab .status-awol {
          background-color: #f3e8ff;
          color: #7e22ce;
          padding: 4px 8px;
          border-radius: 4px;
          font-weight: 600
        }
      </style>
      
      <div class="card">
        <h2 class="section-title">Time Owed Report</h2>
        <div class="controls">
          <div>
            <label for="timeOwedBuSelect">Business Unit</label>
            <div id="timeOwedBuDropdown" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label for="timeOwedMuSelect">Management Unit</label>
            <div id="timeOwedMuDropdown" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label>Team</label>
            <div id="timeOwedTeamDropdown" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label>User</label>
            <div id="timeOwedUserDropdown" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label for="timeOwedStartDate">Start Date</label>
            <input type="date" id="timeOwedStartDate" />
          </div>
          <div>
            <label for="timeOwedEndDate">End Date</label>
            <input type="date" id="timeOwedEndDate" />
          </div>
        </div>
        <button id="generateTimeOwedReportBtn" class="full-width-btn">Generate Time Owed Report</button>
      </div>

      <div id="timeOwedResults" class="card" style="display:none;">
        <div class="table-controls">
          <div class="sort-controls">
            <label for="timeOwedSort">Sort by:</label>
            <select id="timeOwedSort">
              <option value="userName">User</option>
              <option value="date">Date</option>
              <option value="status">Status</option>
              <option value="timeOwed">Time Owed</option>
            </select>
            <select id="timeOwedSortOrder">
              <option value="asc">Ascending</option>
              <option value="desc">Descending</option>
            </select>
          </div>
        </div>
        
        <div class="export-buttons">
          <button id="exportTimeOwedReportBtn" class="export-btn">Export Time Owed Report to CSV</button>
        </div>
        
        <div id="timeOwedResultsContent"></div>
      </div>
    </div>
  </div>

  <script>
    // ===== OAuth Config =====
    const clientId = 'fe305808-b368-4547-8af9-325d28d552bb';
    const redirectUri = 'https://gmcglynn88.github.io/Late_Break-Report/';
    const oauthUrl = 'https://login.mypurecloud.ie/oauth/authorize?client_id=' + encodeURIComponent(clientId) + '&response_type=token&redirect_uri=' + encodeURIComponent(redirectUri);
    const apiBase = 'https://api.mypurecloud.ie';

    let accessToken = null;
    let allUsers = [];
    let usersById = {};
    let allTeams = [];
    let teamsById = {};
    let userTeams = {};
    let activityCodesByBuId = {};
    let businessUnits = [];
    
    // Data storage
    let currentScheduleData = [];
    let currentActualActivityData = [];
    let currentOvertimeData = [];
    let currentAbsenceData = [];
    let currentTimeOwedData = [];
    let currentDisplayedData = {
      schedule: [],
      actual: [],
      overtime: [],
      absence: [],
      late: [],
      timeowed: []
    };
    
    // Drill-down state
    let currentDrillDown = {
      type: null,
      filter: null
    };
    
    // View state
    let currentAbsenceView = 'summary';
    
    // Checkbox dropdown instances
    const dropdowns = {};

    // ===== UTILITY FUNCTIONS (Common to all tabs) =====
    function formatDate(dateString) {
      if (!dateString) return '';
      
      if (dateString.match(/^\d{2}-\d{2}-\d{4}$/)) {
        return dateString;
      }
      
      if (dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
        const parts = dateString.split('-');
        return `${parts[2]}-${parts[1]}-${parts[0]}`;
      }
      
      if (dateString instanceof Date) {
        const day = String(dateString.getDate()).padStart(2, '0');
        const month = String(dateString.getMonth() + 1).padStart(2, '0');
        const year = dateString.getFullYear();
        return `${day}-${month}-${year}`;
      }
      
      return dateString;
    }

    function convertToApiFormat(dateStr) {
      if (dateStr.match(/^\d{2}-\d{2}-\d{4}$/)) {
        const parts = dateStr.split('-');
        return `${parts[2]}-${parts[1]}-${parts[0]}`;
      }
      return dateStr;
    }

    function isToday(dateStr) {
      const inputDate = new Date(dateStr);
      const today = new Date();
      return inputDate.getDate() === today.getDate() &&
             inputDate.getMonth() === today.getMonth() &&
             inputDate.getFullYear() === today.getFullYear();
    }

    function getEndDateIso(dateStr) {
      const dateApi = convertToApiFormat(dateStr);
      if (isToday(dateApi)) {
        return new Date().toISOString();
      } else {
        return `${dateApi}T23:59:59.999Z`;
      }
    }

    function getCurrentWeekDates() {
      const today = new Date();
      const startOfWeek = new Date(today);
      startOfWeek.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1));
      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(startOfWeek.getDate() + 6);
      
      return {
        start: formatDate(startOfWeek.toISOString().split('T')[0]),
        end: formatDate(endOfWeek.toISOString().split('T')[0])
      };
    }

    function formatTime(d) {
      if (!d) return 'All Day';
      return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function formatDuration(mins) {
      if (mins == null || isNaN(mins)) return '';
      const total = Math.max(0, Math.round(mins));
      const h = Math.floor(total / 60);
      const m = total % 60;
      if (h === 0) return `${m}m`;
      if (m === 0) return `${h}h`;
      return `${h}h ${m}m`;
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    function showMessage(msg, type = 'error') {
      const box = document.getElementById('messageContainer');
      box.innerHTML = `<div class="${type}-message">${msg}</div>`;
      box.style.display = 'block';
      if (type === 'success' || type === 'info') {
        setTimeout(() => { box.style.display = 'none'; }, 6000);
      }
    }

    function authorizedFetch(url, options = {}) {
      const headers = {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json',
        ...(options.headers || {})
      };
      return fetch(url, { ...options, headers });
    }

    async function authorizedFetchJson(url, options = {}) {
      const response = await authorizedFetch(url, options);
      if (!response.ok) {
        throw new Error(`Error calling ${url}: ${response.status} ${response.statusText}`);
      }
      return response.json();
    }

    async function fetchAllPages(url) {
      let allItems = [];
      let pageNumber = 1;
      let hasMorePages = true;

      while (hasMorePages) {
        const response = await authorizedFetch(`${url}?pageNumber=${pageNumber}&pageSize=100`);
        if (!response.ok) {
          throw new Error(`Error fetching data: ${response.status} ${response.statusText}`);
        }
        const data = await response.json();
        allItems = allItems.concat(data.entities || []);
        if (data.pageCount && data.pageCount > pageNumber) {
          pageNumber++;
        } else {
          hasMorePages = false;
        }
      }
      return allItems;
    }

    // ===== CHECKBOX DROPDOWN FUNCTIONS (Common) =====
    function createCheckboxDropdown(containerId, { placeholder, searchPlaceholder, onSelectionChange } = {}){
      const root = document.getElementById(containerId);
      if (!root) {
        console.error(`Container ${containerId} not found`);
        return null;
      }
      
      root.innerHTML = '';

      const trigger = document.createElement('div');
      trigger.className = 'cd-trigger';
      trigger.innerHTML = `<span class="label">${placeholder}</span><span class="count">0 selected</span>`;
      root.appendChild(trigger);

      const panel = document.createElement('div');
      panel.className = 'cd-panel';
      panel.innerHTML = `
        <div class="cd-header">
          <input type="text" class="cd-search" placeholder="${searchPlaceholder}" />
          <div class="cd-actions">
            <button type="button" data-cd="clear">Clear</button>
          </div>
        </div>
        <div class="cd-selectall">
          <label><input type="checkbox" data-cd="selectall"/> Select all</label>
        </div>
        <div class="cd-list"></div>
        <div class="cd-footer">
          <span data-cd="summary">0 selected</span>
          <span>Click outside to close</span>
        </div>
      `;
      root.appendChild(panel);

      const list = panel.querySelector('.cd-list');
      const search = panel.querySelector('.cd-search');
      const clearBtn = panel.querySelector('[data-cd="clear"]');
      const selectAll = panel.querySelector('[data-cd="selectall"]');
      const summary = panel.querySelector('[data-cd="summary"]');

      let options = [];
      let selected = new Set();

      function render(filter=''){
        const ft = filter.trim().toLowerCase();
        list.innerHTML = '';
        const filtered = !ft ? options : options.filter(o => (o.label||'').toLowerCase().includes(ft));
        if (!filtered.length){ list.innerHTML = `<div class="cd-item" style="color:#6C757D">No matches</div>`; return; }
        filtered.forEach(o=>{
          const id = `${containerId}__${o.value}`;
          const row = document.createElement('div');
          row.className = 'cd-item';
          row.innerHTML = `
            <label for="${id}">
              <input type="checkbox" id="${id}" value="${o.value}" ${selected.has(o.value)?'checked':''}/>
              <span>${o.label || o.value}</span>
            </label>
          `;
          const cb = row.querySelector('input');
          cb.addEventListener('change', ()=>{
            if (cb.checked) selected.add(o.value); else selected.delete(o.value);
            updateSummary(); updateSelectAllState();
            if (onSelectionChange) {
              onSelectionChange(Array.from(selected));
            }
          });
          list.appendChild(row);
        });
      }
      function updateSummary(){
        trigger.querySelector('.count').textContent = `${selected.size} selected`;
        summary.textContent = `${selected.size} selected`;
      }
      function updateSelectAllState(){
        const total = options.length, count = selected.size;
        selectAll.indeterminate = count>0 && count<total;
        selectAll.checked = total>0 && count===total;
      }

      trigger.addEventListener('click', ()=>{ panel.classList.toggle('open'); search.focus(); });
      document.addEventListener('click', (e)=>{ if (!root.contains(e.target)) panel.classList.remove('open'); });
      search.addEventListener('input', ()=> render(search.value));
      clearBtn.addEventListener('click', ()=>{ 
        selected.clear(); 
        render(search.value); 
        updateSummary(); 
        updateSelectAllState();
        if (onSelectionChange) {
          onSelectionChange([]);
        }
      });
      selectAll.addEventListener('change', ()=>{
        if (selectAll.checked) {
          options.forEach(o=> selected.add(o.value));
        } else {
          selected.clear();
        }
        render(search.value); 
        updateSummary();
        if (onSelectionChange) {
          onSelectionChange(Array.from(selected));
        }
      });

      function setOptions(newOptions){
        options = newOptions || [];
        selected.forEach(v=>{ if (!options.some(o=>o.value===v)) selected.delete(v); });
        render(search.value); updateSummary(); updateSelectAllState();
      }
      function getSelectedValues(){ return Array.from(selected); }
      function clearSelection() { 
        selected.clear(); 
        render(search.value); 
        updateSummary(); 
        updateSelectAllState();
      }

      render('');
      return { setOptions, getSelectedValues, clearSelection };
    }

    // ===== ACTIVITY CODE FUNCTIONS (Common) =====
    async function loadActivityCodes(businessUnitId) {
      try {
        console.log(`Loading activity codes for business unit: ${businessUnitId}`);
        const activityCodesResponse = await authorizedFetchJson(
          `${apiBase}/api/v2/workforcemanagement/businessunits/${encodeURIComponent(businessUnitId)}/activitycodes`
        );
        
        let activityCodes = [];
        
        if (activityCodesResponse.activityCodes && typeof activityCodesResponse.activityCodes === 'object') {
          activityCodes = Object.values(activityCodesResponse.activityCodes);
        } else if (Array.isArray(activityCodesResponse.entities)) {
          activityCodes = activityCodesResponse.entities;
        } else if (Array.isArray(activityCodesResponse)) {
          activityCodes = activityCodesResponse;
        } else {
          for (const key in activityCodesResponse) {
            if (Array.isArray(activityCodesResponse[key])) {
              activityCodes = activityCodesResponse[key];
              break;
            }
          }
        }
        
        const activityCodeMap = {};
        activityCodes.forEach(code => {
          if (code && code.id) {
            activityCodeMap[code.id] = {
              name: code.name ? code.name.trim() : code.id,
              category: code.category || 'Unknown'
            };
          }
        });
        
        activityCodesByBuId[businessUnitId] = activityCodeMap;
        return activityCodeMap;
      } catch (err) {
        console.error('Error loading activity codes:', err);
        activityCodesByBuId[businessUnitId] = {};
        return {};
      }
    }

    function getActivityName(businessUnitId, activityCodeId) {
      if (!businessUnitId || !activityCodeId) return 'Unknown Activity';
      
      const systemCodes = {
        '0': 'On Queue',
        '1': 'Break', 
        '2': 'Meal',
        '3': 'Meeting',
        '4': 'Off Queue',
        '5': 'Time Off',
        '6': 'Training',
        '7': 'Agent Unavailable'
      };
      
      if (systemCodes[activityCodeId]) {
        return systemCodes[activityCodeId];
      }
      
      const activityCodes = activityCodesByBuId[businessUnitId];
      
      if (activityCodes && activityCodes[activityCodeId]) {
        return activityCodes[activityCodeId].name;
      }
      
      return activityCodeId;
    }

    function getActivityCategory(businessUnitId, activityCodeId) {
      if (!businessUnitId || !activityCodeId) return 'Unknown';
      
      const systemCodeCategories = {
        '0': 'OnQueueWork',
        '1': 'Break', 
        '2': 'Meal',
        '3': 'Meeting',
        '4': 'OffQueueWork',
        '5': 'TimeOff',
        '6': 'Training',
        '7': 'Unavailable'
      };
      
      if (systemCodeCategories[activityCodeId]) {
        return systemCodeCategories[activityCodeId];
      }
      
      const activityCodes = activityCodesByBuId[businessUnitId];
      
      if (activityCodes && activityCodes[activityCodeId]) {
        return activityCodes[activityCodeId].category;
      }
      
      return 'Unknown';
    }

    // ===== CORS PROXY FUNCTIONS (Common) =====
    async function fetchWithCorsProxy(url) {
      const proxyUrls = [
        `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
        `https://corsproxy.io/?${encodeURIComponent(url)}`,
        `https://cors-anywhere.herokuapp.com/${url}`,
        `https://cors.bridged.cc/${url}`
      ];
      
      let lastError = null;
      
      for (const proxyUrl of proxyUrls) {
        try {
          const response = await fetch(proxyUrl, {
            method: 'GET',
            headers: {
              'Accept': 'application/json',
            },
            timeout: 10000
          });
          
          if (response.ok) {
            const data = await response.json();
            return data;
          } else {
            lastError = new Error(`Proxy returned status: ${response.status}`);
          }
        } catch (err) {
          lastError = err;
          continue;
        }
      }
      
      try {
        const response = await fetch(url, {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          return data;
        } else {
          throw new Error(`Direct fetch failed with status: ${response.status}`);
        }
      } catch (directErr) {
        throw new Error(`All CORS proxies failed and direct fetch also failed: ${lastError?.message || directErr.message}`);
      }
    }

    // ===== INITIALIZATION FUNCTIONS =====
    document.addEventListener('DOMContentLoaded', () => {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      const qparams = new URLSearchParams(window.location.search);

      const oauthError = params.get('error') || qparams.get('error');
      const oauthErrorDesc = params.get('error_description') || qparams.get('error_description');

      if (oauthError) {
        const msg = document.getElementById('auth-message');
        msg.textContent = `OAuth error: ${oauthErrorDesc || oauthError}`;
        msg.className = 'error-message';
        return;
      }

      accessToken = params.get('access_token');

      if (accessToken) {
        sessionStorage.setItem('purecloud_token', accessToken);
        window.location.hash = '';
        initializeApplication();
      } else if (sessionStorage.getItem('purecloud_token')) {
        accessToken = sessionStorage.getItem('purecloud_token');
        initializeApplication();
      } else {
        window.location.href = oauthUrl;
      }
    });

    async function initializeApplication() {
      document.getElementById('auth-message').textContent = 'Authenticated successfully!';
      document.getElementById('authCard').style.display = 'none';
      document.getElementById('appContent').style.display = 'block';

      initializeTabs();
      initializeDropdowns();
      initializeEventListeners();
      initializeViewToggle();
      
      populateInitialData();
    }

    function initializeTabs() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          tab.classList.add('active');
          const tabId = tab.getAttribute('data-tab');
          document.getElementById(`${tabId}-tab`).classList.add('active');
        });
      });
    }

    function initializeDropdowns() {
      // Schedule tab dropdowns
      dropdowns.businessUnit = createCheckboxDropdown('businessUnitDropdown', { 
        placeholder: 'Select business units', 
        searchPlaceholder: 'Search business units...',
        onSelectionChange: handleBusinessUnitChange
      });
      
      dropdowns.managementUnit = createCheckboxDropdown('managementUnitDropdown', { 
        placeholder: 'Select management units', 
        searchPlaceholder: 'Search management units...',
        onSelectionChange: handleManagementUnitChange
      });
      
      dropdowns.team = createCheckboxDropdown('teamDropdown', { 
        placeholder: 'Select teams', 
        searchPlaceholder: 'Search teams...' 
      });
      
      dropdowns.user = createCheckboxDropdown('userDropdown', { 
        placeholder: 'Select users', 
        searchPlaceholder: 'Search users...' 
      });
      
      // Actual Activity tab dropdowns
      dropdowns.actualBu = createCheckboxDropdown('actualBuDropdown', { 
        placeholder: 'Select business units', 
        searchPlaceholder: 'Search business units...',
        onSelectionChange: (selected) => handleAnalyticsBuChange(selected, 'actual')
      });
      
      dropdowns.actualMu = createCheckboxDropdown('actualMuDropdown', { 
        placeholder: 'Select management units', 
        searchPlaceholder: 'Search management units...',
        onSelectionChange: (selected) => handleActualManagementUnitChange(selected)
      });
      
      dropdowns.actualTeam = createCheckboxDropdown('actualTeamDropdown', { 
        placeholder: 'Select teams', 
        searchPlaceholder: 'Search teams...' 
      });
      
      dropdowns.actualUser = createCheckboxDropdown('actualUserDropdown', { 
        placeholder: 'Select users', 
        searchPlaceholder: 'Search users...' 
      });
      
      // Overtime tab dropdowns
      dropdowns.overtimeBu = createCheckboxDropdown('overtimeBuDropdown', { 
        placeholder: 'Select business units', 
        searchPlaceholder: 'Search business units...',
        onSelectionChange: (selected) => handleAnalyticsBuChange(selected, 'overtime')
      });
      
      dropdowns.overtimeMu = createCheckboxDropdown('overtimeMuDropdown', { 
        placeholder: 'Select management units', 
        searchPlaceholder: 'Search management units...',
        onSelectionChange: (selected) => handleOvertimeManagementUnitChange(selected)
      });
      
      dropdowns.overtimeTeam = createCheckboxDropdown('overtimeTeamDropdown', { 
        placeholder: 'Select teams', 
        searchPlaceholder: 'Search teams...' 
      });
      
      // Absence tab dropdowns
      dropdowns.absenceBu = createCheckboxDropdown('absenceBuDropdown', { 
        placeholder: 'Select business units', 
        searchPlaceholder: 'Search business units...',
        onSelectionChange: (selected) => handleAnalyticsBuChange(selected, 'absence')
      });
      
      dropdowns.absenceMu = createCheckboxDropdown('absenceMuDropdown', { 
        placeholder: 'Select management units', 
        searchPlaceholder: 'Search management units...',
        onSelectionChange: (selected) => handleAbsenceManagementUnitChange(selected)
      });
      
      dropdowns.absenceTeam = createCheckboxDropdown('absenceTeamDropdown', { 
        placeholder: 'Select teams', 
        searchPlaceholder: 'Search teams...' 
      });
      
      // Late Report tab dropdowns
      dropdowns.lateBu = createCheckboxDropdown('lateBuDropdown', { 
        placeholder: 'Select business units', 
        searchPlaceholder: 'Search business units...',
        onSelectionChange: (selected) => handleAnalyticsBuChange(selected, 'late')
      });
      
      dropdowns.lateMu = createCheckboxDropdown('lateMuDropdown', { 
        placeholder: 'Select management units', 
        searchPlaceholder: 'Search management units...',
        onSelectionChange: (selected) => handleLateManagementUnitChange(selected)
      });
      
      dropdowns.lateTeam = createCheckboxDropdown('lateTeamDropdown', { 
        placeholder: 'Select teams', 
        searchPlaceholder: 'Search teams...' 
      });
      
      dropdowns.lateUser = createCheckboxDropdown('lateUserDropdown', { 
        placeholder: 'Select users', 
        searchPlaceholder: 'Search users...' 
      });
      
      // Time Owed tab dropdowns
      dropdowns.timeOwedBu = createCheckboxDropdown('timeOwedBuDropdown', { 
        placeholder: 'Select business units', 
        searchPlaceholder: 'Search business units...',
        onSelectionChange: (selected) => handleAnalyticsBuChange(selected, 'timeowed')
      });
      
      dropdowns.timeOwedMu = createCheckboxDropdown('timeOwedMuDropdown', { 
        placeholder: 'Select management units', 
        searchPlaceholder: 'Search management units...',
        onSelectionChange: (selected) => handleTimeOwedManagementUnitChange(selected)
      });
      
      dropdowns.timeOwedTeam = createCheckboxDropdown('timeOwedTeamDropdown', { 
        placeholder: 'Select teams', 
        searchPlaceholder: 'Search teams...' 
      });
      
      dropdowns.timeOwedUser = createCheckboxDropdown('timeOwedUserDropdown', { 
        placeholder: 'Select users', 
        searchPlaceholder: 'Search users...' 
      });
      
      // Activity filter dropdowns
      dropdowns.activityFilter = createCheckboxDropdown('activityFilterDropdown', { 
        placeholder: 'Filter by activity type', 
        searchPlaceholder: 'Search activities...' 
      });
      
      dropdowns.actualActivityFilter = createCheckboxDropdown('actualActivityFilterDropdown', { 
        placeholder: 'Filter by activity type', 
        searchPlaceholder: 'Search activities...' 
      });
      
      dropdowns.overtimeActivityFilter = createCheckboxDropdown('overtimeActivityFilterDropdown', { 
        placeholder: 'Filter by overtime activity', 
        searchPlaceholder: 'Search overtime activities...' 
      });
      
      dropdowns.absenceActivityFilter = createCheckboxDropdown('absenceActivityFilterDropdown', { 
        placeholder: 'Filter by absence type', 
        searchPlaceholder: 'Search absence types...' 
      });
    }

    async function populateInitialData() {
      try {
        const [users, businessUnitsResponse, teams] = await Promise.all([
          fetchAllPages(`${apiBase}/api/v2/users`),
          authorizedFetchJson(`${apiBase}/api/v2/workforcemanagement/businessunits`),
          fetchAllPages(`${apiBase}/api/v2/teams`)
        ]);

        allUsers = (users || []).filter(u => !u.deleted);
        usersById = {};
        allUsers.forEach(u => { 
          usersById[u.id] = u;
          u.teamNames = 'No Team';
        });
        
        businessUnits = businessUnitsResponse.entities || businessUnitsResponse.businessUnits || businessUnitsResponse || [];
        
        allTeams = teams || [];
        teamsById = {};
        allTeams.forEach(t => { teamsById[t.id] = t; });

        await loadUserTeamMemberships();

        populateUserDropdown(allUsers);
        populateBusinessUnitDropdown(businessUnits);
        populateTeamDropdown(allTeams);
        
        const currentWeek = getCurrentWeekDates();
        
        document.getElementById('startDate').value = currentWeek.start;
        document.getElementById('endDate').value = currentWeek.end;
        document.getElementById('actualStartDate').value = currentWeek.start;
        document.getElementById('actualEndDate').value = currentWeek.end;
        document.getElementById('overtimeStartDate').value = currentWeek.start;
        document.getElementById('overtimeEndDate').value = currentWeek.end;
        document.getElementById('absenceStartDate').value = currentWeek.start;
        document.getElementById('absenceEndDate').value = currentWeek.end;
        document.getElementById('lateStartDate').value = currentWeek.start;
        document.getElementById('lateEndDate').value = currentWeek.end;
        document.getElementById('timeOwedStartDate').value = currentWeek.start;
        document.getElementById('timeOwedEndDate').value = currentWeek.end;
        
        showMessage('Initial data loaded – set your filters and hit "Load Schedule".', 'info');
      } catch (err) {
        console.error('Error initialising app:', err);
        showMessage(`Error loading initial data: ${err.message}`, 'error');
      }
    }

    async function loadUserTeamMemberships() {
      const batchSize = 10;
      const teamBatches = [];
      
      for (let i = 0; i < allTeams.length; i += batchSize) {
        teamBatches.push(allTeams.slice(i, i + batchSize));
      }
      
      userTeams = {};
      allUsers.forEach(user => {
        userTeams[user.id] = [];
      });
      
      for (const batch of teamBatches) {
        await Promise.all(
          batch.map(async (team) => {
            try {
              const members = await getTeamMembers(team.id);
              members.forEach(member => {
                if (userTeams[member.id]) {
                  userTeams[member.id].push(team);
                }
              });
            } catch (err) {
              console.error(`Error loading members for team ${team.name}:`, err);
            }
          })
        );
      }
      
      allUsers.forEach(user => {
        const teams = userTeams[user.id] || [];
        if (teams.length > 0) {
          user.teamNames = teams.map(team => team.name).join(', ');
        } else {
          user.teamNames = 'No Team';
        }
      });
    }

    async function getTeamMembers(teamId) {
      try {
        const teamMembersResponse = await authorizedFetchJson(
          `${apiBase}/api/v2/teams/${encodeURIComponent(teamId)}/members`
        );
        const members = teamMembersResponse.entities || teamMembersResponse.members || [];
        
        return members.map(member => ({
          id: member.id,
          name: member.name
        }));
      } catch (err) {
        console.error(`Error fetching team members for team ${teamId}:`, err);
        return [];
      }
    }

    function populateUserDropdown(users) {
      const validUsers = users
        .filter(u => u.name && u.name.trim() && u.name !== 'Unknown User')
        .map(u => ({ 
          value: u.id, 
          label: u.name || u.email || 'Unknown User',
          teamNames: u.teamNames || 'No Team'
        }))
        .sort((a,b)=>a.label.localeCompare(b.label));
      
      if (dropdowns.user) dropdowns.user.setOptions(validUsers);
      if (dropdowns.actualUser) dropdowns.actualUser.setOptions(validUsers);
      if (dropdowns.lateUser) dropdowns.lateUser.setOptions(validUsers);
      if (dropdowns.timeOwedUser) dropdowns.timeOwedUser.setOptions(validUsers);
    }

    function populateBusinessUnitDropdown(businessUnits) {
      const buOpts = businessUnits
        .map(bu => ({ value: bu.id, label: bu.name || bu.id }))
        .sort((a,b)=>a.label.localeCompare(b.label));
      
      if (dropdowns.businessUnit) dropdowns.businessUnit.setOptions(buOpts);
      if (dropdowns.actualBu) dropdowns.actualBu.setOptions(buOpts);
      if (dropdowns.overtimeBu) dropdowns.overtimeBu.setOptions(buOpts);
      if (dropdowns.absenceBu) dropdowns.absenceBu.setOptions(buOpts);
      if (dropdowns.lateBu) dropdowns.lateBu.setOptions(buOpts);
      if (dropdowns.timeOwedBu) dropdowns.timeOwedBu.setOptions(buOpts);
    }

    function populateTeamDropdown(teams) {
      const teamOpts = (teams||[])
        .map(t => ({ value: t.id, label: t.name }))
        .sort((a,b)=>a.label.localeCompare(b.label));
      
      if (dropdowns.team) dropdowns.team.setOptions(teamOpts);
      if (dropdowns.actualTeam) dropdowns.actualTeam.setOptions(teamOpts);
      if (dropdowns.overtimeTeam) dropdowns.overtimeTeam.setOptions(teamOpts);
      if (dropdowns.absenceTeam) dropdowns.absenceTeam.setOptions(teamOpts);
      if (dropdowns.lateTeam) dropdowns.lateTeam.setOptions(teamOpts);
      if (dropdowns.timeOwedTeam) dropdowns.timeOwedTeam.setOptions(teamOpts);
    }

    // ===== BUSINESS UNIT CHANGE HANDLERS =====
    async function handleBusinessUnitChange(selectedBuIds) {
      if (dropdowns.managementUnit) {
        dropdowns.managementUnit.clearSelection();
        dropdowns.managementUnit.setOptions([]);
      }

      if (selectedBuIds.length === 0) return;

      try {
        await loadActivityCodes(selectedBuIds[0]);
        
        // Fetch ONLY the management units for the selected business unit
        const muResponse = await authorizedFetchJson(
          `${apiBase}/api/v2/workforcemanagement/businessunits/${encodeURIComponent(selectedBuIds[0])}/managementunits`
        );
        
        let managementUnits = [];
        
        // Handle different response structures
        if (muResponse.entities) {
          managementUnits = muResponse.entities;
        } else if (muResponse.managementUnits) {
          managementUnits = muResponse.managementUnits;
        } else if (Array.isArray(muResponse)) {
          managementUnits = muResponse;
        }
        
        const muOpts = managementUnits.map(mu => ({ 
          value: mu.id, 
          label: mu.name || mu.id 
        }));
        
        if (dropdowns.managementUnit) {
          dropdowns.managementUnit.setOptions(muOpts);
        }
        
        // Clear user dropdown when BU changes
        if (dropdowns.user) {
          dropdowns.user.clearSelection();
          dropdowns.user.setOptions([]);
        }
      } catch (err) {
        console.error('Error loading management units:', err);
        showMessage(`Error loading management units: ${err.message}`, 'error');
      }
    }

    // Update all analytics BU change handlers to use the same pattern
    async function handleAnalyticsBuChange(selectedBuIds, tabType) {
      let muDropdown;
      switch(tabType) {
        case 'actual': muDropdown = dropdowns.actualMu; break;
        case 'overtime': muDropdown = dropdowns.overtimeMu; break;
        case 'absence': muDropdown = dropdowns.absenceMu; break;
        case 'late': muDropdown = dropdowns.lateMu; break;
        case 'timeowed': muDropdown = dropdowns.timeOwedMu; break;
      }
      
      if (muDropdown) {
        muDropdown.clearSelection();
        muDropdown.setOptions([]);
      }

      if (selectedBuIds.length === 0) return;

      try {
        await loadActivityCodes(selectedBuIds[0]);
        
        // Fetch management units for the selected business unit
        const muResponse = await authorizedFetchJson(
          `${apiBase}/api/v2/workforcemanagement/businessunits/${encodeURIComponent(selectedBuIds[0])}/managementunits`
        );
        
        let managementUnits = [];
        
        if (muResponse.entities) {
          managementUnits = muResponse.entities;
        } else if (muResponse.managementUnits) {
          managementUnits = muResponse.managementUnits;
        } else if (Array.isArray(muResponse)) {
          managementUnits = muResponse;
        }
        
        const muOpts = managementUnits.map(mu => ({ 
          value: mu.id, 
          label: mu.name || mu.id 
        }));
        
        if (muDropdown) {
          muDropdown.setOptions(muOpts);
        }
        
        // Clear user dropdowns when BU changes
        if (tabType === 'actual' && dropdowns.actualUser) {
          dropdowns.actualUser.clearSelection();
          dropdowns.actualUser.setOptions([]);
        }
        if (tabType === 'late' && dropdowns.lateUser) {
          dropdowns.lateUser.clearSelection();
          dropdowns.lateUser.setOptions([]);
        }
        if (tabType === 'timeowed' && dropdowns.timeOwedUser) {
          dropdowns.timeOwedUser.clearSelection();
          dropdowns.timeOwedUser.setOptions([]);
        }
      } catch (err) {
        console.error(`Error loading management units for ${tabType}:`, err);
        showMessage(`Error loading management units: ${err.message}`, 'error');
      }
    }

    // ===== MANAGEMENT UNIT CHANGE HANDLERS =====
    async function handleManagementUnitChange(selectedMuIds) {
      if (selectedMuIds.length === 0) {
        if (dropdowns.user) {
          dropdowns.user.setOptions([]);
        }
        return;
      }

      try {
        const muUsersResponse = await authorizedFetchJson(
          `${apiBase}/api/v2/workforcemanagement/managementunits/${encodeURIComponent(selectedMuIds[0])}/users`
        );
        
        const muUsers = muUsersResponse.entities || muUsersResponse.users || [];
        
        const filteredUsers = allUsers.filter(user => 
          muUsers.some(muUser => muUser.id === user.id)
        );
        
        const userOpts = filteredUsers
          .map(u => ({ 
            value: u.id, 
            label: u.name || u.email || 'Unknown User',
            teamNames: u.teamNames || 'No Team'
          }))
          .sort((a,b)=>a.label.localeCompare(b.label));
        
        if (dropdowns.user) {
          dropdowns.user.setOptions(userOpts);
        }
      } catch (err) {
        console.error('Error loading MU users:', err);
        showMessage(`Error loading users: ${err.message}`, 'error');
      }
    }

    async function handleActualManagementUnitChange(selectedMuIds) {
      if (selectedMuIds.length === 0) {
        if (dropdowns.actualUser) {
          dropdowns.actualUser.setOptions([]);
        }
        return;
      }

      try {
        const muUsersResponse = await authorizedFetchJson(
          `${apiBase}/api/v2/workforcemanagement/managementunits/${encodeURIComponent(selectedMuIds[0])}/users`
        );
        
        const muUsers = muUsersResponse.entities || muUsersResponse.users || [];
        
        const filteredUsers = allUsers.filter(user => 
          muUsers.some(muUser => muUser.id === user.id)
        );
        
        const userOpts = filteredUsers
          .map(u => ({ 
            value: u.id, 
            label: u.name || u.email || 'Unknown User',
            teamNames: u.teamNames || 'No Team'
          }))
          .sort((a,b)=>a.label.localeCompare(b.label));
        
        if (dropdowns.actualUser) {
          dropdowns.actualUser.setOptions(userOpts);
        }
      } catch (err) {
        console.error('Error loading MU users for actual activity:', err);
      }
    }

    async function handleOvertimeManagementUnitChange(selectedMuIds) {
      if (selectedMuIds.length === 0) {
        return;
      }
      // Overtime doesn't need user dropdown
    }

    async function handleAbsenceManagementUnitChange(selectedMuIds) {
      if (selectedMuIds.length === 0) {
        return;
      }
      // Absence doesn't need user dropdown
    }

    async function handleLateManagementUnitChange(selectedMuIds) {
      if (selectedMuIds.length === 0) {
        if (dropdowns.lateUser) {
          dropdowns.lateUser.setOptions([]);
        }
        return;
      }

      try {
        const muUsersResponse = await authorizedFetchJson(
          `${apiBase}/api/v2/workforcemanagement/managementunits/${encodeURIComponent(selectedMuIds[0])}/users`
        );
        
        const muUsers = muUsersResponse.entities || muUsersResponse.users || [];
        
        const filteredUsers = allUsers.filter(user => 
          muUsers.some(muUser => muUser.id === user.id)
        );
        
        const userOpts = filteredUsers
          .map(u => ({ 
            value: u.id, 
            label: u.name || u.email || 'Unknown User',
            teamNames: u.teamNames || 'No Team'
          }))
          .sort((a,b)=>a.label.localeCompare(b.label));
        
        if (dropdowns.lateUser) {
          dropdowns.lateUser.setOptions(userOpts);
        }
      } catch (err) {
        console.error('Error loading MU users for late report:', err);
      }
    }

    async function handleTimeOwedManagementUnitChange(selectedMuIds) {
      if (selectedMuIds.length === 0) {
        if (dropdowns.timeOwedUser) {
          dropdowns.timeOwedUser.setOptions([]);
        }
        return;
      }

      try {
        const muUsersResponse = await authorizedFetchJson(
          `${apiBase}/api/v2/workforcemanagement/managementunits/${encodeURIComponent(selectedMuIds[0])}/users`
        );
        
        const muUsers = muUsersResponse.entities || muUsersResponse.users || [];
        
        const filteredUsers = allUsers.filter(user => 
          muUsers.some(muUser => muUser.id === user.id)
        );
        
        const userOpts = filteredUsers
          .map(u => ({ 
            value: u.id, 
            label: u.name || u.email || 'Unknown User',
            teamNames: u.teamNames || 'No Team'
          }))
          .sort((a,b)=>a.label.localeCompare(b.label));
        
        if (dropdowns.timeOwedUser) {
          dropdowns.timeOwedUser.setOptions(userOpts);
        }
      } catch (err) {
        console.error('Error loading MU users for time owed:', err);
      }
    }

    // ===== SCHEDULE TAB FUNCTIONS =====
    function initializeEventListeners() {
      // Schedule tab
      document.getElementById('loadScheduleBtn').addEventListener('click', loadSchedule);
      document.getElementById('exportScheduleBtn').addEventListener('click', exportScheduleToCSV);
      
      // Actual Activity tab
      document.getElementById('loadActualActivityBtn').addEventListener('click', function() {
        loadActualActivity().catch(err => {
          console.error('Historical adherence failed:', err);
          showMessage(`Failed to load actual activity: ${err.message}`, 'error');
        });
      });
      document.getElementById('exportActualActivityBtn').addEventListener('click', exportActualActivityToCSV);
      
      // Overtime tab
      document.getElementById('analyzeOvertimeBtn').addEventListener('click', analyzeOvertime);
      document.getElementById('exportOvertimeSummaryBtn').addEventListener('click', exportOvertimeSummaryToCSV);
      document.getElementById('exportOvertimeDetailsBtn').addEventListener('click', exportOvertimeDetailsToCSV);
      
      // Absence tab
      document.getElementById('analyzeAbsenceBtn').addEventListener('click', analyzeAbsence);
      document.getElementById('exportAbsenceBtn').addEventListener('click', exportAbsenceToCSV);
      document.getElementById('exportAbsenceDetailsBtn').addEventListener('click', exportAbsenceDetailsToCSV);
      
      // Late Report tab
      document.getElementById('generateLateReportBtn').addEventListener('click', generateLateReport);
      document.getElementById('exportLateReportBtn').addEventListener('click', exportLateReportToCSV);
      
      // Time Owed tab
      document.getElementById('generateTimeOwedReportBtn').addEventListener('click', generateTimeOwedReport);
      document.getElementById('exportTimeOwedReportBtn').addEventListener('click', exportTimeOwedReportToCSV);
      
      initializeSorting();
    }

    function initializeViewToggle() {
      document.querySelectorAll('.view-toggle-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          currentAbsenceView = this.getAttribute('data-view');
          
          const thresholdDays = parseFloat(document.getElementById('absenceThreshold').value) || 2;
          const startDate = document.getElementById('absenceStartDate').value;
          const endDate = document.getElementById('absenceEndDate').value;
          
          if (currentAbsenceData.length > 0) {
            renderAbsenceResults(currentAbsenceData, thresholdDays, startDate, endDate);
          }
        });
      });
    }

    function initializeSorting() {
      document.getElementById('scheduleSort').addEventListener('change', () => applySorting('schedule'));
      document.getElementById('scheduleSortOrder').addEventListener('change', () => applySorting('schedule'));
      
      document.getElementById('actualSort').addEventListener('change', () => applySorting('actual'));
      document.getElementById('actualSortOrder').addEventListener('change', () => applySorting('actual'));
      
      document.getElementById('overtimeSort').addEventListener('change', () => applySorting('overtime'));
      document.getElementById('overtimeSortOrder').addEventListener('change', () => applySorting('overtime'));
      
      document.getElementById('absenceSort').addEventListener('change', () => applySorting('absence'));
      document.getElementById('absenceSortOrder').addEventListener('change', () => applySorting('absence'));
      
      document.getElementById('lateSort').addEventListener('change', () => applyLateReportSorting());
      document.getElementById('lateSortOrder').addEventListener('change', () => applyLateReportSorting());
      
      document.getElementById('timeOwedSort').addEventListener('change', () => applyTimeOwedSorting());
      document.getElementById('timeOwedSortOrder').addEventListener('change', () => applyTimeOwedSorting());
    }

    function applySorting(tabType) {
      let data, sortField, sortOrder;
      
      switch(tabType) {
        case 'schedule':
          data = currentDisplayedData.schedule;
          sortField = document.getElementById('scheduleSort').value;
          sortOrder = document.getElementById('scheduleSortOrder').value;
          break;
        case 'actual':
          data = currentDisplayedData.actual;
          sortField = document.getElementById('actualSort').value;
          sortOrder = document.getElementById('actualSortOrder').value;
          break;
        case 'overtime':
          data = currentDisplayedData.overtime;
          sortField = document.getElementById('overtimeSort').value;
          sortOrder = document.getElementById('overtimeSortOrder').value;
          break;
        case 'absence':
          data = currentDisplayedData.absence;
          sortField = document.getElementById('absenceSort').value;
          sortOrder = document.getElementById('absenceSortOrder').value;
          break;
      }
      
      if (!data || data.length === 0) return;
      
      const sortedData = [...data].sort((a, b) => {
        let aVal, bVal;
        
        switch(tabType) {
          case 'schedule':
          case 'actual':
            switch(sortField) {
              case 'date': aVal = a.date; bVal = b.date; break;
              case 'user': aVal = a.userName; bVal = b.userName; break;
              case 'activity': aVal = a.activityLabel; bVal = b.activityLabel; break;
              case 'duration': aVal = a.durationMinutes; bVal = b.durationMinutes; break;
            }
            break;
        case 'overtime':
        case 'absence':
          aVal = a[sortField]; bVal = b[sortField]; break;
        }
        
        if (typeof aVal === 'string') {
          aVal = aVal.toLowerCase();
          bVal = bVal.toLowerCase();
        }
        
        if (aVal < bVal) return sortOrder === 'asc' ? -1 : 1;
        if (aVal > bVal) return sortOrder === 'asc' ? 1 : -1;
        return 0;
      });
      
      currentDisplayedData[tabType] = sortedData;
      
      switch(tabType) {
        case 'schedule':
          renderScheduleTable(sortedData);
          break;
        case 'actual':
          renderActualActivityResults(sortedData, 
            document.getElementById('actualStartDate').value,
            document.getElementById('actualEndDate').value);
          break;
        case 'overtime':
          renderOvertimeResults(sortedData, 
            document.getElementById('overtimeStartDate').value,
            document.getElementById('overtimeEndDate').value);
          break;
        case 'absence':
          const thresholdDays = parseFloat(document.getElementById('absenceThreshold').value) || 2;
          const startDate = document.getElementById('absenceStartDate').value;
          const endDate = document.getElementById('absenceEndDate').value;
          renderAbsenceResults(sortedData, thresholdDays, startDate, endDate);
          break;
      }
    }

    async function loadSchedule() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.style.display = 'block';
      
      const buIds = dropdowns.businessUnit ? dropdowns.businessUnit.getSelectedValues() : [];
      const muIds = dropdowns.managementUnit ? dropdowns.managementUnit.getSelectedValues() : [];
      const userIds = dropdowns.user ? dropdowns.user.getSelectedValues() : [];
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;

      const startDateApi = convertToApiFormat(startDate);
      const endDateApi = convertToApiFormat(endDate);

      if (buIds.length === 0) {
        resultsDiv.innerHTML = `<div class="error-message">Please select a business unit.</div>`;
        return;
      }
      if (muIds.length === 0) {
        resultsDiv.innerHTML = `<div class="error-message">Please select a management unit.</div>`;
        return;
      }
      if (userIds.length === 0) {
        resultsDiv.innerHTML = `<div class="error-message">Please select at least one user.</div>`;
        return;
      }
      if (!startDate || !endDate) {
        resultsDiv.innerHTML = `<div class="error-message">Please select both a start and end date.</div>`;
        return;
      }
      if (endDate < startDate) {
        resultsDiv.innerHTML = `<div class="error-message">End date must be on or after the start date.</div>`;
        return;
      }

      const button = document.getElementById('loadScheduleBtn');
      const originalLabel = button.textContent;
      button.disabled = true;
      button.textContent = 'Loading schedule...';

      const startDateIso = `${startDateApi}T00:00:00.000Z`;
      const endDateIso = getEndDateIso(endDate);

      try {
        let allActivities = [];
        for (const userId of userIds) {
          try {
            const searchResult = await searchSchedules(muIds[0], userId, startDateIso, endDateIso, true);
            const activities = extractUserActivitiesFromSearchResult(searchResult, userId, buIds[0]);
            allActivities = allActivities.concat(activities);
          } catch (err) {
            console.error(`Error loading schedule for user ${userId}:`, err);
          }
        }
        
        currentScheduleData = allActivities;
        currentDisplayedData.schedule = [...allActivities];
        renderScheduleResults(resultsDiv, allActivities, userIds, startDateIso, endDateIso);
      } catch (err) {
        console.error('Error loading schedule:', err);
        resultsDiv.innerHTML = `<div class="error-message">Error loading schedule: ${err.message}</div>`;
      } finally {
        button.disabled = false;
        button.textContent = originalLabel;
      }
    }

    async function searchSchedules(managementUnitId, userId, startDateIso, endDateIso, loadFullWeeks) {
      const body = {
        userIds: [userId],
        startDate: startDateIso,
        endDate: endDateIso,
        loadFullWeeks: loadFullWeeks
      };

      const url = `${apiBase}/api/v2/workforcemanagement/managementunits/${encodeURIComponent(managementUnitId)}/schedules/search`;

      return authorizedFetchJson(url, {
        method: 'POST',
        body: JSON.stringify(body)
      });
    }

    function extractUserActivitiesFromSearchResult(response, userId, businessUnitId) {
      let userSchedule = null;

      if (response && response.userSchedules) {
        if (response.userSchedules[userId]) {
          userSchedule = response.userSchedules[userId];
        } else {
          const firstUserId = Object.keys(response.userSchedules)[0];
          userSchedule = response.userSchedules[firstUserId];
        }
      }

      const rows = [];

      if (userSchedule) {
        const shifts = Array.isArray(userSchedule.shifts) ? userSchedule.shifts : [];
        shifts.forEach(shift => {
          const shiftStartDate = shift.startDate ? new Date(shift.startDate) : null;
          const shiftDateStr = shiftStartDate ? formatDate(shiftStartDate.toISOString().slice(0, 10)) : null;
          
          const activities = Array.isArray(shift.activities) ? shift.activities : [];
          activities.forEach(activity => {
            const startIso = activity.startDate;
            const lengthMin = activity.lengthInMinutes;

            if (!startIso || lengthMin == null) {
              return;
            }

            const start = new Date(startIso);
            const end = new Date(start.getTime() + lengthMin * 60000);
            const activityLabel = getActivityName(businessUnitId, activity.activityCodeId);
            const dateStr = shiftDateStr || formatDate(start.toISOString().slice(0, 10));

            rows.push({
              date: dateStr,
              start,
              end,
              durationMinutes: lengthMin,
              activityLabel,
              countsAsPaidTime: activity.countsAsPaidTime,
              activityCodeId: activity.activityCodeId,
              type: 'shift',
              userId: userId,
              userName: usersById[userId]?.name || userId,
              teamNames: usersById[userId]?.teamNames || 'No Team',
              businessUnitId: businessUnitId
            });
          });
        });

        const fullDayTimeOffMarkers = Array.isArray(userSchedule.fullDayTimeOffMarkers) ? userSchedule.fullDayTimeOffMarkers : [];
        fullDayTimeOffMarkers.forEach(marker => {
          const dateStr = marker.managementUnitDate ? formatDate(marker.managementUnitDate) : null;
          const lengthMin = marker.lengthInMinutes || 480;
          
          if (!dateStr) return;

          const activityLabel = getActivityName(businessUnitId, marker.activityCodeId);

          rows.push({
            date: dateStr,
            start: null,
            end: null,
            durationMinutes: lengthMin,
            activityLabel: activityLabel,
            countsAsPaidTime: marker.isPaid !== false,
            activityCodeId: marker.activityCodeId,
            type: 'fullDayOff',
            userId: userId,
            userName: usersById[userId]?.name || userId,
            teamNames: usersById[userId]?.teamNames || 'No Team',
            businessUnitId: businessUnitId
          });
        });
      }

      rows.sort((a, b) => {
        if (a.date === b.date) {
          return (a.start || new Date(a.date)) - (b.start || new Date(b.date));
        }
        return a.date.localeCompare(b.date);
      });

      return rows;
    }

    function renderScheduleResults(container, activities, userIds, startDateIso, endDateIso) {
      const startDateStr = formatDate(startDateIso.slice(0, 10));
      const endDateStr = formatDate(endDateIso.slice(0, 10));

      let html = `
        <h2 class="section-title">Schedule for Selected Users</h2>
        <div class="schedule-meta">
          <span class="pill">From: ${escapeHtml(startDateStr)}</span>
          &nbsp;
          <span class="pill">To: ${escapeHtml(endDateStr)}</span>
          &nbsp;
          <span class="pill">Source: MU schedules/search</span>
        </div>
      `;

      if (!activities.length) {
        html += `<div class="info-message" style="margin-top:12px;">No activities found for selected users in the selected date range.</div>`;
      } else {
        html += `
          <table class="schedule-table">
            <thead>
              <tr>
                <th class="sortable" data-sort="userName">User</th>
                <th class="sortable" data-sort="teamNames">Team</th>
                <th class="sortable" data-sort="date">Date</th>
                <th class="sortable" data-sort="activityLabel">Activity</th>
                <th>Start</th>
                <th>End</th>
                <th class="sortable" data-sort="durationMinutes">Duration</th>
              </tr>
            </thead>
            <tbody>
        `;
        activities.forEach(row => {
          html += `
            <tr>
              <td>${escapeHtml(row.userName)}</td>
              <td>${escapeHtml(row.teamNames || 'No Team')}</td>
              <td>${escapeHtml(row.date)}</td>
              <td>${escapeHtml(row.activityLabel || '')}</td>
              <td>${escapeHtml(formatTime(row.start))}</td>
              <td>${escapeHtml(formatTime(row.end))}</td>
              <td>${escapeHtml(formatDuration(row.durationMinutes))}</td>
            </tr>
          `;
        });
        html += `</tbody></table>`;
      }

      const contentContainer = document.getElementById('scheduleResultsContent');
      contentContainer.innerHTML = html;
      
      const allActivities = [...new Set(activities.map(a => a.activityLabel))].sort();
      if (dropdowns.activityFilter && allActivities.length > 0) {
        const activityOpts = allActivities.map(a => ({ value: a, label: a }));
        dropdowns.activityFilter.setOptions(activityOpts);
      }
      
      applySorting('schedule');
    }

    function renderScheduleTable(activities) {
      const contentContainer = document.getElementById('scheduleResultsContent');
      
      let html = `
        <table class="schedule-table">
          <thead>
            <tr>
              <th class="sortable" data-sort="userName">User</th>
              <th class="sortable" data-sort="teamNames">Team</th>
              <th class="sortable" data-sort="date">Date</th>
              <th class="sortable" data-sort="activityLabel">Activity</th>
              <th>Start</th>
              <th>End</th>
              <th class="sortable" data-sort="durationMinutes">Duration</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      activities.forEach(row => {
        html += `
          <tr>
            <td>${escapeHtml(row.userName)}</td>
            <td>${escapeHtml(row.teamNames || 'No Team')}</td>
            <td>${escapeHtml(row.date)}</td>
            <td>${escapeHtml(row.activityLabel || '')}</td>
            <td>${escapeHtml(formatTime(row.start))}</td>
            <td>${escapeHtml(formatTime(row.end))}</td>
            <td>${escapeHtml(formatDuration(row.durationMinutes))}</td>
          </tr>
        `;
      });
      
      html += `</tbody></table>`;
      
      contentContainer.querySelector('table').outerHTML = html;
    }

    // ===== ACTUAL ACTIVITY TAB FUNCTIONS =====
    async function loadActualActivity() {
      const buIds = dropdowns.actualBu ? dropdowns.actualBu.getSelectedValues() : [];
      const muIds = dropdowns.actualMu ? dropdowns.actualMu.getSelectedValues() : [];
      const userIds = dropdowns.actualUser ? dropdowns.actualUser.getSelectedValues() : [];
      const startDateRaw = document.getElementById('actualStartDate').value;
      const endDateRaw = document.getElementById('actualEndDate').value;

      const startDateApi = convertToApiFormat(startDateRaw);
      const endDateApi = convertToApiFormat(endDateRaw);

      if (buIds.length === 0 || muIds.length === 0 || userIds.length === 0 || !startDateApi || !endDateApi) {
        showMessage('Please select business unit, management unit, users, and date range', 'error');
        return;
      }

      const start = new Date(startDateApi);
      const end = new Date(endDateApi);
      const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
      
      if (daysDiff > 31) {
        showMessage('Historical adherence queries are limited to 31 days maximum', 'error');
        return;
      }

      const button = document.getElementById('loadActualActivityBtn');
      const originalLabel = button.textContent;
      button.disabled = true;
      button.textContent = 'Loading actual activity...';

      try {
        await loadActivityCodes(buIds[0]);
        
        const endDateIso = getEndDateIso(endDateRaw);
        
        const jobId = await createHistoricalAdherenceQuery(muIds[0], userIds, startDateApi, endDateApi);
        const jobResult = await pollHistoricalAdherenceJob(jobId);
        const actualActivityData = await processJobResults(jobResult, buIds[0]);
        
        currentActualActivityData = actualActivityData;
        currentDisplayedData.actual = [...actualActivityData];
        renderActualActivityResults(actualActivityData, startDateRaw, endDateRaw);
        
        showMessage('Actual activity data loaded successfully', 'success');
      } catch (err) {
        console.error('Error loading actual activity:', err);
        throw err;
      } finally {
        button.disabled = false;
        button.textContent = originalLabel;
      }
    }

    async function createHistoricalAdherenceQuery(managementUnitId, userIds, startDate, endDate) {
      const endDateIso = getEndDateIso(endDate);
      const startDateIso = `${startDate}T00:00:00.000Z`;

      const body = {
        startDate: startDateIso,
        endDate: endDateIso,
        timeZone: 'UTC',
        userIds: userIds
      };

      const url = `${apiBase}/api/v2/workforcemanagement/managementunits/${encodeURIComponent(managementUnitId)}/historicaladherencequery`;

      try {
        const response = await authorizedFetchJson(url, {
          method: 'POST',
          body: JSON.stringify(body)
        });

        if (response && response.id) {
          return response.id;
        } else {
          throw new Error('Failed to create historical adherence query job - no job ID returned');
        }
      } catch (err) {
        console.error('Error creating historical adherence query:', err);
        throw new Error(`Failed to create historical adherence query: ${err.message}`);
      }
    }

    async function pollHistoricalAdherenceJob(jobId) {
      const url = `${apiBase}/api/v2/workforcemanagement/adherence/historical/jobs/${encodeURIComponent(jobId)}`;
      
      return new Promise((resolve, reject) => {
        let attempts = 0;
        const maxAttempts = 90;
        
        const checkJobStatus = async () => {
          attempts++;
          
          try {
            const response = await authorizedFetchJson(url);
            
            if (!response) {
              reject(new Error('Empty response from job status check'));
              return;
            }
            
            const jobState = response.queryState || response.state || response.status;
            
            if (jobState === 'Complete' || jobState === 'COMPLETE' || jobState === 'Completed' || jobState === 'COMPLETED') {
              resolve(response);
            } else if (jobState === 'Failed' || jobState === 'FAILED' || jobState === 'Error' || jobState === 'ERROR') {
              const errorMessage = response.errorMessage || response.message || 'Historical adherence job failed';
              reject(new Error(errorMessage));
            } else if (jobState === 'Processing' || jobState === 'PROCESSING' || jobState === 'Running' || jobState === 'RUNNING') {
              if (attempts >= maxAttempts) {
                reject(new Error('Job polling timeout - job took too long to complete'));
              } else {
                setTimeout(checkJobStatus, 2000);
              }
            } else {
              if (attempts >= maxAttempts) {
                reject(new Error(`Job polling timeout - stuck in state: ${jobState}`));
              } else {
                setTimeout(checkJobStatus, 2000);
              }
            }
          } catch (err) {
            console.error('Error checking job status:', err);
            if (attempts >= maxAttempts) {
              reject(new Error(`Job polling failed after ${maxAttempts} attempts: ${err.message}`));
            } else {
              setTimeout(checkJobStatus, 2000);
            }
          }
        };
        
        checkJobStatus();
      });
    }

    async function processJobResults(jobResult, businessUnitId) {
      if (!jobResult.downloadUrls || jobResult.downloadUrls.length === 0) {
        throw new Error('No download URLs found in job result');
      }

      const allActualActivities = [];
      
      for (const downloadUrl of jobResult.downloadUrls) {
        try {
          const data = await fetchWithCorsProxy(downloadUrl);
          
          if (data && data.data) {
            data.data.forEach(userData => {
              if (userData.actuals && userData.actuals.length > 0) {
                const userName = usersById[userData.userId]?.name || userData.userId;
                const teamNames = usersById[userData.userId]?.teamNames || 'No Team';
                const startDate = new Date(userData.startDate);
                
                userData.actuals.forEach(actual => {
                  if (actual.startOffsetSeconds == null || actual.endOffsetSeconds == null) {
                    return;
                  }
                  
                  const startTime = new Date(startDate.getTime() + (actual.startOffsetSeconds * 1000));
                  const endTime = new Date(startDate.getTime() + (actual.endOffsetSeconds * 1000));
                  
                  const durationMinutes = Math.round((endTime - startTime) / (1000 * 60));
                  
                  let activityName = actual.actualActivityCategory || 'Unknown Activity';
                  if (actual.actualActivityCodeId) {
                    const mappedName = getActivityName(businessUnitId, actual.actualActivityCodeId);
                    if (mappedName && mappedName !== actual.actualActivityCodeId) {
                      activityName = mappedName;
                    }
                  }
                  
                  allActualActivities.push({
                    userId: userData.userId,
                    userName: userName,
                    teamNames: teamNames,
                    date: formatDate(startTime.toISOString().slice(0, 10)),
                    startTime: startTime,
                    endTime: endTime,
                    durationMinutes: durationMinutes,
                    activityLabel: activityName,
                    activityCodeId: actual.actualActivityCodeId,
                    activityCategory: actual.actualActivityCategory,
                    systemPresence: actual.systemPresence,
                    businessUnitId: businessUnitId
                  });
                });
              }
            });
          }
        } catch (error) {
          console.error('Error processing download URL:', error);
          throw new Error(`Failed to download results: ${error.message}`);
        }
      }
      
      return allActualActivities;
    }

    function renderActualActivityResults(data, startDateInputFormat, endDateInputFormat) {
      const container = document.getElementById('actualResults');
      const contentContainer = document.getElementById('actualResultsContent');
      container.style.display = 'block';
      
      if (!data || data.length === 0) {
        contentContainer.innerHTML = `
          <div class="info-message">
            No actual activity data found for the selected period.
          </div>
        `;
        return;
      }
      
      data.sort((a, b) => {
        if (a.date === b.date) {
          return a.startTime - b.startTime;
        }
        return a.date.localeCompare(b.date);
      });

      const niceStart = formatDate(convertToApiFormat(startDateInputFormat));
      const niceEnd = formatDate(convertToApiFormat(endDateInputFormat));
      
      let html = `
        <h3 class="section-title">Actual Activity (Historical Adherence)</h3>
        <div class="schedule-meta">
          <span class="pill">Period: ${niceStart} to ${niceEnd}</span>
          &nbsp;
          <span class="pill">Total Activities: ${data.length}</span>
          &nbsp;
          <span class="pill">Source: Historical Adherence API</span>
        </div>
        
        <table class="schedule-table">
          <thead>
            <tr>
              <th class="sortable" data-sort="userName">User</th>
              <th class="sortable" data-sort="teamNames">Team</th>
              <th class="sortable" data-sort="date">Date</th>
              <th class="sortable" data-sort="activityLabel">Activity</th>
              <th>Start Time</th>
              <th>End Time</th>
              <th class="sortable" data-sort="durationMinutes">Duration</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      data.forEach(row => {
        html += `
          <tr>
            <td>${escapeHtml(row.userName)}</td>
            <td>${escapeHtml(row.teamNames || 'No Team')}</td>
            <td>${escapeHtml(row.date)}</td>
            <td>${escapeHtml(row.activityLabel || '')}</td>
            <td>${escapeHtml(formatTime(row.startTime))}</td>
            <td>${escapeHtml(formatTime(row.endTime))}</td>
            <td>${escapeHtml(formatDuration(row.durationMinutes))}</td>
          </tr>
        `;
      });
      
      html += `</tbody></table>`;
      
      contentContainer.innerHTML = html;
      
      const allActivities = [...new Set(data.map(a => a.activityLabel))].sort();
      if (dropdowns.actualActivityFilter && allActivities.length > 0) {
        const activityOpts = allActivities.map(a => ({ value: a, label: a }));
        dropdowns.actualActivityFilter.setOptions(activityOpts);
        
        dropdowns.actualActivityFilter.onSelectionChange = (selectedActivities) => {
          let filteredData = currentActualActivityData;
          if (selectedActivities.length > 0) {
            filteredData = currentActualActivityData.filter(activity => 
              selectedActivities.includes(activity.activityLabel)
            );
          }
          currentDisplayedData.actual = filteredData;
          renderActualActivityResults(filteredData, startDateInputFormat, endDateInputFormat);
        };
      }
      
      addTableSorting('actual');
    }

    function addTableSorting(tabType) {
      const table = document.querySelector(`#${tabType}ResultsContent table`);
      if (!table) return;
      
      const headers = table.querySelectorAll('th.sortable');
      headers.forEach(header => {
        header.addEventListener('click', () => {
          const sortField = header.getAttribute('data-sort');
          const currentSort = document.getElementById(`${tabType}Sort`).value;
          const currentOrder = document.getElementById(`${tabType}SortOrder`).value;
          
          if (sortField === currentSort) {
            document.getElementById(`${tabType}SortOrder`).value = currentOrder === 'asc' ? 'desc' : 'asc';
          } else {
            document.getElementById(`${tabType}Sort`).value = sortField;
            document.getElementById(`${tabType}SortOrder`).value = 'asc';
          }
          
          applySorting(tabType);
        });
      });
    }

    // ===== OVERTIME TAB FUNCTIONS =====
    async function analyzeOvertime() {
      const buIds = dropdowns.overtimeBu ? dropdowns.overtimeBu.getSelectedValues() : [];
      const muIds = dropdowns.overtimeMu ? dropdowns.overtimeMu.getSelectedValues() : [];
      const teamIds = dropdowns.overtimeTeam ? dropdowns.overtimeTeam.getSelectedValues() : [];
      const startDate = document.getElementById('overtimeStartDate').value;
      const endDate = document.getElementById('overtimeEndDate').value;

      const startDateApi = convertToApiFormat(startDate);
      const endDateApi = convertToApiFormat(endDate);

      if (buIds.length === 0 || muIds.length === 0 || !startDate || !endDate) {
        showMessage('Please select business unit, management unit, and date range', 'error');
        return;
      }

      const button = document.getElementById('analyzeOvertimeBtn');
      const originalLabel = button.textContent;
      button.disabled = true;
      button.textContent = 'Analyzing...';

      try {
        await loadActivityCodes(buIds[0]);
        
        let users = await getUsersForAnalytics(muIds[0], teamIds);
        
        const overtimeData = [];
        
        const startDateIso = `${startDateApi}T00:00:00.000Z`;
        const endDateIso = getEndDateIso(endDate);

        for (const user of users) {
          try {
            const schedule = await searchSchedules(muIds[0], user.id, startDateIso, endDateIso, true);
            const userOvertime = extractOvertimeActivities(schedule, user.id, buIds[0]);
            
            if (userOvertime.totalHours > 0) {
              overtimeData.push({
                user: user.name,
                teamNames: user.teamNames || 'No Team',
                totalHours: userOvertime.totalHours,
                rate1Hours: userOvertime.rate1Hours,
                rate1_5Hours: userOvertime.rate1_5Hours,
                rate2Hours: userOvertime.rate2Hours,
                activities: userOvertime.activities
              });
            }
          } catch (err) {
            console.error(`Error analyzing user ${user.name}:`, err);
          }
        }

        currentOvertimeData = overtimeData;
        currentDisplayedData.overtime = [...overtimeData];
        renderOvertimeResults(overtimeData, startDate, endDate);
      } catch (err) {
        console.error('Error analyzing overtime:', err);
        showMessage(`Error analyzing overtime: ${err.message}`, 'error');
      } finally {
        button.disabled = false;
        button.textContent = originalLabel;
      }
    }

    async function getUsersForAnalytics(muId, teamIds) {
      let users = [];
      
      if (teamIds && teamIds.length > 0) {
        const teamMembersArrays = await Promise.all(
          teamIds.map(teamId => getTeamMembers(teamId))
        );
        users = teamMembersArrays.flat();
        
        users = users.map(member => {
          const user = usersById[member.id] || member;
          user.teamNames = usersById[member.id]?.teamNames || 'No Team';
          return user;
        });
      } else {
        const muUsersResponse = await authorizedFetchJson(
          `${apiBase}/api/v2/workforcemanagement/managementunits/${encodeURIComponent(muId)}/users`
        );
        users = muUsersResponse.entities || muUsersResponse.users || [];
        
        users = users.map(uRef => {
          const user = usersById[uRef.id] || uRef;
          user.teamNames = usersById[uRef.id]?.teamNames || 'No Team';
          return user;
        });
      }
      
      return users.filter(u => u && u.name);
    }

    function extractOvertimeActivities(schedule, userId, businessUnitId) {
      const activities = extractUserActivitiesFromSearchResult(schedule, userId, businessUnitId);
      let totalHours = 0;
      let rate1Hours = 0;
      let rate1_5Hours = 0;
      let rate2Hours = 0;
      const overtimeActivities = [];
      
      activities.forEach(activity => {
        const activityName = getActivityName(businessUnitId, activity.activityCodeId);
        const activityCategory = getActivityCategory(businessUnitId, activity.activityCodeId);
        
        const isOvertime = activityName.toLowerCase().includes('overtime') || 
                          activityCategory.toLowerCase().includes('overtime') ||
                          activityName.toLowerCase().includes('ot ') ||
                          activityName.toLowerCase().includes('o/t') ||
                          activityName.toLowerCase().includes('1.5') ||
                          activityName.toLowerCase().includes('2.0') ||
                          activityName.toLowerCase().includes('timehalf') ||
                          activityName.toLowerCase().includes('double');
        
        if (isOvertime) {
          const hours = activity.durationMinutes / 60;
          totalHours += hours;
          
          let rate = '1.0';
          if (activityName.toLowerCase().includes('1.5') || activityName.toLowerCase().includes('timehalf')) {
            rate = '1.5';
            rate1_5Hours += hours;
          } else if (activityName.toLowerCase().includes('2.0') || activityName.toLowerCase().includes('double')) {
            rate = '2.0';
            rate2Hours += hours;
          } else {
            rate1Hours += hours;
          }
          
          overtimeActivities.push({
            date: formatDate(activity.date),
            activity: activityName,
            startTime: formatTime(activity.start),
            endTime: formatTime(activity.end),
            duration: formatDuration(activity.durationMinutes),
            hours: hours.toFixed(1),
            rate: rate,
            activityCodeId: activity.activityCodeId,
            category: activityCategory
          });
        }
      });
      
      return {
        totalHours: parseFloat(totalHours.toFixed(1)),
        rate1Hours: parseFloat(rate1Hours.toFixed(1)),
        rate1_5Hours: parseFloat(rate1_5Hours.toFixed(1)),
        rate2Hours: parseFloat(rate2Hours.toFixed(1)),
        activities: overtimeActivities
      };
    }

    function renderOvertimeResults(data, startDate, endDate) {
      const container = document.getElementById('overtimeResults');
      const contentContainer = document.getElementById('overtimeResultsContent');
      container.style.display = 'block';
      
      if (data.length === 0) {
        contentContainer.innerHTML = `
          <div class="info-message">
            No overtime activities found for the selected period.
          </div>
        `;
        return;
      }
      
      data.sort((a, b) => b.totalHours - a.totalHours);
      
      const totalOvertime = data.reduce((sum, item) => sum + item.totalHours, 0);
      const totalRate1 = data.reduce((sum, item) => sum + item.rate1Hours, 0);
      const totalRate1_5 = data.reduce((sum, item) => sum + item.rate1_5Hours, 0);
      const totalRate2 = data.reduce((sum, item) => sum + item.rate2Hours, 0);
      const avgOvertimePerUser = totalOvertime / data.length;
      
      let html = `
        <h3 class="section-title">Overtime Report</h3>
        <div class="schedule-meta">
          <span class="pill">Period: ${startDate} to ${endDate}</span>
          &nbsp;
          <span class="pill">Total Agents: ${data.length}</span>
          &nbsp;
          <span class="pill">Total Overtime: ${totalOvertime.toFixed(1)}h</span>
        </div>
        
        <div class="overtime-metrics">
          <div class="overtime-metric-card">
            <div class="metric-label">Total Overtime</div>
            <div class="metric-value">${totalOvertime.toFixed(1)}h</div>
          </div>
          <div class="overtime-metric-card">
            <div class="metric-label">1.0 Rate</div>
            <div class="metric-value">${totalRate1.toFixed(1)}h</div>
          </div>
          <div class="overtime-metric-card">
            <div class="metric-label">1.5 Rate</div>
            <div class="metric-value">${totalRate1_5.toFixed(1)}h</div>
          </div>
          <div class="overtime-metric-card">
            <div class="metric-label">2.0 Rate</div>
            <div class="metric-value">${totalRate2.toFixed(1)}h</div>
          </div>
          <div class="overtime-metric-card">
            <div class="metric-label">Avg per User</div>
            <div class="metric-value">${avgOvertimePerUser.toFixed(1)}h</div>
          </div>
        </div>
        
        <div class="chart-wrapper">
          <h4>Overtime Distribution</h4>
          <div style="margin-bottom: 16px; font-size: 14px; color: var(--text-light)">
            Showing top ${Math.min(10, data.length)} users by overtime hours
          </div>
      `;
      
      const topUsers = data.slice(0, 10);
      const maxHours = Math.max(...topUsers.map(u => u.totalHours), 1);
      
      topUsers.forEach(user => {
        const percentage = (user.totalHours / maxHours) * 100;
        html += `
          <div class="chart-bar">
            <div class="chart-bar-label">${escapeHtml(user.user)}</div>
            <div class="chart-bar-container">
              <div class="chart-bar-fill" style="width: ${percentage}%">
                ${user.totalHours.toFixed(1)}h
              </div>
            </div>
            <div class="chart-bar-value">${user.totalHours.toFixed(1)}h</div>
          </div>
        `;
      });
      
      html += `</div>`;
      
      html += `
        <table class="schedule-table">
          <thead>
            <tr>
              <th class="sortable" data-sort="user">Agent</th>
              <th class="sortable" data-sort="teamNames">Team</th>
              <th class="sortable" data-sort="totalHours">Total Overtime</th>
              <th class="sortable" data-sort="rate1Hours">1.0 Rate</th>
              <th class="sortable" data-sort="rate1_5Hours">1.5 Rate</th>
              <th class="sortable" data-sort="rate2Hours">2.0 Rate</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      data.forEach(item => {
        html += `
          <tr>
            <td>${escapeHtml(item.user)}</td>
            <td>${escapeHtml(item.teamNames || 'No Team')}</td>
            <td><strong>${item.totalHours.toFixed(1)}h</strong></td>
            <td>${item.rate1Hours.toFixed(1)}h</td>
            <td>${item.rate1_5Hours.toFixed(1)}h</td>
            <td>${item.rate2Hours.toFixed(1)}h</td>
          </tr>
        `;
      });
      
      html += `
            </tbody>
          </table>
        </div>
      `;
      
      contentContainer.innerHTML = html;
      
      const overtimeActivities = [...new Set(data.flatMap(u => u.activities.map(a => a.activity)))].sort();
      if (dropdowns.overtimeActivityFilter && overtimeActivities.length > 0) {
        const activityOpts = overtimeActivities.map(a => ({ value: a, label: a }));
        dropdowns.overtimeActivityFilter.setOptions(activityOpts);
      }
    }

    // ===== ABSENCE TAB FUNCTIONS =====
    async function analyzeAbsence() {
      const buIds = dropdowns.absenceBu ? dropdowns.absenceBu.getSelectedValues() : [];
      const muIds = dropdowns.absenceMu ? dropdowns.absenceMu.getSelectedValues() : [];
      const teamIds = dropdowns.absenceTeam ? dropdowns.absenceTeam.getSelectedValues() : [];
      const startDate = document.getElementById('absenceStartDate').value;
      const endDate = document.getElementById('absenceEndDate').value;
      const thresholdDays = parseFloat(document.getElementById('absenceThreshold').value) || 2;

      const startDateApi = convertToApiFormat(startDate);
      const endDateApi = convertToApiFormat(endDate);

      if (buIds.length === 0 || muIds.length === 0 || !startDate || !endDate) {
        showMessage('Please select business unit, management unit, and date range', 'error');
        return;
      }

      const button = document.getElementById('analyzeAbsenceBtn');
      const originalLabel = button.textContent;
      button.disabled = true;
      button.textContent = 'Analyzing...';

      try {
        await loadActivityCodes(buIds[0]);
        
        let users = await getUsersForAnalytics(muIds[0], teamIds);
        const absenceData = [];
        
        const startDateIso = `${startDateApi}T00:00:00.000Z`;
        const endDateIso = getEndDateIso(endDate);

        for (const user of users) {
          try {
            const schedule = await searchSchedules(muIds[0], user.id, startDateIso, endDateIso, true);
            const absenceStats = calculateAbsenceStats(schedule, user.id, buIds[0]);
            
            if (absenceStats.totalHours > 0) {
              const thresholdHours = thresholdDays * 8;
              absenceData.push({
                user: user.name,
                teamNames: user.teamNames || 'No Team',
                totalHours: absenceStats.totalHours,
                absenceDays: absenceStats.days,
                instances: absenceStats.instances,
                exceedsThreshold: absenceStats.totalHours >= thresholdHours,
                absenceDetails: absenceStats.details,
                averageHoursPerInstance: parseFloat((absenceStats.totalHours / absenceStats.instances).toFixed(1))
              });
            }
          } catch (err) {
            console.error(`Error analyzing user ${user.name}:`, err);
          }
        }

        currentAbsenceData = absenceData;
        currentDisplayedData.absence = [...absenceData];
        renderAbsenceResults(absenceData, thresholdDays, startDate, endDate);
      } catch (err) {
        console.error('Error analyzing absence:', err);
        showMessage(`Error analyzing absence: ${err.message}`, 'error');
      } finally {
        button.disabled = false;
        button.textContent = originalLabel;
      }
    }

    function calculateAbsenceStats(schedule, userId, businessUnitId) {
      const activities = extractUserActivitiesFromSearchResult(schedule, userId, businessUnitId);
      let totalHours = 0;
      const absenceDays = new Set();
      let instances = 0;
      const absenceDetails = [];
      const absenceTypes = new Set();
      
      activities.forEach(activity => {
        const activityName = getActivityName(businessUnitId, activity.activityCodeId);
        const activityCategory = getActivityCategory(businessUnitId, activity.activityCodeId);
        
        const isAbsence = (activity.type === 'fullDayOff' || 
                         activityCategory === 'TimeOff' ||
                         activityName.includes('Time Off') || 
                         activityName.includes('Sick') || 
                         activityName.includes('Absence') || 
                         activityName.includes('Vacation') ||
                         activityName.includes('Leave') ||
                         activityName.includes('Personal') ||
                         activityName.includes('Family') ||
                         activityName.includes('Medical')) &&
                         !activityName.includes('Holiday') &&
                         !activityName.includes('TOIL') &&
                         !activityName.includes('Bank Holiday');
        
        if (isAbsence) {
          totalHours += activity.durationMinutes / 60;
          absenceDays.add(formatDate(activity.date));
          instances++;
          absenceTypes.add(activityName);
          
          absenceDetails.push({
            date: formatDate(activity.date),
            type: activityName,
            duration: formatDuration(activity.durationMinutes),
            hours: (activity.durationMinutes / 60).toFixed(1)
          });
        }
      });
      
      return {
        totalHours: parseFloat(totalHours.toFixed(1)),
        days: absenceDays.size,
        instances: instances,
        details: absenceDetails,
        types: Array.from(absenceTypes)
      };
    }

    function renderAbsenceResults(data, thresholdDays, startDate, endDate) {
      const container = document.getElementById('absenceResults');
      const contentContainer = document.getElementById('absenceResultsContent');
      container.style.display = 'block';
      
      if (data.length === 0) {
        contentContainer.innerHTML = `<div class="info-message">No absence recorded for the selected period.</div>`;
        return;
      }
      
      let filteredData = [...data];
      if (currentDrillDown.type === 'aboveThreshold') {
        filteredData = data.filter(item => item.exceedsThreshold);
      }
      
      filteredData.sort((a, b) => b.totalHours - a.totalHours);
      
      if (currentAbsenceView === 'detailed') {
        renderDetailedAbsenceTable(filteredData, thresholdDays, startDate, endDate);
      } else {
        renderAbsenceSummary(filteredData, thresholdDays, startDate, endDate);
      }
    }

    function renderAbsenceSummary(data, thresholdDays, startDate, endDate) {
      const contentContainer = document.getElementById('absenceResultsContent');
      
      const usersAboveThreshold = data.filter(item => item.exceedsThreshold).length;
      const totalAbsenceHours = data.reduce((sum, item) => sum + item.totalHours, 0);
      const totalAbsenceDays = data.reduce((sum, item) => sum + item.absenceDays, 0);
      const totalInstances = data.reduce((sum, item) => sum + item.instances, 0);
      const avgHoursPerUser = totalAbsenceHours / data.length;
      const avgDaysPerUser = totalAbsenceDays / data.length;
      const mostCommonType = findMostCommonAbsenceType(data);
      
      let html = `
        <h3 class="section-title">Absence Analytics</h3>
        <div class="schedule-meta">
          <span class="pill">Period: ${startDate} to ${endDate}</span>
          &nbsp;
          <span class="pill">Alert Threshold: ${thresholdDays} days</span>
          &nbsp;
          <span class="pill">Total Agents: ${data.length}</span>
          ${currentDrillDown.type ? `<span class="pill drilldown-badge">Filtered View</span>` : ''}
        </div>
        
        <div class="analytics-grid">
          <div>
            <div class="chart-wrapper">
              <h4>Absence Hours Distribution</h4>
              <div style="margin-bottom: 16px; font-size: 14px; color: var(--text-light)">
                Showing top ${Math.min(10, data.length)} users by absence hours
              </div>
      `;
      
      const topUsersByHours = data.slice(0, 10);
      const maxHours = Math.max(...topUsersByHours.map(u => u.totalHours), 1);
      
      topUsersByHours.forEach(user => {
        const percentage = (user.totalHours / maxHours) * 100;
        html += `
          <div class="chart-bar">
            <div class="chart-bar-label">${escapeHtml(user.user)}</div>
            <div class="chart-bar-container">
              <div class="chart-bar-fill" style="width: ${percentage}%">
                ${user.totalHours.toFixed(1)}h
              </div>
            </div>
            <div class="chart-bar-value">${user.totalHours.toFixed(1)}h</div>
          </div>
        `;
      });
      
      html += `</div>`;
      
      html += `
        <div class="chart-wrapper">
          <h4>Absence Days Distribution</h4>
          <div style="margin-bottom: 16px; font-size: 14px; color: var(--text-light)">
            Showing top ${Math.min(10, data.length)} users by absence days
          </div>
      `;
      
      const topUsersByDays = [...data].sort((a, b) => b.absenceDays - a.absenceDays).slice(0, 10);
      const maxDays = Math.max(...topUsersByDays.map(u => u.absenceDays), 1);
      
      topUsersByDays.forEach(user => {
        const percentage = (user.absenceDays / maxDays) * 100;
        html += `
          <div class="chart-bar">
            <div class="chart-bar-label">${escapeHtml(user.user)}</div>
            <div class="chart-bar-container">
              <div class="chart-bar-fill" style="width: ${percentage}%; background: linear-gradient(90deg, #ea580c, #c2410c);">
                ${user.absenceDays}d
              </div>
            </div>
            <div class="chart-bar-value">${user.absenceDays}d</div>
          </div>
        `;
      });
      
      html += `</div>`;
      
      const chartAbsenceTypes = getAbsenceTypeDistribution(data);
      if (chartAbsenceTypes.length > 0) {
        html += `
          <div class="chart-wrapper">
            <h4>Absence Types</h4>
        `;
        
        const maxTypeCount = Math.max(...chartAbsenceTypes.map(t => t.count), 1);
        
        chartAbsenceTypes.forEach(type => {
          const percentage = (type.count / maxTypeCount) * 100;
          html += `
            <div class="chart-bar">
              <div class="chart-bar-label">${escapeHtml(type.name)}</div>
              <div class="chart-bar-container">
                <div class="chart-bar-fill" style="width: ${percentage}%; background: linear-gradient(90deg, #8b5cf6, #7c3aed);">
                  ${type.count}
                </div>
              </div>
              <div class="chart-bar-value">${type.count}</div>
            </div>
          `;
        });
        
        html += `</div>`;
      }
      
      html += `</div>`;
      
      html += `
        <div>
          <div class="chart-wrapper">
            <h4>Summary Metrics ${currentDrillDown.type ? '<span class="drilldown-badge">Filtered</span>' : ''}</h4>
            <div style="display: grid; gap: 12px;">
              <div class="metric-card ${currentDrillDown.type ? 'drilldown-active' : ''}" onclick="clearDrillDown()" style="cursor: pointer;">
                <div class="metric-label">Total Agents</div>
                <div class="metric-value">${data.length}</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">Total Absence Hours</div>
                <div class="metric-value">${totalAbsenceHours.toFixed(1)}h</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">Total Absence Days</div>
                <div class="metric-value">${totalAbsenceDays}</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">Total Instances</div>
                <div class="metric-value">${totalInstances}</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">Avg Hours per User</div>
                <div class="metric-value">${avgHoursPerUser.toFixed(1)}h</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">Avg Days per User</div>
                <div class="metric-value">${avgDaysPerUser.toFixed(1)}</div>
              </div>
              <div class="metric-card clickable ${currentDrillDown.type === 'aboveThreshold' ? 'drilldown-active' : ''}" onclick="drillDownToAboveThreshold()">
                <div class="metric-label">Users Above Threshold</div>
                <div class="metric-value">${usersAboveThreshold}</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">Most Common Type</div>
                <div class="metric-value">${mostCommonType || 'N/A'}</div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      html += `</div>`;
      
      html += `
        <table class="schedule-table">
          <thead>
            <tr>
              <th class="sortable" data-sort="user">Agent</th>
              <th class="sortable" data-sort="teamNames">Team</th>
              <th class="sortable" data-sort="totalHours">Total Hours</th>
              <th class="sortable" data-sort="absenceDays">Days</th>
              <th class="sortable" data-sort="instances">Instances</th>
              <th class="sortable" data-sort="averageHoursPerInstance">Avg/Instance</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      data.forEach(item => {
        const thresholdHours = thresholdDays * 8;
        const exceedsThreshold = item.totalHours >= thresholdHours;
        const rowClass = exceedsThreshold ? 'warning-row' : '';
        const status = exceedsThreshold ? 
          `<span class="absence-badge">Above Threshold</span>` : 
          '<span style="color: var(--success-text)">Within Limits</span>';
        
        html += `
          <tr class="${rowClass}">
            <td>${escapeHtml(item.user)}</td>
            <td>${escapeHtml(item.teamNames || 'No Team')}</td>
            <td><strong>${item.totalHours}h</strong></td>
            <td>${item.absenceDays}</td>
            <td>${item.instances}</td>
            <td>${item.averageHoursPerInstance}h</td>
            <td>${status}</td>
          </tr>
        `;
        
        if (item.absenceDetails && item.absenceDetails.length > 0) {
          html += `
            <tr>
              <td colspan="7">
                <div class="absence-details">
                  <strong>Absence Details:</strong>
                  ${item.absenceDetails.map(detail => `
                    <div class="absence-day">
                      <span class="absence-date">${detail.date} - ${detail.type}</span>
                      <span class="absence-duration">${detail.duration} (${detail.hours}h)</span>
                    </div>
                  `).join('')}
                </div>
              </td>
            </tr>
          `;
        }
      });
      
      html += `</tbody></table>`;
      
      contentContainer.innerHTML = html;
      
      const filterAbsenceTypes = [...new Set(data.flatMap(u => u.absenceDetails.map(a => a.type)))].sort();
      if (dropdowns.absenceActivityFilter && filterAbsenceTypes.length > 0) {
        const activityOpts = filterAbsenceTypes.map(a => ({ value: a, label: a }));
        dropdowns.absenceActivityFilter.setOptions(activityOpts);
      }
    }

    function renderDetailedAbsenceTable(data, thresholdDays, startDate, endDate) {
      const contentContainer = document.getElementById('absenceResultsContent');
      
      const detailedData = [];
      data.forEach(item => {
        item.absenceDetails.forEach(detail => {
          detailedData.push({
            agent: item.user,
            team: item.teamNames || 'No Team',
            date: detail.date,
            type: detail.type,
            duration: detail.duration,
            hours: detail.hours
          });
        });
      });
      
      let html = `
        <h3 class="section-title">Detailed Absence Records</h3>
        <div class="schedule-meta">
          <span class="pill">Period: ${startDate} to ${endDate}</span>
          &nbsp;
          <span class="pill">Alert Threshold: ${thresholdDays} days</span>
          &nbsp;
          <span class="pill">Total Records: ${detailedData.length}</span>
          &nbsp;
          <span class="pill">Total Agents: ${data.length}</span>
        </div>
        
        <table class="schedule-table">
          <thead>
            <tr>
              <th class="sortable" data-sort="agent">Agent</th>
              <th class="sortable" data-sort="team">Team</th>
              <th class="sortable" data-sort="date">Date</th>
              <th class="sortable" data-sort="type">Absence Type</th>
              <th class="sortable" data-sort="duration">Duration</th>
              <th class="sortable" data-sort="hours">Hours</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      detailedData.forEach(record => {
        html += `
          <tr>
            <td>${escapeHtml(record.agent)}</td>
            <td>${escapeHtml(record.team)}</td>
            <td>${escapeHtml(record.date)}</td>
            <td>${escapeHtml(record.type)}</td>
            <td>${escapeHtml(record.duration)}</td>
            <td>${escapeHtml(record.hours)}h</td>
          </tr>
        `;
      });
      
      html += `</tbody></table>`;
      
      contentContainer.innerHTML = html;
    }

    function drillDownToAboveThreshold() {
      currentDrillDown = {
        type: 'aboveThreshold',
        filter: 'Users above threshold'
      };
      
      const thresholdDays = parseFloat(document.getElementById('absenceThreshold').value) || 2;
      const startDate = document.getElementById('absenceStartDate').value;
      const endDate = document.getElementById('absenceEndDate').value;
      
      renderAbsenceResults(currentAbsenceData, thresholdDays, startDate, endDate);
    }

    function clearDrillDown() {
      currentDrillDown = {
        type: null,
        filter: null
      };
      
      const thresholdDays = parseFloat(document.getElementById('absenceThreshold').value) || 2;
      const startDate = document.getElementById('absenceStartDate').value;
      const endDate = document.getElementById('absenceEndDate').value;
      
      renderAbsenceResults(currentAbsenceData, thresholdDays, startDate, endDate);
    }

    function findMostCommonAbsenceType(data) {
      const typeCounts = {};
      data.forEach(user => {
        user.absenceDetails.forEach(detail => {
          typeCounts[detail.type] = (typeCounts[detail.type] || 0) + 1;
        });
      });
      
      let mostCommon = null;
      let maxCount = 0;
      
      for (const [type, count] of Object.entries(typeCounts)) {
        if (count > maxCount) {
          mostCommon = type;
          maxCount = count;
        }
      }
      
      return mostCommon;
    }

    function getAbsenceTypeDistribution(data) {
      const typeCounts = {};
      data.forEach(user => {
        user.absenceDetails.forEach(detail => {
          typeCounts[detail.type] = (typeCounts[detail.type] || 0) + 1;
        });
      });
      
      return Object.entries(typeCounts)
        .map(([name, count]) => ({ name, count }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 10);
    }

    // ===== LATE REPORT TAB FUNCTIONS =====
    async function generateLateReport() {
      const buIds = dropdowns.lateBu ? dropdowns.lateBu.getSelectedValues() : [];
      const muIds = dropdowns.lateMu ? dropdowns.lateMu.getSelectedValues() : [];
      const userIds = dropdowns.lateUser ? dropdowns.lateUser.getSelectedValues() : [];
      const startDateRaw = document.getElementById('lateStartDate').value;
      const endDateRaw = document.getElementById('lateEndDate').value;
      const thresholdSeconds = parseInt(document.getElementById('lateThreshold').value) || 30;

      if (buIds.length === 0 || muIds.length === 0 || userIds.length === 0 || !startDateRaw || !endDateRaw) {
        showMessage('Please select business unit, management unit, users, and date range', 'error');
        return;
      }

      const button = document.getElementById('generateLateReportBtn');
      const originalLabel = button.textContent;
      button.disabled = true;
      button.textContent = 'Generating late report...';

      try {
        await loadActivityCodes(buIds[0]);
        
        const scheduleData = await getScheduleDataForLateReport(muIds[0], userIds, startDateRaw, endDateRaw, buIds[0]);
        const actualData = await getActualActivityDataForLateReport(muIds[0], userIds, startDateRaw, endDateRaw, buIds[0]);
        const lateReportData = generateLateReportData(scheduleData, actualData, thresholdSeconds);
        
        currentDisplayedData.late = [...lateReportData];
        renderLateReportResults(lateReportData);
        
        showMessage('Late report generated successfully', 'success');
      } catch (err) {
        console.error('Error generating late report:', err);
        showMessage(`Failed to generate late report: ${err.message}`, 'error');
      } finally {
        button.disabled = false;
        button.textContent = originalLabel;
      }
    }

    async function getScheduleDataForLateReport(managementUnitId, userIds, startDate, endDate, businessUnitId) {
      const startDateApi = convertToApiFormat(startDate);
      const endDateApi = convertToApiFormat(endDate);
      
      const startDateIso = `${startDateApi}T00:00:00.000Z`;
      const endDateIso = getEndDateIso(endDate);

      let allActivities = [];
      for (const userId of userIds) {
        try {
          const searchResult = await searchSchedules(managementUnitId, userId, startDateIso, endDateIso, true);
          const activities = extractUserActivitiesFromSearchResult(searchResult, userId, businessUnitId);
          allActivities = allActivities.concat(activities);
        } catch (err) {
          console.error(`Error loading schedule for user ${userId}:`, err);
        }
      }
      
      return allActivities;
    }
    
    async function getActualActivityDataForLateReport(managementUnitId, userIds, startDate, endDate, businessUnitId) {
      const startDateApi = convertToApiFormat(startDate);
      const endDateApi = convertToApiFormat(endDate);

      try {
        const jobId = await createHistoricalAdherenceQuery(managementUnitId, userIds, startDateApi, endDateApi);
        const jobResult = await pollHistoricalAdherenceJob(jobId);
        const actualData = await processJobResults(jobResult, businessUnitId);
        
        const filteredActualData = actualData.filter(activity => 
          !activity.activityLabel.toLowerCase().includes('unavailable') &&
          !activity.activityCategory.toLowerCase().includes('unavailable')
        );
        
        return filteredActualData;
      } catch (err) {
        console.error('Error getting actual activity data for late report:', err);
        return [];
      }
    }

    function generateLateReportData(scheduleData, actualData, thresholdSeconds) {
      const lateReport = [];
      
      const scheduleByUserDate = {};
      
      const filteredScheduleData = scheduleData.filter(scheduleItem => {
        const activityName = scheduleItem.activityLabel || '';
        const activityCategory = getActivityCategory(scheduleItem.businessUnitId, scheduleItem.activityCodeId);
        
        return !activityName.toLowerCase().includes('time off') &&
               !activityName.toLowerCase().includes('holiday') &&
               !activityName.toLowerCase().includes('sick') &&
               !activityName.toLowerCase().includes('absence') &&
               !activityName.toLowerCase().includes('vacation') &&
               !activityName.toLowerCase().includes('leave') &&
               activityCategory !== 'TimeOff';
      });
      
      filteredScheduleData.forEach(scheduleItem => {
        const key = `${scheduleItem.userId}_${scheduleItem.date}`;
        if (!scheduleByUserDate[key]) {
          scheduleByUserDate[key] = [];
        }
        scheduleByUserDate[key].push(scheduleItem);
      });
      
      const actualByUserDate = {};
      actualData.forEach(actualItem => {
        const key = `${actualItem.userId}_${actualItem.date}`;
        if (!actualByUserDate[key]) {
          actualByUserDate[key] = [];
        }
        actualByUserDate[key].push(actualItem);
      });
      
      Object.keys(scheduleByUserDate).forEach(key => {
        const [userId, date] = key.split('_');
        const userSchedule = scheduleByUserDate[key];
        
        userSchedule.sort((a, b) => {
          const aTime = a.start ? a.start.getTime() : new Date(a.date).getTime();
          const bTime = b.start ? b.start.getTime() : new Date(b.date).getTime();
          return aTime - bTime;
        });
        
        const firstScheduledActivity = userSchedule[0];
        
        if (!firstScheduledActivity) return;
        
        const userActualActivities = actualByUserDate[key] || [];
        
        if (userActualActivities.length === 0) {
          lateReport.push({
            userId: userId,
            userName: firstScheduledActivity.userName,
            teamNames: firstScheduledActivity.teamNames || 'No Team',
            date: date,
            scheduledStart: firstScheduledActivity.start,
            actualStart: null,
            status: 'AWOL',
            durationLate: null,
            scheduledActivity: firstScheduledActivity.activityLabel,
            actualActivity: null
          });
          return;
        }
        
        userActualActivities.sort((a, b) => a.startTime - b.startTime);
        const firstActualActivity = userActualActivities[0];
        
        if (!firstActualActivity) return;
        
        if (!firstScheduledActivity.start) {
          return;
        }
        
        const timeDiffSeconds = Math.round((firstActualActivity.startTime - firstScheduledActivity.start) / 1000);
        
        let status, durationLate;
        
        if (timeDiffSeconds <= thresholdSeconds && timeDiffSeconds >= -thresholdSeconds) {
          status = 'Adherent';
          durationLate = 0;
        } else if (timeDiffSeconds > thresholdSeconds) {
          status = 'Late';
          durationLate = timeDiffSeconds;
        } else {
          status = 'Early';
          durationLate = Math.abs(timeDiffSeconds);
        }
        
        lateReport.push({
          userId: userId,
          userName: firstScheduledActivity.userName,
          teamNames: firstScheduledActivity.teamNames || 'No Team',
          date: date,
          scheduledStart: firstScheduledActivity.start,
          actualStart: firstActualActivity.startTime,
          status: status,
          durationLate: durationLate,
          scheduledActivity: firstScheduledActivity.activityLabel,
          actualActivity: firstActualActivity.activityLabel
        });
      });
      
      return lateReport;
    }

    function renderLateReportResults(data) {
      const container = document.getElementById('lateResults');
      const contentContainer = document.getElementById('lateResultsContent');
      container.style.display = 'block';
      
      if (!data || data.length === 0) {
        contentContainer.innerHTML = `
          <div class="info-message">
            No late report data found for the selected period.
          </div>
        `;
        return;
      }
      
      const thresholdSeconds = parseInt(document.getElementById('lateThreshold').value) || 30;
      const lateCount = data.filter(item => item.status === 'Late').length;
      const earlyCount = data.filter(item => item.status === 'Early').length;
      const adherentCount = data.filter(item => item.status === 'Adherent').length;
      const awolCount = data.filter(item => item.status === 'AWOL').length;
      
      let html = `
        <h3 class="section-title">Late Report</h3>
        <div class="schedule-meta">
          <span class="pill">Total Shifts: ${data.length}</span>
          <span class="pill" style="background: #fee2e2; color: #b42318;">Late: ${lateCount}</span>
          <span class="pill" style="background: #fffbeb; color: #b45309;">Early: ${earlyCount}</span>
          <span class="pill" style="background: #f0f9ff; color: #0c4a6e;">Adherent: ${adherentCount}</span>
          <span class="pill" style="background: #f3e8ff; color: #7e22ce;">AWOL: ${awolCount}</span>
          <span class="pill">Threshold: ${thresholdSeconds}s</span>
        </div>
        
        <table class="schedule-table">
          <thead>
            <tr>
              <th class="sortable" data-sort="userName">User</th>
              <th class="sortable" data-sort="teamNames">Team</th>
              <th class="sortable" data-sort="date">Date</th>
              <th>Scheduled Start</th>
              <th>Actual Start</th>
              <th class="sortable" data-sort="status">Status</th>
              <th class="sortable" data-sort="durationLate">Duration</th>
              <th>Scheduled Activity</th>
              <th>Actual Activity</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      data.forEach(row => {
        let statusClass = '';
        let statusText = '';
        let durationText = '';
        
        switch(row.status) {
          case 'Late':
            statusClass = 'status-late';
            statusText = `Late by ${formatDuration(Math.ceil(row.durationLate / 60))}`;
            durationText = `+${formatDuration(Math.ceil(row.durationLate / 60))}`;
            break;
          case 'Early':
            statusClass = 'status-early';
            statusText = `Early by ${formatDuration(Math.ceil(row.durationLate / 60))}`;
            durationText = `-${formatDuration(Math.ceil(row.durationLate / 60))}`;
            break;
          case 'Adherent':
            statusClass = 'status-adherent';
            statusText = 'On Time';
            durationText = '0m';
            break;
          case 'AWOL':
            statusClass = 'status-awol';
            statusText = 'AWOL';
            durationText = 'N/A';
            break;
        }
        
        html += `
          <tr>
            <td>${escapeHtml(row.userName)}</td>
            <td>${escapeHtml(row.teamNames || 'No Team')}</td>
            <td>${escapeHtml(row.date)}</td>
            <td>${row.scheduledStart ? escapeHtml(formatTime(row.scheduledStart)) : 'N/A'}</td>
            <td>${row.actualStart ? escapeHtml(formatTime(row.actualStart)) : 'N/A'}</td>
            <td><span class="${statusClass}">${statusText}</span></td>
            <td>${durationText}</td>
            <td>${escapeHtml(row.scheduledActivity || 'N/A')}</td>
            <td>${escapeHtml(row.actualActivity || 'N/A')}</td>
          </tr>
        `;
      });
      
      html += `</tbody></table>`;
      
      contentContainer.innerHTML = html;
      
      addLateReportTableSorting();
    }

    function addLateReportTableSorting() {
      const table = document.querySelector('#lateResultsContent table');
      if (!table) return;
      
      const headers = table.querySelectorAll('th.sortable');
      headers.forEach(header => {
        header.addEventListener('click', () => {
          const sortField = header.getAttribute('data-sort');
          const currentSort = document.getElementById('lateSort').value;
          const currentOrder = document.getElementById('lateSortOrder').value;
          
          if (sortField === currentSort) {
            document.getElementById('lateSortOrder').value = currentOrder === 'asc' ? 'desc' : 'asc';
          } else {
            document.getElementById('lateSort').value = sortField;
            document.getElementById('lateSortOrder').value = 'asc';
          }
          
          applyLateReportSorting();
        });
      });
    }

    function applyLateReportSorting() {
      const data = currentDisplayedData.late;
      const sortField = document.getElementById('lateSort').value;
      const sortOrder = document.getElementById('lateSortOrder').value;
      
      if (!data || data.length === 0) return;
      
      const sortedData = [...data].sort((a, b) => {
        let aVal = a[sortField];
        let bVal = b[sortField];
        
        if (sortField === 'date') {
          aVal = new Date(aVal.split('-').reverse().join('-'));
          bVal = new Date(bVal.split('-').reverse().join('-'));
        }
        
        if (sortField === 'durationLate') {
          aVal = aVal || 0;
          bVal = bVal || 0;
        }
        
        if (aVal < bVal) return sortOrder === 'asc' ? -1 : 1;
        if (aVal > bVal) return sortOrder === 'asc' ? 1 : -1;
        return 0;
      });
      
      currentDisplayedData.late = sortedData;
      renderLateReportResults(sortedData);
    }

    // ===== TIME OWED TAB FUNCTIONS =====
    async function generateTimeOwedReport() {
      const buIds = dropdowns.timeOwedBu ? dropdowns.timeOwedBu.getSelectedValues() : [];
      const muIds = dropdowns.timeOwedMu ? dropdowns.timeOwedMu.getSelectedValues() : [];
      const userIds = dropdowns.timeOwedUser ? dropdowns.timeOwedUser.getSelectedValues() : [];
      const startDateRaw = document.getElementById('timeOwedStartDate').value;
      const endDateRaw = document.getElementById('timeOwedEndDate').value;

      if (buIds.length === 0 || muIds.length === 0 || userIds.length === 0 || !startDateRaw || !endDateRaw) {
        showMessage('Please select business unit, management unit, users, and date range', 'error');
        return;
      }

      const button = document.getElementById('generateTimeOwedReportBtn');
      const originalLabel = button.textContent;
      button.disabled = true;
      button.textContent = 'Generating time owed report...';

      try {
        await loadActivityCodes(buIds[0]);
        
        const scheduleData = await getScheduleDataForLateReport(muIds[0], userIds, startDateRaw, endDateRaw, buIds[0]);
        const actualData = await getActualActivityDataForTimeOwed(muIds[0], userIds, startDateRaw, endDateRaw, buIds[0]);
        const timeOwedData = generateTimeOwedData(scheduleData, actualData);
        
        currentTimeOwedData = timeOwedData;
        currentDisplayedData.timeowed = [...timeOwedData];
        renderTimeOwedResults(timeOwedData);
        
        showMessage('Time owed report generated successfully', 'success');
      } catch (err) {
        console.error('Error generating time owed report:', err);
        showMessage(`Failed to generate time owed report: ${err.message}`, 'error');
      } finally {
        button.disabled = false;
        button.textContent = originalLabel;
      }
    }

    async function getActualActivityDataForTimeOwed(managementUnitId, userIds, startDate, endDate, businessUnitId) {
      const startDateApi = convertToApiFormat(startDate);
      const endDateApi = convertToApiFormat(endDate);

      try {
        const jobId = await createHistoricalAdherenceQuery(managementUnitId, userIds, startDateApi, endDateApi);
        const jobResult = await pollHistoricalAdherenceJob(jobId);
        const actualData = await processJobResults(jobResult, businessUnitId);
        
        // Filter for 'offline' activities (Agent Unavailable, Off Queue, etc.)
        const offlineActivities = actualData.filter(activity => {
          const activityName = activity.activityLabel.toLowerCase();
          const activityCategory = activity.activityCategory ? activity.activityCategory.toLowerCase() : '';
          
          return activityName.includes('unavailable') || 
                 activityName.includes('off queue') ||
                 activityName.includes('off-queue') ||
                 activityName.includes('logged out') ||
                 activityName.includes('sign off') ||
                 activityCategory.includes('unavailable') ||
                 activityCategory.includes('offqueue');
        });
        
        console.log(`Found ${offlineActivities.length} offline activities out of ${actualData.length} total activities`);
        
        return offlineActivities;
      } catch (err) {
        console.error('Error getting actual activity data for time owed:', err);
        return [];
      }
    }

    function generateTimeOwedData(scheduleData, actualData) {
      const timeOwedReport = [];
      
      console.log(`Generating time owed report with ${scheduleData.length} schedule items and ${actualData.length} offline activities`);
      
      const scheduleByUserDate = {};
      
      // Filter schedule to only include work activities
      const filteredScheduleData = scheduleData.filter(scheduleItem => {
        const activityName = scheduleItem.activityLabel || '';
        const activityCategory = getActivityCategory(scheduleItem.businessUnitId, scheduleItem.activityCodeId);
        
        return !activityName.toLowerCase().includes('time off') &&
               !activityName.toLowerCase().includes('holiday') &&
               !activityName.toLowerCase().includes('sick') &&
               !activityName.toLowerCase().includes('absence') &&
               !activityName.toLowerCase().includes('vacation') &&
               !activityName.toLowerCase().includes('leave') &&
               activityCategory !== 'TimeOff';
      });
      
      // Group schedule by user and date
      filteredScheduleData.forEach(scheduleItem => {
        const key = `${scheduleItem.userId}_${scheduleItem.date}`;
        if (!scheduleByUserDate[key]) {
          scheduleByUserDate[key] = [];
        }
        scheduleByUserDate[key].push(scheduleItem);
      });
      
      // Group actual offline activities by user and date
      const offlineByUserDate = {};
      actualData.forEach(offlineItem => {
        const key = `${offlineItem.userId}_${offlineItem.date}`;
        if (!offlineByUserDate[key]) {
          offlineByUserDate[key] = [];
        }
        offlineByUserDate[key].push(offlineItem);
      });
      
      // Process each user/date combination
      Object.keys(scheduleByUserDate).forEach(key => {
        const [userId, date] = key.split('_');
        const userSchedule = scheduleByUserDate[key];
        
        // Sort schedule by end time to find last scheduled activity of the day
        userSchedule.sort((a, b) => {
          const aTime = a.end ? a.end.getTime() : 0;
          const bTime = b.end ? b.end.getTime() : 0;
          return bTime - aTime; // Sort descending to get last activity first
        });
        
        const lastScheduledActivity = userSchedule[0];
        
        if (!lastScheduledActivity || !lastScheduledActivity.end) {
          console.log(`No end time for user ${userId} on ${date}`);
          return;
        }
        
        const scheduledEndTime = lastScheduledActivity.end;
        
        // Get offline activities for this user/date
        const userOfflineActivities = offlineByUserDate[key] || [];
        
        if (userOfflineActivities.length === 0) {
          // No offline activities found - agent didn't log off properly
          timeOwedReport.push({
            userId: userId,
            userName: lastScheduledActivity.userName,
            teamNames: lastScheduledActivity.teamNames || 'No Team',
            date: date,
            scheduledEnd: scheduledEndTime,
            actualOfflineTime: null,
            status: 'No Logoff Found',
            timeOwed: 0, // No time owed if they didn't log off
            timeOwedType: 'none',
            scheduledActivity: lastScheduledActivity.activityLabel,
            actualActivity: null
          });
          return;
        }
        
        // Find the NEAREST offline activity to scheduled end time
        let nearestOfflineActivity = null;
        let minTimeDiff = Infinity;
        
        userOfflineActivities.forEach(offlineActivity => {
          const offlineTime = offlineActivity.endTime;
          const timeDiff = Math.abs(offlineTime - scheduledEndTime);
          
          if (timeDiff < minTimeDiff) {
            minTimeDiff = timeDiff;
            nearestOfflineActivity = offlineActivity;
          }
        });
        
        if (!nearestOfflineActivity) {
          timeOwedReport.push({
            userId: userId,
            userName: lastScheduledActivity.userName,
            teamNames: lastScheduledActivity.teamNames || 'No Team',
            date: date,
            scheduledEnd: scheduledEndTime,
            actualOfflineTime: null,
            status: 'No Valid Logoff',
            timeOwed: 0,
            timeOwedType: 'none',
            scheduledActivity: lastScheduledActivity.activityLabel,
            actualActivity: null
          });
          return;
        }
        
        const actualOfflineTime = nearestOfflineActivity.endTime;
        
        // Calculate time difference in minutes
        const timeDiffMinutes = Math.round((scheduledEndTime - actualOfflineTime) / (1000 * 60));
        
        // Determine status and time owed
        let status, timeOwed, timeOwedType;
        
        if (timeDiffMinutes > 5) { // Using 5-minute grace period
          // Logged out BEFORE scheduled end (left early)
          status = 'Left Early';
          timeOwed = timeDiffMinutes; // Time OWED TO BUSINESS (agent left early)
          timeOwedType = 'toBusiness';
        } else if (timeDiffMinutes < -5) {
          // Logged out AFTER scheduled end (worked over)
          status = 'Worked Over';
          timeOwed = Math.abs(timeDiffMinutes); // Time OWED TO AGENT (worked extra)
          timeOwedType = 'toAgent';
        } else {
          // Within 5 minutes of scheduled time
          status = 'Completed';
          timeOwed = 0;
          timeOwedType = 'none';
        }
        
        timeOwedReport.push({
          userId: userId,
          userName: lastScheduledActivity.userName,
          teamNames: lastScheduledActivity.teamNames || 'No Team',
          date: date,
          scheduledEnd: scheduledEndTime,
          actualOfflineTime: actualOfflineTime,
          status: status,
          timeOwed: timeOwed,
          timeOwedType: timeOwedType,
          scheduledActivity: lastScheduledActivity.activityLabel,
          actualActivity: nearestOfflineActivity.activityLabel
        });
      });
      
      console.log(`Generated ${timeOwedReport.length} time owed report entries`);
      return timeOwedReport;
    }

    function renderTimeOwedResults(data) {
      const container = document.getElementById('timeOwedResults');
      const contentContainer = document.getElementById('timeOwedResultsContent');
      container.style.display = 'block';
      
      if (!data || data.length === 0) {
        contentContainer.innerHTML = `
          <div class="info-message">
            No time owed data found for the selected period.
          </div>
        `;
        return;
      }
      
      // Calculate statistics
      const leftEarlyCount = data.filter(item => item.status === 'Left Early').length;
      const completedCount = data.filter(item => item.status === 'Completed').length;
      const workedOverCount = data.filter(item => item.status === 'Worked Over').length;
      const noLogoffCount = data.filter(item => item.status === 'No Logoff Found' || item.status === 'No Valid Logoff').length;
      
      // Calculate totals
      const totalTimeOwedToBusiness = data
        .filter(item => item.timeOwedType === 'toBusiness')
        .reduce((sum, item) => sum + item.timeOwed, 0);
        
      const totalTimeOwedToAgent = data
        .filter(item => item.timeOwedType === 'toAgent')
        .reduce((sum, item) => sum + item.timeOwed, 0);
        
      const totalTimeOwed = totalTimeOwedToBusiness + totalTimeOwedToAgent;
      
      // Calculate averages
      const avgTimeOwedToBusiness = leftEarlyCount > 0 ? totalTimeOwedToBusiness / leftEarlyCount : 0;
      const avgTimeOwedToAgent = workedOverCount > 0 ? totalTimeOwedToAgent / workedOverCount : 0;
      
      let html = `
        <h3 class="section-title">Time Owed Report</h3>
        <div class="schedule-meta">
          <span class="pill">Total Shifts: ${data.length}</span>
          <span class="pill" style="background: #fee2e2; color: #b42318;">Left Early: ${leftEarlyCount}</span>
          <span class="pill" style="background: #dcfce7; color: #166534;">Completed: ${completedCount}</span>
          <span class="pill" style="background: #dbeafe; color: #1e40af;">Worked Over: ${workedOverCount}</span>
          <span class="pill" style="background: #f3f4f6; color: #374151;">No Logoff: ${noLogoffCount}</span>
        </div>
        
        <!-- Time Owed Summary -->
        <div class="chart-wrapper" style="margin-bottom: 20px;">
          <h4>Time Owed Summary</h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 16px;">
            <div class="metric-card" style="background: #fee2e2; border-color: #fecaca;">
              <div class="metric-label">Time Owed TO BUSINESS</div>
              <div class="metric-value" style="color: #b42318;">${formatDuration(totalTimeOwedToBusiness)}</div>
              <div style="font-size: 12px; color: #b42318;">(${leftEarlyCount} agents)</div>
            </div>
            <div class="metric-card" style="background: #dbeafe; border-color: #bfdbfe;">
              <div class="metric-label">Time Owed TO AGENT</div>
              <div class="metric-value" style="color: #1e40af;">${formatDuration(totalTimeOwedToAgent)}</div>
              <div style="font-size: 12px; color: #1e40af;">(${workedOverCount} agents)</div>
            </div>
            <div class="metric-card" style="background: #f0f9ff; border-color: #e0f2fe;">
              <div class="metric-label">Avg Owed to Business</div>
              <div class="metric-value" style="color: #0c4a6e;">${formatDuration(avgTimeOwedToBusiness)}</div>
              <div style="font-size: 12px; color: #0c4a6e;">per agent (left early)</div>
            </div>
            <div class="metric-card" style="background: #f0f9ff; border-color: #e0f2fe;">
              <div class="metric-label">Avg Owed to Agent</div>
              <div class="metric-value" style="color: #0c4a6e;">${formatDuration(avgTimeOwedToAgent)}</div>
              <div style="font-size: 12px; color: #0c4a6e;">per agent (worked over)</div>
            </div>
          </div>
        </div>
        
        <table class="schedule-table">
          <thead>
            <tr>
              <th class="sortable" data-sort="userName">User</th>
              <th class="sortable" data-sort="teamNames">Team</th>
              <th class="sortable" data-sort="date">Date</th>
              <th>Scheduled End</th>
              <th>Actual Offline Time</th>
              <th class="sortable" data-sort="status">Status</th>
              <th class="sortable" data-sort="timeOwed">Time Owed</th>
              <th>Owed To</th>
              <th>Scheduled Activity</th>
              <th>Actual Activity</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      data.forEach(row => {
        let statusClass = '';
        let statusText = '';
        let owedToText = '';
        let owedToClass = '';
        
        switch(row.status) {
          case 'Left Early':
            statusClass = 'status-logged-out-early';
            statusText = `Left ${formatDuration(row.timeOwed)} early`;
            owedToText = 'BUSINESS';
            owedToClass = 'status-time-owed';
            break;
          case 'Completed':
            statusClass = 'status-completed';
            statusText = 'On Time';
            owedToText = 'N/A';
            owedToClass = '';
            break;
          case 'Worked Over':
            statusClass = 'status-time-owed';
            statusText = `Worked ${formatDuration(row.timeOwed)} over`;
            owedToText = 'AGENT';
            owedToClass = 'status-time-owed';
            break;
          case 'No Logoff Found':
          case 'No Valid Logoff':
            statusClass = 'status-awol';
            statusText = 'No Logoff';
            owedToText = 'N/A';
            owedToClass = '';
            break;
        }
        
        html += `
          <tr>
            <td>${escapeHtml(row.userName)}</td>
            <td>${escapeHtml(row.teamNames || 'No Team')}</td>
            <td>${escapeHtml(row.date)}</td>
            <td>${row.scheduledEnd ? escapeHtml(formatTime(row.scheduledEnd)) : 'N/A'}</td>
            <td>${row.actualOfflineTime ? escapeHtml(formatTime(row.actualOfflineTime)) : 'N/A'}</td>
            <td><span class="${statusClass}">${statusText}</span></td>
            <td>${row.timeOwed > 0 ? formatDuration(row.timeOwed) : '0m'}</td>
            <td>${owedToText ? `<span class="${owedToClass}">${owedToText}</span>` : 'N/A'}</td>
            <td>${escapeHtml(row.scheduledActivity || 'N/A')}</td>
            <td>${escapeHtml(row.actualActivity || 'N/A')}</td>
          </tr>
        `;
      });
      
      html += `</tbody></table>`;
      
      contentContainer.innerHTML = html;
      
      addTimeOwedTableSorting();
    }

    function addTimeOwedTableSorting() {
      const table = document.querySelector('#timeOwedResultsContent table');
      if (!table) return;
      
      const headers = table.querySelectorAll('th.sortable');
      headers.forEach(header => {
        header.addEventListener('click', () => {
          const sortField = header.getAttribute('data-sort');
          const currentSort = document.getElementById('timeOwedSort').value;
          const currentOrder = document.getElementById('timeOwedSortOrder').value;
          
          if (sortField === currentSort) {
            document.getElementById('timeOwedSortOrder').value = currentOrder === 'asc' ? 'desc' : 'asc';
          } else {
            document.getElementById('timeOwedSort').value = sortField;
            document.getElementById('timeOwedSortOrder').value = 'asc';
          }
          
          applyTimeOwedSorting();
        });
      });
    }

    function applyTimeOwedSorting() {
      const data = currentDisplayedData.timeowed;
      const sortField = document.getElementById('timeOwedSort').value;
      const sortOrder = document.getElementById('timeOwedSortOrder').value;
      
      if (!data || data.length === 0) return;
      
      const sortedData = [...data].sort((a, b) => {
        let aVal = a[sortField];
        let bVal = b[sortField];
        
        if (sortField === 'date') {
          aVal = new Date(aVal.split('-').reverse().join('-'));
          bVal = new Date(bVal.split('-').reverse().join('-'));
        }
        
        if (sortField === 'timeOwed') {
          aVal = aVal || 0;
          bVal = bVal || 0;
        }
        
        if (aVal < bVal) return sortOrder === 'asc' ? -1 : 1;
        if (aVal > bVal) return sortOrder === 'asc' ? 1 : -1;
        return 0;
      });
      
      currentDisplayedData.timeowed = sortedData;
      renderTimeOwedResults(sortedData);
    }

    // ===== EXPORT FUNCTIONS =====
    function exportToCSV(data, filename) {
      if (!data || data.length === 0) {
        showMessage('No data to export', 'error');
        return;
      }

      const headers = Object.keys(data[0]);
      const csvContent = [
        headers.join(','),
        ...data.map(row => 
          headers.map(header => {
            const value = row[header] || '';
            return typeof value === 'string' && value.includes(',') ? `"${value}"` : value;
          }).join(',')
        )
      ].join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function exportScheduleToCSV() {
      if (currentDisplayedData.schedule.length === 0) {
        showMessage('No schedule data to export', 'error');
        return;
      }

      let exportData = currentDisplayedData.schedule;
      const selectedActivities = dropdowns.activityFilter ? dropdowns.activityFilter.getSelectedValues() : [];
      if (selectedActivities.length > 0) {
        exportData = currentDisplayedData.schedule.filter(activity => 
          selectedActivities.includes(activity.activityLabel)
        );
      }

      const csvData = exportData.map(activity => ({
        Date: activity.date,
        User: activity.userName,
        Team: activity.teamNames || 'No Team',
        Activity: activity.activityLabel,
        Start: formatTime(activity.start),
        End: formatTime(activity.end),
        Duration: formatDuration(activity.durationMinutes)
      }));

      exportToCSV(csvData, `schedule_${new Date().toISOString().split('T')[0]}.csv`);
    }

    function exportActualActivityToCSV() {
      if (currentDisplayedData.actual.length === 0) {
        showMessage('No actual activity data to export', 'error');
        return;
      }

      let exportData = currentDisplayedData.actual;
      const selectedActivities = dropdowns.actualActivityFilter ? dropdowns.actualActivityFilter.getSelectedValues() : [];
      if (selectedActivities.length > 0) {
        exportData = currentDisplayedData.actual.filter(activity => 
          selectedActivities.includes(activity.activityLabel)
        );
      }

      const csvData = exportData.map(activity => ({
        Date: activity.date,
        User: activity.userName,
        Team: activity.teamNames || 'No Team',
        Activity: activity.activityLabel,
        Start: formatTime(activity.startTime),
        End: formatTime(activity.endTime),
        Duration: formatDuration(activity.durationMinutes)
      }));

      exportToCSV(csvData, `actual_activity_${new Date().toISOString().split('T')[0]}.csv`);
    }

    function exportOvertimeSummaryToCSV() {
      if (currentDisplayedData.overtime.length === 0) {
        showMessage('No overtime data to export', 'error');
        return;
      }

      let exportData = currentDisplayedData.overtime;
      const selectedActivities = dropdowns.overtimeActivityFilter ? dropdowns.overtimeActivityFilter.getSelectedValues() : [];
      if (selectedActivities.length > 0) {
        exportData = currentDisplayedData.overtime.filter(user => 
          user.activities.some(activity => selectedActivities.includes(activity.activity))
        );
      }

      const csvData = exportData.map(item => ({
        Agent: item.user,
        Team: item.teamNames || 'No Team',
        'Total Overtime Hours': item.totalHours,
        '1.0 Rate Hours': item.rate1Hours,
        '1.5 Rate Hours': item.rate1_5Hours,
        '2.0 Rate Hours': item.rate2Hours
      }));

      exportToCSV(csvData, `overtime_summary_${new Date().toISOString().split('T')[0]}.csv`);
    }

    function exportOvertimeDetailsToCSV() {
      if (currentOvertimeData.length === 0) {
        showMessage('No overtime data to export', 'error');
        return;
      }

      let exportData = [];
      const selectedActivities = dropdowns.overtimeActivityFilter ? dropdowns.overtimeActivityFilter.getSelectedValues() : [];
      
      currentOvertimeData.forEach(item => {
        const filteredActivities = selectedActivities.length > 0 
          ? item.activities.filter(activity => selectedActivities.includes(activity.activity))
          : item.activities;
          
        filteredActivities.forEach(activity => {
          exportData.push({
            Agent: item.user,
            Team: item.teamNames || 'No Team',
            Date: activity.date,
            'Start Time': activity.startTime,
            'End Time': activity.endTime,
            Duration: activity.duration,
            'Overtime Type': activity.activity,
            Rate: activity.rate,
            Hours: activity.hours
          });
        });
      });

      exportToCSV(exportData, `overtime_details_${new Date().toISOString().split('T')[0]}.csv`);
    }

    function exportAbsenceToCSV() {
      if (currentDisplayedData.absence.length === 0) {
        showMessage('No absence data to export', 'error');
        return;
      }

      let exportData = currentDisplayedData.absence;
      const selectedActivities = dropdowns.absenceActivityFilter ? dropdowns.absenceActivityFilter.getSelectedValues() : [];
      if (selectedActivities.length > 0) {
        exportData = currentDisplayedData.absence.filter(user => 
          user.absenceDetails.some(detail => selectedActivities.includes(detail.type))
        );
      }

      const csvData = exportData.map(item => ({
        Agent: item.user,
        Team: item.teamNames || 'No Team',
        'Total Absence Hours': item.totalHours,
        'Absence Days': item.absenceDays,
        Instances: item.instances,
        'Average Hours per Instance': item.averageHoursPerInstance,
        Status: item.exceedsThreshold ? 'Above Threshold' : 'Within Limits'
      }));

      exportToCSV(csvData, `absence_summary_${new Date().toISOString().split('T')[0]}.csv`);
    }

    function exportAbsenceDetailsToCSV() {
      if (currentAbsenceData.length === 0) {
        showMessage('No absence data to export', 'error');
        return;
      }

      let exportData = [];
      const selectedActivities = dropdowns.absenceActivityFilter ? dropdowns.absenceActivityFilter.getSelectedValues() : [];
      
      currentAbsenceData.forEach(item => {
        const filteredDetails = selectedActivities.length > 0 
          ? item.absenceDetails.filter(detail => selectedActivities.includes(detail.type))
          : item.absenceDetails;
          
        filteredDetails.forEach(detail => {
          exportData.push({
            Agent: item.user,
            Team: item.teamNames || 'No Team',
            Date: detail.date,
            'Absence Type': detail.type,
            Duration: detail.duration,
            Hours: detail.hours
          });
        });
      });

      exportToCSV(exportData, `absence_details_${new Date().toISOString().split('T')[0]}.csv`);
    }

    function exportLateReportToCSV() {
      if (currentDisplayedData.late.length === 0) {
        showMessage('No late report data to export', 'error');
        return;
      }

      const csvData = currentDisplayedData.late.map(row => ({
        Date: row.date,
        User: row.userName,
        Team: row.teamNames || 'No Team',
        'Scheduled Start': row.scheduledStart ? formatTime(row.scheduledStart) : 'N/A',
        'Actual Start': row.actualStart ? formatTime(row.actualStart) : 'N/A',
        Status: row.status,
        'Duration Late/Early': row.durationLate !== null ? 
          (row.status === 'Late' ? `+${formatDuration(Math.ceil(row.durationLate / 60))}` : 
           row.status === 'Early' ? `-${formatDuration(Math.ceil(row.durationLate / 60))}` : '0m') : 'N/A',
        'Scheduled Activity': row.scheduledActivity || 'N/A',
        'Actual Activity': row.actualActivity || 'N/A'
      }));

      exportToCSV(csvData, `late_report_${new Date().toISOString().split('T')[0]}.csv`);
    }

    function exportTimeOwedReportToCSV() {
      if (currentDisplayedData.timeowed.length === 0) {
        showMessage('No time owed data to export', 'error');
        return;
      }

      const csvData = currentDisplayedData.timeowed.map(row => ({
        Date: row.date,
        User: row.userName,
        Team: row.teamNames || 'No Team',
        'Scheduled End': row.scheduledEnd ? formatTime(row.scheduledEnd) : 'N/A',
        'Actual Offline Time': row.actualOfflineTime ? formatTime(row.actualOfflineTime) : 'N/A',
        Status: row.status,
        'Time Owed': row.timeOwed > 0 ? formatDuration(row.timeOwed) : '0m',
        'Owed To': row.timeOwedType === 'toBusiness' ? 'BUSINESS' : 
                   row.timeOwedType === 'toAgent' ? 'AGENT' : 'N/A',
        'Scheduled Activity': row.scheduledActivity || 'N/A',
        'Actual Activity': row.actualActivity || 'N/A'
      }));

      exportToCSV(csvData, `time_owed_${new Date().toISOString().split('T')[0]}.csv`);
    }
  </script>
</body>
</html>
