<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Attendance Insights - By IPI</title>
  <style>
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D;
      --pill:#e9f6f0;
    }
    body{font-family:"Aptos","Segoe UI",Arial,sans-serif;margin:20px;padding:20px;max-width:1400px;background:var(--light-bg);color:var(--text-color)}
    #logo-container{text-align:center;margin-bottom:20px} #logo{width:300px}
    h1{margin:0 0 16px}
    .card{background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;padding:24px;margin-top:16px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    label{display:block;font-weight:600;margin-bottom:6px}
    select,input,button{padding:10px;border:1px solid var(--border-color);border-radius:6px;background:var(--card-bg);font-size:14px}
    button{background:var(--primary-color);color:#fff;font-weight:600;cursor:pointer;transition:background .2s}
    button:hover{background:var(--secondary-color)} button:disabled{background:var(--text-light);cursor:not-allowed}
    .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px 24px;align-items:start}
    .inline{display:grid;grid-template-columns:1fr auto 1fr;gap:16px;align-items:center} .inline span{color:var(--text-light)}
    .full-width-btn{width:100%;padding:14px 18px;font-size:16px;margin-top:12px}
    .muted{color:var(--text-light)} .mono{font-family:ui-monospace,Consolas,Menlo,monospace}
    .loading{opacity:.6;pointer-events:none}
    .progress-bar{width:100%;height:8px;background:var(--border-color);border-radius:4px;overflow:hidden;margin:10px 0}
    .progress-fill{height:100%;background:var(--primary-color);transition:width .3s}
    .stats{display:flex;gap:16px;margin:16px 0;flex-wrap:wrap}
    .stat-card{flex:1;min-width:180px;border:1px solid var(--border-color);border-radius:8px;padding:16px;text-align:center;background:var(--card-bg)}
    .stat-number{font-size:22px;color:#63AB8F;font-weight:700}
    .stat-label{font-size:13px;color:var(--text-light)}
    .filter-controls{display:flex;gap:12px;margin-top:8px;flex-wrap:wrap}
    .filter-controls > *{flex:1;min-width:160px}
    .future-date{color:#ccc;cursor:not-allowed}
    .attendance-table{width:100%;border-collapse:collapse;margin-top:12px}
    .attendance-table th,.attendance-table td{border-bottom:1px solid var(--border-color);padding:8px 10px;vertical-align:top}
    .attendance-table th{background:var(--primary-color);color:#fff;text-align:left}
    .late-yes{color:#dc2626;font-weight:700}
    .late-no{color:#16a34a;font-weight:700}
    .on-time{color:#16a34a;font-weight:600}
    .late{color:#dc2626;font-weight:600}
    .activity-timeline {background: #f8f9fa; border-radius: 8px; padding: 12px; margin-top: 8px;}
    .activity-item {display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #e9ecef;}
    .activity-item:last-child {border-bottom: none;}
    .activity-time {font-family: ui-monospace, Consolas, Menlo, monospace; color: #495057;}
    .activity-status {font-weight: 600; color: #2c3e50;}
    .schedule-match {background-color: #f0f9ff; border-left: 4px solid #3b82f6;}
    .schedule-mismatch {background-color: #fef2f2; border-left: 4px solid #ef4444;}
  </style>
</head>
<body>
  <div id="logo-container">
    <img id="logo" src="https://raw.githubusercontent.com/gmcglynn88/ExternalWorkCreation/main/Consultinglogo.png" alt="Company Logo">
  </div>
  <h1>Attendance Insights - By IPI</h1>
  <button id="signinBtn" style="display:none;margin-bottom:12px;">Sign in to Genesys Cloud</button>

  <div id="authStatus" class="card" style="display:none;">
    <div style="text-align:center;padding:20px;">
      <div style="font-size:18px;color:var(--secondary-color);margin-bottom:8px;">üîê Authenticating‚Ä¶</div>
      <div class="muted">Connecting to Genesys Cloud</div>
    </div>
  </div>

  <div id="mainContent" style="display:none;">
    <div class="card">
      <h2 style="margin:0 0 12px;">Select Date Range & Filters</h2>
      <div class="controls">
        <div>
          <label>Date Range</label>
          <div class="inline">
            <input id="fromDate" type="date"/>
            <span>to</span>
            <input id="toDate" type="date"/>
          </div>
          <div class="muted" style="margin-top:6px;font-size:13px;">
            Best used on small ranges (e.g. 1‚Äì7 days).
          </div>
        </div>
        <div>
          <label>Business Unit & Management Unit</label>
          <div class="filter-controls">
            <select id="businessUnitSelect">
              <option value="">Loading business units...</option>
            </select>
            <select id="managementUnitSelect">
              <option value="">Select business unit first</option>
            </select>
          </div>
          <label style="margin-top:12px;">Team & User Filters</label>
          <div class="filter-controls">
            <select id="teamSelect">
              <option value="all">All teams</option>
            </select>
            <select id="userSelect">
              <option value="all">All users</option>
            </select>
          </div>
          <input id="userSearch" type="text" placeholder="Search by user or team name" style="margin-top:8px;width:100%"/>
        </div>
      </div>
      <button id="fetchBtn" class="full-width-btn">Run Attendance Report</button>
    </div>

    <div id="statusMessage" class="muted" style="margin-top:10px;"></div>
    <div id="errorMessage" style="color:#dc2626;margin-top:6px;"></div>

    <div id="progressSection" style="display:none;">
      <div class="card">
        <h3 style="margin:0 0 8px;">Fetching Analytics</h3>
        <div class="muted" id="progressInfo">Requesting user statistics‚Ä¶</div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
        <div style="display:flex;justify-content:space-between;font-size:14px" class="muted">
          <span id="progressText">0%</span><span id="chunkText">Step 0/0</span>
        </div>
      </div>
    </div>

    <div id="resultsSection" style="display:none;">
      <div class="card">
        <h2 style="margin:0 0 12px;">Schedule vs Actual Activities</h2>
        <div class="stats">
          <div class="stat-card">
            <div class="stat-number" id="totalShifts">0</div>
            <div class="stat-label">Total Shifts</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="lateShifts">0</div>
            <div class="stat-label">Late Shifts</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="uniqueUsers">0</div>
            <div class="stat-label">Unique Users</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="avgLateMinutes">0</div>
            <div class="stat-label">Avg Late Minutes</div>
          </div>
        </div>
        <div id="attendanceResults"></div>
      </div>
    </div>
  </div>

  <script>
    // ===== Config =====
    const CONFIG = {
      clientId: 'fe305808-b368-4547-8af9-325d28d552bb',
      redirectUri: 'https://gmcglynn88.github.io/Late_Break-Report/',
      loginHost: 'https://login.mypurecloud.ie',
      apiHost: 'https://api.mypurecloud.ie'
    };

    // Definition of "late"
    const ATTENDANCE_CONFIG = {
      lateThresholdMinutes: 5,      // >= 5 mins after scheduled start
    };

    // ===== State =====
    const state = {
      token: null,
      users: [],
      usersById: {},
      teams: [],
      teamMembersByTeamId: {},
      teamsByUserId: {},
      businessUnits: [],
      managementUnits: [],
      scheduleData: {},
      activityCodes: {}, // Store activity code mappings
      attendanceRows: []
    };

    // ===== Utils =====
    const $ = id => document.getElementById(id);
    const setStatus = (msg,err=false)=>{ $('statusMessage').textContent = err?'':(msg||''); $('errorMessage').textContent = err?(msg||''):''; };
    const fmt = d => { if(!d) return 'N/A'; try{return new Date(d).toLocaleString()}catch{return 'N/A'} };
    const fmtTime = d => { if(!d) return 'N/A'; try{return new Date(d).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}catch{return 'N/A'} };
    const fmtDMY = s => { if(!s||s.length<10) return s||''; const [y,m,d]=s.slice(0,10).split('-'); return `${d}-${m}-${y}`; };
    function setLoading(v){ $('mainContent').classList.toggle('loading', !!v); }
    function updateProgress(p,cur,total){ $('progressFill').style.width = `${p}%`; $('progressText').textContent = `${Math.round(p)}%`; $('chunkText').textContent = `Step ${cur}/${total}`; }
    function showProgress(info){ $('progressSection').style.display='block'; $('resultsSection').style.display='none'; $('progressInfo').textContent = info || ''; }
    function hideProgress(){ $('progressSection').style.display='none'; }

    // Format duration as HH:MM:SS
    function formatDuration(ms) {
      if (!ms || ms <= 0) return '00:00:00';
      const seconds = Math.floor(ms / 1000);
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // Calculate minutes difference
    function getMinutesDifference(startTime, endTime) {
      return Math.round((new Date(endTime) - new Date(startTime)) / 60000);
    }

    // Add helper function to escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Get Monday of the week for a given date
    function getWeekStart(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is Sunday
      return new Date(d.setDate(diff)).toISOString().split('T')[0];
    }

    // ===== Date Range Limiting =====
    function setupDateLimits() {
      const today = new Date().toISOString().split('T')[0];
      $('fromDate').max = today; $('toDate').max = today;
      $('fromDate').addEventListener('change', function() {
        if (this.value > today) this.value = today;
        if ($('toDate').value && this.value > $('toDate').value) $('toDate').value = this.value;
      });
      $('toDate').addEventListener('change', function() {
        if (this.value > today) this.value = today;
        if ($('fromDate').value && this.value < $('fromDate').value) $('fromDate').value = this.value;
      });
    }

    // ===== Auth =====
    function parseTokenFromHash(){
      const params = new URLSearchParams(location.hash.replace(/^#/, ''));
      return { token: params.get('access_token'), error: params.get('error'), errorDescription: params.get('error_description') };
    }
    function authUrl(){
      return `${CONFIG.loginHost}/oauth/authorize?client_id=${encodeURIComponent(CONFIG.clientId)}&response_type=token&redirect_uri=${encodeURIComponent(CONFIG.redirectUri)}`;
    }
    function showMain(){ $('authStatus').style.display='none'; $('mainContent').style.display='block'; }

    function initAuth(){
      const {token, error} = parseTokenFromHash();
      if(location.hash) history.replaceState(null,'',location.pathname);

      if(token){
        sessionStorage.removeItem('gc_auto_auth_attempted');
        state.token = token;
        showMain();
        setupDateLimits();
        fetchBusinessUnits();
        fetchAllUsers();
        fetchAllTeamsAndMembers();
        return;
      }

      const attempted = sessionStorage.getItem('gc_auto_auth_attempted');
      if(!attempted && !error){
        sessionStorage.setItem('gc_auto_auth_attempted','1');
        $('authStatus').style.display='block';
        location.assign(authUrl());
        return;
      }

      $('signinBtn').style.display = 'inline-block';
      $('signinBtn').onclick = () => { sessionStorage.setItem('gc_auto_auth_attempted','1'); location.assign(authUrl()); };
      $('authStatus').style.display = 'none';
    }

    // ===== API helper =====
    async function api(path, options = {}){
      if(!state.token) throw new Error('Not authenticated');
      const config = {
        headers: {
          'Authorization': `Bearer ${state.token}`,
          ...options.headers
        },
        ...options
      };
      
      const res = await fetch(`${CONFIG.apiHost}${path}`, config);
      if(res.status===401||res.status===403) throw new Error(`Authentication error (${res.status}). Please refresh.`);
      if(!res.ok){ 
        const t = await res.text().catch(()=> '');
        throw new Error(`API Error: ${res.status} ${res.statusText}${t?` - ${t.slice(0,200)}`:''}`);
      }
      return res.json();
    }

    // ===== Business Units =====
    async function fetchBusinessUnits(){
      try{
        const data = await api('/api/v2/workforcemanagement/businessunits');
        state.businessUnits = data.entities || [];
        const select = $('businessUnitSelect');
        select.innerHTML = '<option value="">Select Business Unit</option>' +
          state.businessUnits.map(bu => `<option value="${bu.id}">${bu.name}</option>`).join('');
      }catch(e){
        console.error('Failed to fetch business units:', e);
        $('businessUnitSelect').innerHTML = '<option value="">Failed to load business units</option>';
      }
    }

    // ===== Management Units =====
    async function fetchManagementUnits(businessUnitId){
      try{
        const data = await api(`/api/v2/workforcemanagement/managementunits?businessUnitId=${businessUnitId}`);
        state.managementUnits = data.entities || [];
        const select = $('managementUnitSelect');
        select.innerHTML = '<option value="">Select Management Unit</option>' +
          state.managementUnits.map(mu => `<option value="${mu.id}">${mu.name}</option>`).join('');
      }catch(e){
        console.error('Failed to fetch management units:', e);
        $('managementUnitSelect').innerHTML = '<option value="">Failed to load management units</option>';
      }
    }

    // ===== Activity Codes =====
    async function fetchActivityCodes(businessUnitId) {
      try {
        console.log('Fetching activity codes for business unit:', businessUnitId);
        const data = await api(`/api/v2/workforcemanagement/businessunits/${businessUnitId}/activitycodes`);
        state.activityCodes = {};
        
        (data.entities || []).forEach(activity => {
          state.activityCodes[activity.id] = {
            name: activity.name,
            category: activity.category
          };
        });
        
        console.log('Loaded activity codes:', state.activityCodes);
        return state.activityCodes;
      } catch (e) {
        console.error('Failed to fetch activity codes:', e);
        return {};
      }
    }

    // ===== Users =====
    async function fetchAllUsers(){
      try{
        setStatus('Loading users‚Ä¶'); setLoading(true);
        let all=[], page=1, size=100;
        while(true){
          const data = await api(`/api/v2/users?pageSize=${size}&pageNumber=${page}`);
          const ents = data?.entities||[];
          all = all.concat(ents);
          if(!data?.nextUri || ents.length<size) break;
          page++;
        }
        state.users = all.map(u=>({id:u.id,name:u.name||'',email:u.email||''})).sort((a,b)=>a.name.localeCompare(b.name));
        state.usersById = {};
        state.users.forEach(u=>{ state.usersById[u.id]=u; });
        populateUserSelect(state.users);
        setStatus(`Loaded ${state.users.length} users`);
      }catch(e){
        setStatus(`Failed to load users: ${e.message}`, true);
        $('userSelect').innerHTML='<option value="all">Failed to load users</option>';
      }finally{ setLoading(false); }
    }

    function populateUserSelect(users){
      const sel=$('userSelect');
      sel.innerHTML = '<option value="all">All users</option>' +
        users.map(u=>`<option value="${u.id}">${u.name||'(Unnamed)'}</option>`).join('');
    }

    // ===== Teams & members =====
    function populateTeamSelect(teams){
      const sel=$('teamSelect');
      sel.innerHTML = '<option value="all">All teams</option>' +
        teams.map(t=>`<option value="${t.id}">${t.name||'(Unnamed team)'}</option>`).join('');
    }

    async function fetchTeamMembers(teamId){
      let members = [];
      let page=1, size=100;
      while(true){
        const data = await api(`/api/v2/teams/${teamId}/members?pageSize=${size}&pageNumber=${page}`);
        const ents = data?.entities || data?.members || [];
        members = members.concat(ents);
        if(!data?.nextUri || ents.length<size) break;
        page++;
      }
      return members.map(m => ({
        id: m.id || m.user?.id,
        name: m.name || m.user?.name || ''
      })).filter(m=>m.id);
    }

    async function fetchAllTeamsAndMembers(){
      try{
        setLoading(true);
        setStatus('Loading teams‚Ä¶');

        let all=[], page=1, size=100;
        while(true){
          const data = await api(`/api/v2/teams?pageSize=${size}&pageNumber=${page}`);
          const ents = data?.entities||[];
          all = all.concat(ents);
          if(!data?.nextUri || ents.length<size) break;
          page++;
        }
        state.teams = all.map(t=>({id:t.id,name:t.name||'(Unnamed team)'})).sort((a,b)=>a.name.localeCompare(b.name));
        populateTeamSelect(state.teams);

        state.teamMembersByTeamId = {};
        state.teamsByUserId = {};
        if(!state.teams.length){ setStatus('No teams found'); return; }

        showProgress('Loading team members‚Ä¶');
        let step = 0;
        for(const team of state.teams){
          step++;
          updateProgress( (step/state.teams.length)*100, step, state.teams.length );
          try{
            const members = await fetchTeamMembers(team.id);
            state.teamMembersByTeamId[team.id] = members;
            for(const m of members){
              if(!state.teamsByUserId[m.id]) state.teamsByUserId[m.id] = [];
              state.teamsByUserId[m.id].push({id:team.id,name:team.name});
            }
          }catch(e){
            console.warn('Failed to fetch members for team', team.id, e);
          }
        }
        hideProgress();
        setStatus('Users & teams loaded');
      }catch(e){
        hideProgress();
        console.error(e);
        setStatus('Failed to load teams: ' + e.message, true);
      }finally{
        setLoading(false);
      }
    }

    // Helper function to get week IDs for a date range
    async function getWeekIdsForDateRange(businessUnitId, fromDate, toDate) {
      try {
        // Get business unit weeks
        const weeksResponse = await api(`/api/v2/workforcemanagement/businessunits/${businessUnitId}/weeks`);
        const allWeeks = weeksResponse.entities || [];
        
        // Filter weeks that overlap with our date range
        const targetWeeks = allWeeks.filter(week => {
          const weekStart = week.weekStart || week.startDate;
          const weekEnd = week.weekEnd || week.endDate;
          
          if (!weekStart || !weekEnd) return false;
          
          // Check if week overlaps with our date range
          return (weekStart <= toDate && weekEnd >= fromDate);
        });
        
        return targetWeeks.map(week => week.id);
      } catch (e) {
        console.error('Failed to get week IDs:', e);
        return [];
      }
    }

    // Helper function to get schedule ID for a user in a specific week
    async function getScheduleIdForUserWeek(businessUnitId, weekId, userId) {
      try {
        // Get the schedule for the week
        const scheduleResponse = await api(
          `/api/v2/workforcemanagement/businessunits/${businessUnitId}/weeks/${weekId}/schedules`
        );
        
        if (scheduleResponse && scheduleResponse.entities) {
          // Find the schedule that contains our user
          for (const schedule of scheduleResponse.entities) {
            if (schedule.user && schedule.user.id === userId) {
              return schedule.id;
            }
            
            // Also check in metadata if user list exists there
            if (schedule.metadata && schedule.metadata.users) {
              const userInSchedule = schedule.metadata.users.find(u => u.id === userId);
              if (userInSchedule) {
                return schedule.id;
              }
            }
          }
        }
        
        return null;
      } catch (e) {
        console.error(`Failed to get schedule ID for user ${userId} in week ${weekId}:`, e);
        return null;
      }
    }

    // ===== CORRECT SCHEDULE API APPROACH =====
    async function fetchScheduleData(businessUnitId, managementUnitId, fromDate, toDate) {
      console.log('Using CORRECT SCHEDULE API approach...');
      
      const scheduleData = {
        userSchedules: {},
        schedulePeriods: []
      };

      try {
        // First, fetch activity codes using the API you specified
        await fetchActivityCodes(businessUnitId);

        // Get users from the management unit
        console.log('Getting users from management unit...');
        const muUsersResponse = await api(`/api/v2/workforcemanagement/managementunits/${managementUnitId}/users`);
        const muUsers = muUsersResponse.entities || [];
        console.log(`Found ${muUsers.length} users in management unit`, muUsers);

        if (muUsers.length === 0) {
          console.log('No users found in management unit');
          return scheduleData;
        }

        showProgress(`Fetching schedules for ${muUsers.length} users...`);
        
        // Get the week IDs for the date range
        const weekIds = await getWeekIdsForDateRange(businessUnitId, fromDate, toDate);
        console.log('Week IDs for date range:', weekIds);

        if (weekIds.length === 0) {
          console.log('No week IDs found for the date range');
          return scheduleData;
        }

        let userIndex = 0;

        // Fetch schedules for each user in the management unit
        for (const user of muUsers) {
          userIndex++;
          updateProgress((userIndex / muUsers.length) * 50, userIndex, muUsers.length);
          
          try {
            console.log(`Fetching schedule for user: ${user.name} (${user.id})`);
            
            // Try to get user's schedule for each week
            const userShifts = [];
            
            for (const weekId of weekIds) {
              try {
                // Get the schedule ID for this user and week
                const scheduleId = await getScheduleIdForUserWeek(businessUnitId, weekId, user.id);
                
                if (scheduleId) {
                  console.log(`Found schedule ID ${scheduleId} for user ${user.name} in week ${weekId}`);
                  
                  // Now get the detailed schedule using the correct API
                  const detailedSchedule = await api(
                    `/api/v2/workforcemanagement/businessunits/${businessUnitId}/weeks/${weekId}/schedules/${scheduleId}`
                  );
                  
                  console.log(`Detailed schedule for ${user.name}:`, detailedSchedule);
                  
                  // Process the detailed schedule
                  if (detailedSchedule && detailedSchedule.shifts) {
                    detailedSchedule.shifts.forEach(shift => {
                      if (shift.activities) {
                        shift.activities.forEach(activity => {
                          const activityStart = new Date(activity.startDate);
                          const activityEnd = new Date(activityStart.getTime() + activity.lengthMinutes * 60000);
                          
                          // Check if this activity falls within our date range
                          const activityDate = activityStart.toISOString().split('T')[0];
                          if (activityDate >= fromDate && activityDate <= toDate) {
                            // Map activity code to name using the activity codes API
                            const activityCodeId = activity.activityCodeId;
                            const activityName = state.activityCodes[activityCodeId]?.name || `Activity ${activityCodeId}`;
                            
                            userShifts.push({
                              startDate: activity.startDate,
                              endDate: activityEnd.toISOString(),
                              activityName: activityName,
                              activityCodeId: activityCodeId,
                              lengthMinutes: activity.lengthMinutes,
                              paid: activity.paid,
                              weekId: weekId,
                              scheduleId: scheduleId
                            });
                          }
                        });
                      }
                    });
                  }
                } else {
                  console.log(`No schedule found for user ${user.name} in week ${weekId}`);
                }
              } catch (weekError) {
                console.warn(`Failed to get schedule for user ${user.name} in week ${weekId}:`, weekError);
                // Continue with other weeks
              }
            }

            if (userShifts.length > 0) {
              scheduleData.userSchedules[user.id] = {
                shifts: userShifts
              };
              console.log(`Found ${userShifts.length} shifts for user ${user.name}`);
            } else {
              console.log(`No shifts found for user ${user.name} in the date range`);
            }

          } catch (e) {
            console.warn(`Failed to fetch schedule for user ${user.name}:`, e);
            // Continue with other users even if one fails
          }
        }

        console.log('Final schedule data collected:', scheduleData);
        return scheduleData;

      } catch (e) {
        console.error('Schedule API approach failed:', e);
        
        // Fallback to Management Unit schedules query
        console.log('Trying Management Unit schedules query as fallback...');
        try {
          const muBody = {
            startDate: `${fromDate}T00:00:00.000Z`,
            endDate: `${toDate}T23:59:59.999Z`
          };

          const muResponse = await fetch(
            `${CONFIG.apiHost}/api/v2/workforcemanagement/managementunits/${managementUnitId}/schedules/query`,
            {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${state.token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(muBody)
            }
          );

          if (muResponse.ok) {
            const muData = await muResponse.json();
            console.log('Management Unit schedule query successful:', muData);
            
            // Process the user schedules
            if (muData.userSchedules) {
              Object.keys(muData.userSchedules).forEach(userId => {
                const userSchedule = muData.userSchedules[userId];
                if (userSchedule.shifts && userSchedule.shifts.length > 0) {
                  scheduleData.userSchedules[userId] = {
                    shifts: userSchedule.shifts.map(shift => {
                      // Process each activity in the shift
                      const activities = (shift.activities || []).map(activity => {
                        const activityCodeId = activity.activityCodeId;
                        const activityName = state.activityCodes[activityCodeId]?.name || `Activity ${activityCodeId}`;
                        
                        return {
                          startDate: activity.startDate,
                          endDate: new Date(new Date(activity.startDate).getTime() + activity.lengthMinutes * 60000).toISOString(),
                          activityName: activityName,
                          activityCodeId: activityCodeId,
                          lengthMinutes: activity.lengthMinutes
                        };
                      });

                      return {
                        startDate: shift.startDate,
                        endDate: shift.endDate,
                        activities: activities
                      };
                    })
                  };
                }
              });
            }
          }
        } catch (fallbackError) {
          console.error('Management Unit fallback also failed:', fallbackError);
        }
        
        return scheduleData;
      }
    }

    // ===== Process Schedule vs Actual =====
    function processScheduleVsActual(scheduleData, analyticsData) {
      const rows = [];
      const details = analyticsData?.userDetails || analyticsData?.results || [];
      
      console.log(`Processing ${details.length} user details`);
      console.log('Schedule data available:', scheduleData);
      console.log('Users with schedules:', Object.keys(scheduleData.userSchedules));

      // If no schedule data, create rows from analytics data only
      if (Object.keys(scheduleData.userSchedules).length === 0) {
        console.log('No schedule data available, showing analytics data only');
        
        for (const userDetail of details) {
          try {
            const userId = userDetail.userId || userDetail.user?.id;
            if (!userId) continue;
            
            const userName = state.usersById[userId]?.name || userDetail.user?.name || `User ${userId}`;
            
            // Get user's activities
            const activities = userDetail.routingStatus || userDetail.activities || [];
            if (!activities.length) continue;

            // Create rows for actual activities
            for (const activity of activities.slice(0, 10)) { // Limit to first 10 activities
              const actualStart = activity.startTime || activity.dateStart || activity.conversationStart;
              const actualStatus = activity.status || activity.presence || activity.systemPresence || 'Unknown';
              
              if (!actualStart) continue;

              const userTeams = state.teamsByUserId[userId] || [];
              const teamNames = userTeams.map(t => t.name).join(', ');
              const teamIds = userTeams.map(t => t.id);

              const row = {
                userId,
                userName,
                teamNames,
                teamIds,
                date: actualStart.slice(0, 10),
                scheduledActivity: 'No Schedule Data',
                scheduledStart: null,
                scheduledEnd: null,
                actualStart,
                actualActivity: actualStatus,
                durationMs: 0,
                isLate: false,
                lateMs: 0,
                statusMatch: 'no-schedule'
              };
              rows.push(row);
            }
          } catch (e) {
            console.warn('Error processing user detail:', userDetail, e);
          }
        }
        
        console.log(`Created ${rows.length} analytics-only rows`);
        return rows;
      }

      // Process with schedule data
      for (const userDetail of details) {
        try {
          const userId = userDetail.userId || userDetail.user?.id;
          if (!userId) continue;
          
          const userName = state.usersById[userId]?.name || userDetail.user?.name || `User ${userId}`;
          const userSchedule = scheduleData.userSchedules[userId];
          
          if (!userSchedule) {
            console.log(`No schedule found for user ${userName} (${userId})`);
            continue;
          }

          // Get user's activities
          const activities = userDetail.routingStatus || userDetail.activities || [];
          if (!activities.length) {
            console.log(`No activities found for user ${userName}`);
            continue;
          }

          // Process each scheduled activity
          const shifts = userSchedule.shifts || [];
          console.log(`User ${userName} has ${shifts.length} scheduled activities`);

          for (const shift of shifts) {
            try {
              if (!shift.startDate || !shift.endDate) {
                console.log('Shift missing start/end date:', shift);
                continue;
              }

              const scheduledStart = shift.startDate;
              const scheduledEnd = shift.endDate;
              const scheduledActivity = shift.activityName;
              
              // Find actual activities during this scheduled activity
              const shiftStart = new Date(scheduledStart);
              const shiftEnd = new Date(scheduledEnd);
              
              const actualActivities = activities.filter(activity => {
                if (!activity.startTime && !activity.dateStart && !activity.conversationStart) return false;
                const activityTime = new Date(activity.startTime || activity.dateStart || activity.conversationStart);
                return activityTime >= shiftStart && activityTime <= shiftEnd;
              });

              if (actualActivities.length === 0) {
                console.log(`No actual activities found during scheduled activity for ${userName} at ${scheduledStart}`);
                continue;
              }

              // Sort activities by time and get the first one
              actualActivities.sort((a, b) => 
                new Date(a.startTime || a.dateStart || a.conversationStart) - 
                new Date(b.startTime || b.dateStart || b.conversationStart)
              );

              const firstActualActivity = actualActivities[0];
              const actualStart = firstActualActivity.startTime || firstActualActivity.dateStart || firstActualActivity.conversationStart;
              const actualStatus = firstActualActivity.status || firstActualActivity.presence || firstActualActivity.systemPresence || 'Unknown';
              
              // Calculate lateness
              const lateMs = new Date(actualStart) - new Date(scheduledStart);
              const isLate = lateMs > (ATTENDANCE_CONFIG.lateThresholdMinutes * 60 * 1000);
              const durationMs = new Date(scheduledEnd) - new Date(scheduledStart);

              const userTeams = state.teamsByUserId[userId] || [];
              const teamNames = userTeams.map(t => t.name).join(', ');
              const teamIds = userTeams.map(t => t.id);

              const row = {
                userId,
                userName,
                teamNames,
                teamIds,
                date: scheduledStart.slice(0, 10),
                scheduledActivity,
                scheduledStart,
                scheduledEnd,
                actualStart,
                actualActivity: actualStatus,
                durationMs,
                isLate,
                lateMs,
                statusMatch: scheduledActivity.toLowerCase().includes(actualStatus.toLowerCase()) ? 'match' : 'mismatch'
              };

              console.log('Created row:', row);
              rows.push(row);

            } catch (e) {
              console.warn('Error processing shift:', shift, e);
            }
          }

        } catch (e) {
          console.warn('Error processing user detail:', userDetail, e);
        }
      }
      
      console.log(`Processed ${rows.length} schedule vs actual rows`);
      return rows;
    }

    function getFilteredRows(){
      const teamId = $('teamSelect').value;
      const userId = $('userSelect').value;
      const search = $('userSearch').value.trim().toLowerCase();

      return state.attendanceRows.filter(r=>{
        if(teamId !== 'all' && !(r.teamIds || []).includes(teamId)) return false;
        if(userId !== 'all' && r.userId !== userId) return false;
        if(search){
          const hay = (r.userName + ' ' + (r.teamNames || '') + ' ' + r.date).toLowerCase();
          if(!hay.includes(search)) return false;
        }
        return true;
      });
    }

    function renderAttendance(){
      const resultsDiv = $('attendanceResults');
      
      console.log('Rendering attendance, total rows:', state.attendanceRows.length);
      
      if(!state.attendanceRows.length){
        $('resultsSection').style.display='none';
        resultsDiv.innerHTML = '<div class="muted" style="text-align:center;padding:40px"><div style="font-size:48px;margin-bottom:12px">üì≠</div><div>No data available for the selected period.</div><div class="muted" style="margin-top:8px;">Check that schedules are published and users have activity data.</div></div>';
        return;
      }
      
      const rows = getFilteredRows();
      console.log('Filtered rows:', rows.length);
      
      $('resultsSection').style.display='block';

      if(!rows.length){
        $('totalShifts').textContent = '0';
        $('lateShifts').textContent = '0';
        $('uniqueUsers').textContent = '0';
        $('avgLateMinutes').textContent = '0';
        resultsDiv.innerHTML = '<div class="muted" style="text-align:center;padding:40px"><div style="font-size:48px;margin-bottom:12px">üîç</div><div>No data found for the selected filters.</div></div>';
        return;
      }

      const totalShifts = rows.length;
      const lateShifts = rows.filter(r => r.isLate).length;
      const uniqueUsers = new Set(rows.map(r => r.userId)).size;
      const totalLateMs = rows.filter(r => r.isLate).reduce((sum, r) => sum + r.lateMs, 0);
      const avgLateMinutes = lateShifts ? (totalLateMs / lateShifts / 60000).toFixed(1) : '0';

      $('totalShifts').textContent = totalShifts;
      $('lateShifts').textContent = lateShifts;
      $('uniqueUsers').textContent = uniqueUsers;
      $('avgLateMinutes').textContent = avgLateMinutes;

      // Create table with schedule vs actual data
      let tableHtml = '';
      try {
        tableHtml = `
          <div style="overflow-x: auto;">
            <table class="attendance-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Team</th>
                  <th>Date</th>
                  <th>Scheduled Activity</th>
                  <th>Schedule Start</th>
                  <th>Actual Start</th>
                  <th>Actual Activity</th>
                  <th>Duration</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                ${rows.map(r => {
                  try {
                    const statusClass = r.isLate ? 'late' : 'on-time';
                    const lateMinutes = r.isLate ? Math.round(r.lateMs / 60000) : 0;
                    const statusDisplay = r.isLate ? `Late (${lateMinutes}m)` : 'On Time';
                    const rowClass = r.statusMatch === 'match' ? 'schedule-match' : 'schedule-mismatch';
                    
                    return `
                      <tr class="${rowClass}">
                        <td>${escapeHtml(r.userName)}</td>
                        <td>${escapeHtml(r.teamNames || 'No Team')}</td>
                        <td>${fmtDMY(r.date)}</td>
                        <td>${escapeHtml(r.scheduledActivity)}</td>
                        <td>${fmtTime(r.scheduledStart)}</td>
                        <td>${fmtTime(r.actualStart)}</td>
                        <td>${escapeHtml(r.actualActivity)}</td>
                        <td>${formatDuration(r.durationMs)}</td>
                        <td><span class="${statusClass}">${statusDisplay}</span></td>
                      </tr>
                    `;
                  } catch (e) {
                    console.warn('Error rendering row:', r, e);
                    return '<tr><td colspan="9" style="color: red;">Error rendering row</td></tr>';
                  }
                }).join('')}
              </tbody>
            </table>
          </div>
        `;
      } catch (e) {
        console.error('Error generating table HTML:', e);
        tableHtml = '<div style="color: red; padding: 20px; text-align: center;">Error generating table</div>';
      }
      
      resultsDiv.innerHTML = tableHtml;
    }

    // ===== Main Attendance Fetch =====
    async function fetchAttendance(){
      try{
        const from = $('fromDate').value;
        const to = $('toDate').value || from;
        const businessUnitId = $('businessUnitSelect').value;
        const managementUnitId = $('managementUnitSelect').value;
        
        if(!from){ setStatus('Please select a start date', true); return; }
        if(!businessUnitId){ setStatus('Please select a business unit', true); return; }
        if(!managementUnitId){ setStatus('Please select a management unit', true); return; }
        
        const today = new Date().toISOString().split('T')[0];
        if(from > today || to > today) { setStatus('Date range cannot be in the future', true); return; }
        if(new Date(to) < new Date(from)){ setStatus('End date must be on or after start date', true); return; }

        setStatus('Running attendance report‚Ä¶'); 
        setLoading(true);
        
        showProgress('Fetching schedule data‚Ä¶');
        updateProgress(25, 1, 4);

        // Fetch schedule data
        const scheduleData = await fetchScheduleData(businessUnitId, managementUnitId, from, to);
        
        updateProgress(50, 2, 4);
        showProgress('Fetching actual activity data‚Ä¶');

        // Fetch analytics data
        const body = {
          interval: `${from}T00:00:00/${to}T23:59:59`,
          order: "asc",
          orderBy: "conversationStart",
          paging: { pageSize: 100, pageNumber: 1 }
        };

        const res = await fetch(CONFIG.apiHost + '/api/v2/analytics/users/details/query', {
          method: 'POST',
          headers: { Authorization: 'Bearer ' + state.token, 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        
        if(!res.ok){
          const t = await res.text().catch(()=> '');
          throw new Error('Analytics error: ' + res.status + ' ' + res.statusText + (t?' - ' + t.slice(0,200):''));
        }
        
        updateProgress(75, 3, 4);
        const analyticsData = await res.json();
        
        showProgress('Processing schedule vs actual data‚Ä¶');
        
        // Process schedule vs actual
        state.attendanceRows = processScheduleVsActual(scheduleData, analyticsData);
        
        updateProgress(100, 4, 4);
        hideProgress();
        renderAttendance();
        
        if(state.attendanceRows.length){
          setStatus(`Report completed - ${state.attendanceRows.length} shifts analyzed`);
        }else{
          setStatus('No schedule vs actual data found for the selected period. Check console for details.');
        }
      }catch(e){
        console.error('Error in fetchAttendance:', e);
        hideProgress();
        setStatus('Error fetching attendance: ' + e.message, true);
      }finally{
        setLoading(false);
      }
    }

    // ===== Events & Init =====
    $('fetchBtn').addEventListener('click', fetchAttendance);
    $('businessUnitSelect').addEventListener('change', function() {
      if (this.value) {
        fetchManagementUnits(this.value);
      }
    });
    $('teamSelect').addEventListener('change', renderAttendance);
    $('userSelect').addEventListener('change', renderAttendance);
    $('userSearch').addEventListener('input', renderAttendance);

    (function init(){
      const today = new Date(); 
      const weekAgo = new Date(); 
      weekAgo.setDate(today.getDate() - 7);
      $('fromDate').value = weekAgo.toISOString().slice(0,10);
      $('toDate').value = today.toISOString().slice(0,10);
      initAuth();
    })();
  </script>
</body>
</html>
