<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Schedule Analytics Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D;
      --pill:#e9f6f0; --warning-bg:#fef3f2; --warning-border:#fecdca; --warning-text:#b42318;
      --success-bg:#f6fef9; --success-border:#75e0a7; --success-text:#079455;
    }
    body{
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
      margin:20px;padding:20px;max-width:1400px;background:var(--light-bg);color:var(--text-color)
    }
    #logo-container{text-align:center;margin-bottom:20px}
    #logo{width:300px}
    h1{margin:0 0 16px}
    .card{
      background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;
      padding:24px;margin-top:16px;box-shadow:0 1px 3px rgba(0,0,0,.08)
    }
    label{display:block;font-weight:600;margin-bottom:6px}
    input,select,button,textarea{
      padding:10px;border:1px solid var(--border-color);border-radius:6px;background:#fff;font-size:14px;
      width:100%;box-sizing:border-box
    }
    button{
      background:var(--primary-color);color:#fff;font-weight:600;cursor:pointer;transition:background .2s;
      width:auto;padding:12px 24px
    }
    button:hover{background:var(--secondary-color)}
    button:disabled{background:var(--text-light);cursor:not-allowed}
    .controls{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;align-items:end
    }
    .full-width-btn{width:100%;padding:14px 18px;font-size:16px;margin-top:12px}
    .muted{color:var(--text-light);font-size:12px;margin-top:4px}
    .section-title{margin:0 0 10px;color:var(--secondary-color)}

    /* Tabs */
    .tabs{display:flex;border-bottom:1px solid var(--border-color);margin-bottom:16px}
    .tab{
      padding:12px 24px;cursor:pointer;border-bottom:3px solid transparent;font-weight:600;
      transition:all 0.2s;color:var(--text-light)
    }
    .tab.active{
      color:var(--primary-color);border-bottom-color:var(--primary-color);background:var(--light-bg)
    }
    .tab-content{display:none}
    .tab-content.active{display:block}

    #messageContainer{display:none;margin-top:12px}
    .error-message{
      color:#b4231a;background:#fee2e2;border:1px solid:#fecaca;padding:10px;border-radius:6px
    }
    .success-message{
      color:#14532d;background:#dcfce7;border:1px solid:#bbf7d0;padding:10px;border-radius:6px
    }
    .info-message{
      color:#6b4e16;background:#fff7ed;border:1px solid:#ffedd5;padding:10px;border-radius:6px
    }

    .schedule-table{width:100%;border-collapse:collapse;margin-top:16px}
    .schedule-table th,.schedule-table td{
      border:1px solid var(--border-color);padding:8px;font-size:13px
    }
    .schedule-table th{background:var(--light-bg);text-align:left}
    .pill{
      display:inline-flex;align-items:center;padding:4px 8px;border-radius:999px;
      background:var(--pill);font-size:11px;color:var(--secondary-color)
    }
    .schedule-meta{margin-top:8px;font-size:12px;color:var(--text-light)}
    
    /* Analytics specific styles */
    .analytics-controls{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-bottom:16px
    }
    .analytics-controls > div {
      display:flex;flex-direction:column
    }
    .warning-row{background:var(--warning-bg) !important;border-left:4px solid var(--warning-text)}
    .overtime-badge{
      background:#dc2626;color:white;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600
    }
    .absence-badge{
      background:#ea580c;color:white;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600
    }
    .chart-container{
      background:white;border:1px solid var(--border-color);border-radius:8px;padding:16px;margin-top:16px
    }
    .metric-card{
      background:white;border:1px solid var(--border-color);border-radius:8px;padding:16px;text-align:center
    }
    .metric-value{font-size:24px;font-weight:bold;color:var(--primary-color);margin:8px 0}
    .metric-label{font-size:12px;color:var(--text-light);text-transform:uppercase}
    
    /* Sub-tabs for overtime */
    .sub-tabs{display:flex;border-bottom:1px solid var(--border-color);margin:16px 0}
    .sub-tab{
      padding:8px 16px;cursor:pointer;border-bottom:2px solid transparent;font-weight:600;
      transition:all 0.2s;color:var(--text-light);font-size:14px
    }
    .sub-tab.active{
      color:var(--primary-color);border-bottom-color:var(--primary-color)
    }
    .sub-tab-content{display:none}
    .sub-tab-content.active{display:block}
    
    /* Time details styling */
    .time-details{font-size:11px;color:var(--text-light);margin-top:4px}
    .time-range{display:inline-block;background:#f8f9fa;padding:2px 6px;border-radius:4px;margin-right:8px}
    
    details pre{
      max-height:250px;overflow:auto;background:#0f172a;color:#e5e7eb;
      padding:10px;border-radius:6px;font-size:11px
    }

    /* Responsive improvements */
    @media (max-width: 768px) {
      .controls, .analytics-controls {
        grid-template-columns:1fr;
      }
      .tabs, .sub-tabs {
        flex-wrap:wrap;
      }
      .tab, .sub-tab {
        flex:1;min-width:120px;text-align:center
      }
    }
  </style>
</head>
<body>
  <div id="logo-container">
    <img id="logo" src="https://raw.githubusercontent.com/gmcglynn88/ExternalWorkCreation/main/Consultinglogo.png" alt="Company Logo">
  </div>

  <h1>Schedule Analytics Dashboard</h1>

  <div id="authCard" class="card">
    <div id="auth-message" class="info-message">Authenticating with Genesys Cloud...</div>
  </div>

  <div id="appContent" style="display:none;">
    <div id="messageContainer"></div>

    <!-- Tabs Navigation -->
    <div class="tabs">
      <div class="tab active" data-tab="schedule">Schedule View</div>
      <div class="tab" data-tab="overtime">Overtime Tracking</div>
      <div class="tab" data-tab="absence">Absence Analytics</div>
    </div>

    <!-- Schedule Tab -->
    <div id="schedule-tab" class="tab-content active">
      <div class="card">
        <h2 class="section-title">Filters</h2>
        <div class="controls">
          <div>
            <label for="businessUnitSelect">Business Unit</label>
            <select id="businessUnitSelect">
              <option value="">Select business unit</option>
            </select>
            <div class="muted">Required</div>
          </div>

          <div>
            <label for="managementUnitSelect">Management Unit</label>
            <select id="managementUnitSelect" disabled>
              <option value="">Select management unit</option>
            </select>
            <div class="muted">Required for schedule search</div>
          </div>

          <div>
            <label for="teamSelect">Team</label>
            <select id="teamSelect">
              <option value="">All teams</option>
            </select>
            <div class="muted">Optional – narrows users by team</div>
          </div>

          <div>
            <label for="userSelect">User</label>
            <select id="userSelect">
              <option value="">Select user</option>
            </select>
            <div class="muted">Required – schedule shown for this user</div>
          </div>

          <div>
            <label for="startDate">Start date</label>
            <input type="date" id="startDate" />
            <div class="muted">e.g. 2025-11-03</div>
          </div>

          <div>
            <label for="endDate">End date</label>
            <input type="date" id="endDate" />
            <div class="muted">e.g. 2025-11-08</div>
          </div>
        </div>

        <button id="loadScheduleBtn" class="full-width-btn">Load Schedule</button>
      </div>

      <div id="results" class="card" style="display:none;"></div>
    </div>

    <!-- Overtime Tab -->
    <div id="overtime-tab" class="tab-content">
      <div class="card">
        <h2 class="section-title">Overtime Analysis</h2>
        <div class="analytics-controls">
          <div>
            <label for="overtimeBuSelect">Business Unit</label>
            <select id="overtimeBuSelect">
              <option value="">Select business unit</option>
            </select>
          </div>
          <div>
            <label for="overtimeMuSelect">Management Unit</label>
            <select id="overtimeMuSelect" disabled>
              <option value="">Select management unit</option>
            </select>
          </div>
          <div>
            <label for="overtimeTeamSelect">Team</label>
            <select id="overtimeTeamSelect">
              <option value="">All teams</option>
            </select>
          </div>
          <div>
            <label for="overtimeStartDate">Start Date</label>
            <input type="date" id="overtimeStartDate" />
          </div>
          <div>
            <label for="overtimeEndDate">End Date</label>
            <input type="date" id="overtimeEndDate" />
          </div>
          <div>
            <label for="overtimeThreshold">Weekly Threshold (hours)</label>
            <input type="number" id="overtimeThreshold" value="40" min="0" step="0.5" />
          </div>
          <div>
            <label for="dailyThreshold">Daily Threshold (hours)</label>
            <input type="number" id="dailyThreshold" value="8" min="0" step="0.5" />
          </div>
        </div>
        <button id="analyzeOvertimeBtn" class="full-width-btn">Analyze Overtime</button>
      </div>

      <div id="overtimeResults" class="card" style="display:none;"></div>
    </div>

    <!-- Absence Tab -->
    <div id="absence-tab" class="tab-content">
      <div class="card">
        <h2 class="section-title">Absence Analytics</h2>
        <div class="analytics-controls">
          <div>
            <label for="absenceBuSelect">Business Unit</label>
            <select id="absenceBuSelect">
              <option value="">Select business unit</option>
            </select>
          </div>
          <div>
            <label for="absenceMuSelect">Management Unit</label>
            <select id="absenceMuSelect" disabled>
              <option value="">Select management unit</option>
            </select>
          </div>
          <div>
            <label for="absenceTeamSelect">Team</label>
            <select id="absenceTeamSelect">
              <option value="">All teams</option>
            </select>
          </div>
          <div>
            <label for="absenceStartDate">Start Date</label>
            <input type="date" id="absenceStartDate" />
          </div>
          <div>
            <label for="absenceEndDate">End Date</label>
            <input type="date" id="absenceEndDate" />
          </div>
          <div>
            <label for="absenceThreshold">Alert Threshold (hours)</label>
            <input type="number" id="absenceThreshold" value="16" min="0" step="1" />
          </div>
        </div>
        <button id="analyzeAbsenceBtn" class="full-width-btn">Analyze Absence</button>
      </div>

      <div id="absenceResults" class="card" style="display:none;"></div>
    </div>
  </div>

  <script>
    // ===== OAuth Config =====
    const clientId = 'fe305808-b368-4547-8af9-325d28d552bb';
    const redirectUri = 'https://gmcglynn88.github.io/Late_Break-Report/';
    const oauthUrl = 'https://login.mypurecloud.ie/oauth/authorize?client_id=' + encodeURIComponent(clientId) + '&response_type=token&redirect_uri=' + encodeURIComponent(redirectUri);
    const apiBase = 'https://api.mypurecloud.ie';

    let accessToken = null;
    let allUsers = [];
    let usersById = {};
    let allTeams = [];
    let activityCodesByBuId = {};
    let businessUnits = [];
    let managementUnits = [];

    // ===== Tab Management =====
    function initializeTabs() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          // Remove active class from all tabs and contents
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          // Add active class to clicked tab and corresponding content
          tab.classList.add('active');
          const tabId = tab.getAttribute('data-tab');
          document.getElementById(`${tabId}-tab`).classList.add('active');
        });
      });
    }

    // ===== Auth bootstrap =====
    document.addEventListener('DOMContentLoaded', () => {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      const qparams = new URLSearchParams(window.location.search);

      const oauthError = params.get('error') || qparams.get('error');
      const oauthErrorDesc = params.get('error_description') || qparams.get('error_description');

      if (oauthError) {
        const msg = document.getElementById('auth-message');
        msg.textContent = `OAuth error: ${oauthErrorDesc || oauthError}`;
        msg.className = 'error-message';
        console.error('OAuth error details:', { error: oauthError, description: oauthErrorDesc });
        return;
      }

      accessToken = params.get('access_token');

      if (accessToken) {
        sessionStorage.setItem('purecloud_token', accessToken);
        window.location.hash = '';
        initializeApplication();
      } else if (sessionStorage.getItem('purecloud_token')) {
        accessToken = sessionStorage.getItem('purecloud_token');
        initializeApplication();
      } else {
        window.location.href = oauthUrl;
      }
    });

    function showMessage(msg, type = 'error') {
      const box = document.getElementById('messageContainer');
      box.innerHTML = `<div class="${type}-message">${msg}</div>`;
      box.style.display = 'block';
      if (type === 'success' || type === 'info') {
        setTimeout(() => { box.style.display = 'none'; }, 6000);
      }
    }

    function initializeApplication() {
      document.getElementById('auth-message').textContent = 'Authenticated successfully!';
      document.getElementById('authCard').style.display = 'none';
      document.getElementById('appContent').style.display = 'block';

      initializeTabs();
      initializeScheduleApp();
      initializeAnalytics();
    }

    function authorizedFetch(url, options = {}) {
      const headers = {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json',
        ...(options.headers || {})
      };
      return fetch(url, { ...options, headers });
    }

    async function authorizedFetchJson(url, options = {}) {
      const response = await authorizedFetch(url, options);
      if (!response.ok) {
        throw new Error(`Error calling ${url}: ${response.status} ${response.statusText}`);
      }
      return response.json();
    }

    async function fetchAllPages(url) {
      let allItems = [];
      let pageNumber = 1;
      let pageSize = 100;
      let hasMorePages = true;

      while (hasMorePages) {
        try {
          const response = await authorizedFetch(`${url}?pageNumber=${pageNumber}&pageSize=${pageSize}`);
          if (!response.ok) {
            throw new Error(`Error fetching data: ${response.status} ${response.statusText}`);
          }
          const data = await response.json();
          
          // Handle different response formats
          const entities = data.entities || data.users || data.members || data.businessUnits || data.managementUnits || data.teams || [];
          allItems = allItems.concat(entities);
          
          if (data.pageCount && data.pageCount > pageNumber) {
            pageNumber++;
          } else if (data.pageCount === pageNumber) {
            hasMorePages = false;
          } else if (!entities.length || entities.length < pageSize) {
            hasMorePages = false;
          } else {
            pageNumber++;
          }
        } catch (err) {
          console.error('Error in fetchAllPages:', err);
          hasMorePages = false;
        }
      }
      return allItems;
    }

    // ===== Schedule View Functions =====
    async function initializeScheduleApp() {
      document.getElementById('loadScheduleBtn').addEventListener('click', loadSchedule);
      document.getElementById('businessUnitSelect').addEventListener('change', handleBusinessUnitChange);
      document.getElementById('managementUnitSelect').addEventListener('change', handleManagementUnitChange);
      document.getElementById('teamSelect').addEventListener('change', handleTeamChange);

      try {
        await populateInitialData();
        showMessage('Initial data loaded – set your filters and hit "Load Schedule".', 'info');
      } catch (err) {
        console.error('Error initialising app:', err);
        showMessage(`Error loading initial data: ${err.message}`, 'error');
      }
    }

    async function populateInitialData() {
      try {
        console.log('Starting to populate initial data...');
        
        // Fetch all data in parallel
        const [users, businessUnitsData, teams, managementUnitsData] = await Promise.all([
          fetchAllPages(`${apiBase}/api/v2/users`),
          fetchAllPages(`${apiBase}/api/v2/workforcemanagement/businessunits`),
          fetchAllPages(`${apiBase}/api/v2/teams`),
          fetchAllPages(`${apiBase}/api/v2/workforcemanagement/managementunits`)
        ]);

        console.log('Data fetched:', { 
          users: users.length, 
          businessUnits: businessUnitsData.length,
          teams: teams.length,
          managementUnits: managementUnitsData.length
        });

        // Process users
        allUsers = (users || []).filter(u => !u.deleted && u.name);
        usersById = {};
        allUsers.forEach(u => { 
          usersById[u.id] = u;
          // Ensure user has name property
          if (!u.name && u.username) {
            u.name = u.username;
          }
        });

        // Process business units
        businessUnits = businessUnitsData || [];
        
        // Process management units
        managementUnits = managementUnitsData || [];
        
        // Process teams
        allTeams = teams || [];

        populateUserSelect(allUsers);
        populateBusinessUnitSelect(businessUnits);
        populateTeamSelect(allTeams);
        
        // Also populate analytics dropdowns
        populateAnalyticsDropdowns();
        
        console.log('Initial data population completed');
      } catch (err) {
        console.error('Error in populateInitialData:', err);
        throw err;
      }
    }

    function populateUserSelect(users) {
      const userSelect = document.getElementById('userSelect');
      userSelect.innerHTML = '<option value="">Select user</option>';
      const sorted = [...users].sort((a, b) => (a.name || '').localeCompare(b.name || ''));
      sorted.forEach(user => {
        const opt = document.createElement('option');
        opt.value = user.id;
        opt.text = user.name || user.id;
        userSelect.add(opt);
      });
    }

    function populateBusinessUnitSelect(businessUnits) {
      const buSelect = document.getElementById('businessUnitSelect');
      buSelect.innerHTML = '<option value="">Select business unit</option>';
      const sorted = [...businessUnits].sort((a, b) => (a.name || '').localeCompare(b.name || ''));
      sorted.forEach(bu => {
        const opt = document.createElement('option');
        opt.value = bu.id;
        opt.text = bu.name || bu.id;
        buSelect.add(opt);
      });
    }

    function populateTeamSelect(teams) {
      const teamSelect = document.getElementById('teamSelect');
      teamSelect.innerHTML = '<option value="">All teams</option>';
      const sorted = [...teams].sort((a, b) => (a.name || '').localeCompare(b.name || ''));
      sorted.forEach(team => {
        const opt = document.createElement('option');
        opt.value = team.id;
        opt.text = team.name || team.id;
        teamSelect.add(opt);
      });
    }

    // ===== Analytics Functions =====
    function populateAnalyticsDropdowns() {
      // Populate business unit dropdowns for analytics
      populateSelect('overtimeBuSelect', businessUnits);
      populateSelect('absenceBuSelect', businessUnits);
      
      // Populate team dropdowns for analytics
      populateSelect('overtimeTeamSelect', allTeams, true);
      populateSelect('absenceTeamSelect', allTeams, true);
      
      // Set default dates for analytics
      const today = new Date();
      const twoWeeksAgo = new Date(today.getTime() - 14 * 24 * 60 * 60 * 1000);
      document.getElementById('overtimeStartDate').value = twoWeeksAgo.toISOString().split('T')[0];
      document.getElementById('overtimeEndDate').value = today.toISOString().split('T')[0];
      document.getElementById('absenceStartDate').value = twoWeeksAgo.toISOString().split('T')[0];
      document.getElementById('absenceEndDate').value = today.toISOString().split('T')[0];
    }

    function populateSelect(selectId, items, isTeam = false) {
      const select = document.getElementById(selectId);
      select.innerHTML = isTeam ? '<option value="">All teams</option>' : '<option value="">Select business unit</option>';
      
      const sorted = [...items].sort((a, b) => (a.name || '').localeCompare(b.name || ''));
      sorted.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item.id;
        opt.text = item.name || item.id;
        select.add(opt);
      });
    }

    function initializeAnalytics() {
      // Overtime analysis
      document.getElementById('analyzeOvertimeBtn').addEventListener('click', analyzeOvertime);
      document.getElementById('overtimeBuSelect').addEventListener('change', (e) => handleAnalyticsBuChange(e, 'overtime'));
      
      // Absence analysis
      document.getElementById('analyzeAbsenceBtn').addEventListener('click', analyzeAbsence);
      document.getElementById('absenceBuSelect').addEventListener('change', (e) => handleAnalyticsBuChange(e, 'absence'));
    }

    async function handleAnalyticsBuChange(event, tabType) {
      const buId = event.target.value;
      const muSelect = document.getElementById(`${tabType}MuSelect`);
      muSelect.innerHTML = '<option value="">Select management unit</option>';
      muSelect.disabled = true;

      if (!buId) return;

      try {
        // Filter management units by business unit ID
        const filteredManagementUnits = managementUnits.filter(mu => 
          mu.businessUnit && mu.businessUnit.id === buId
        );
        
        filteredManagementUnits.forEach(mu => {
          const opt = document.createElement('option');
          opt.value = mu.id;
          opt.text = mu.name || mu.id;
          muSelect.add(opt);
        });
        muSelect.disabled = false;
      } catch (err) {
        console.error('Error loading management units:', err);
        showMessage(`Error loading management units: ${err.message}`, 'error');
      }
    }

    // ===== Business Unit Change Handler =====
    async function handleBusinessUnitChange(event) {
      const buId = event.target.value;
      const muSelect = document.getElementById('managementUnitSelect');
      const userSelect = document.getElementById('userSelect');
      
      // Reset dependent fields
      muSelect.innerHTML = '<option value="">Select management unit</option>';
      muSelect.disabled = true;
      userSelect.innerHTML = '<option value="">Select user</option>';
      userSelect.disabled = true;

      if (!buId) return;

      try {
        // Filter management units by business unit ID
        const filteredManagementUnits = managementUnits.filter(mu => 
          mu.businessUnit && mu.businessUnit.id === buId
        );
        
        console.log(`Filtered management units for BU ${buId}:`, filteredManagementUnits);
        
        filteredManagementUnits.forEach(mu => {
          const opt = document.createElement('option');
          opt.value = mu.id;
          opt.text = mu.name || mu.id;
          muSelect.add(opt);
        });
        muSelect.disabled = false;
      } catch (err) {
        console.error('Error loading management units:', err);
        showMessage(`Error loading management units: ${err.message}`, 'error');
      }
    }

    // ===== Management Unit Change Handler =====
    async function handleManagementUnitChange(event) {
      const muId = event.target.value;
      const userSelect = document.getElementById('userSelect');
      
      userSelect.innerHTML = '<option value="">Select user</option>';
      userSelect.disabled = true;

      if (!muId) return;

      try {
        // Get users for the selected management unit
        const muUsers = await fetchAllPages(
          `${apiBase}/api/v2/workforcemanagement/managementunits/${encodeURIComponent(muId)}/users`
        );
        
        console.log(`Users for MU ${muId}:`, muUsers);
        
        // Populate user dropdown
        userSelect.innerHTML = '<option value="">Select user</option>';
        const sorted = [...muUsers].sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        sorted.forEach(user => {
          const opt = document.createElement('option');
          opt.value = user.id;
          // Use the user object from our cached data if available, otherwise use what we got
          const userObj = usersById[user.id] || user;
          opt.text = userObj.name || userObj.id;
          userSelect.add(opt);
        });
        userSelect.disabled = false;
      } catch (err) {
        console.error('Error loading users for management unit:', err);
        showMessage(`Error loading users: ${err.message}`, 'error');
      }
    }

    // ===== Team Change Handler =====
    async function handleTeamChange(event) {
      const teamId = event.target.value;
      const userSelect = document.getElementById('userSelect');
      
      userSelect.innerHTML = '<option value="">Select user</option>';
      userSelect.disabled = true;

      if (!teamId) return;

      try {
        // Get team members
        const teamMembers = await fetchAllPages(
          `${apiBase}/api/v2/teams/${encodeURIComponent(teamId)}/members`
        );
        
        console.log(`Team members for team ${teamId}:`, teamMembers);
        
        // Populate user dropdown with team members
        userSelect.innerHTML = '<option value="">Select user</option>';
        const sorted = [...teamMembers].sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        sorted.forEach(member => {
          const opt = document.createElement('option');
          opt.value = member.id;
          // Use the user object from our cached data if available, otherwise use what we got
          const userObj = usersById[member.id] || member;
          opt.text = userObj.name || userObj.id;
          userSelect.add(opt);
        });
        userSelect.disabled = false;
      } catch (err) {
        console.error('Error loading team members:', err);
        showMessage(`Error loading team members: ${err.message}`, 'error');
      }
    }

    // ===== Load Schedule =====
    async function loadSchedule() {
      const muId = document.getElementById('managementUnitSelect').value;
      const userId = document.getElementById('userSelect').value;
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;

      if (!muId || !userId || !startDate || !endDate) {
        showMessage('Please select management unit, user, and date range', 'error');
        return;
      }

      const button = document.getElementById('loadScheduleBtn');
      const originalLabel = button.textContent;
      button.disabled = true;
      button.textContent = 'Loading...';

      try {
        const startDateIso = `${startDate}T00:00:00.000Z`;
        const endDateIso = `${endDate}T23:59:59.999Z`;

        console.log('Loading schedule with params:', { muId, userId, startDateIso, endDateIso });

        const schedule = await searchSchedules(muId, userId, startDateIso, endDateIso);
        console.log('Schedule response:', schedule);
        
        renderScheduleResults(schedule, userId);
      } catch (err) {
        console.error('Error loading schedule:', err);
        showMessage(`Error loading schedule: ${err.message}`, 'error');
      } finally {
        button.disabled = false;
        button.textContent = originalLabel;
      }
    }

    // ===== Search Schedules =====
    async function searchSchedules(muId, userId, startDate, endDate, includeFullDayTimeOffMarkers = true) {
      const body = {
        startDate: startDate,
        endDate: endDate,
        userIds: [userId],
        includeFullDayTimeOffMarkers: includeFullDayTimeOffMarkers
      };

      console.log('Searching schedules with body:', body);

      const response = await authorizedFetch(
        `${apiBase}/api/v2/workforcemanagement/managementunits/${muId}/schedules/search`,
        {
          method: 'POST',
          body: JSON.stringify(body)
        }
      );

      if (!response.ok) {
        const errorText = await response.text();
        console.error('Schedule search error:', errorText);
        throw new Error(`Error searching schedules: ${response.status} ${response.statusText}`);
      }

      return response.json();
    }

    // ===== Extract User Activities =====
    function extractUserActivitiesFromSearchResult(scheduleResult, userId, businessUnitId) {
      const activities = [];
      
      console.log('Extracting activities from:', scheduleResult);
      
      if (!scheduleResult || !scheduleResult.userSchedules) {
        console.log('No user schedules found');
        return activities;
      }

      const userSchedule = scheduleResult.userSchedules.find(us => us.userId === userId);
      if (!userSchedule) {
        console.log('No schedule found for user:', userId);
        return activities;
      }

      console.log('User schedule found:', userSchedule);

      // Process shifts
      if (userSchedule.shifts) {
        userSchedule.shifts.forEach(shift => {
          console.log('Processing shift:', shift);
          activities.push({
            type: 'shift',
            date: shift.startDate.split('T')[0],
            start: new Date(shift.startDate),
            end: new Date(shift.endDate),
            durationMinutes: shift.activities ? shift.activities.reduce((total, activity) => total + activity.lengthMinutes, 0) : 0,
            countsAsPaidTime: true,
            activities: shift.activities || []
          });
        });
      }

      // Process full day time off markers
      if (userSchedule.fullDayTimeOffMarkers) {
        userSchedule.fullDayTimeOffMarkers.forEach(marker => {
          console.log('Processing time off marker:', marker);
          activities.push({
            type: 'fullDayOff',
            date: marker.date.split('T')[0],
            start: new Date(marker.date),
            end: new Date(marker.date),
            durationMinutes: 24 * 60, // Full day
            countsAsPaidTime: false,
            activityCodeId: marker.activityCodeId,
            isFullDayOff: true
          });
        });
      }

      console.log('Extracted activities:', activities);
      return activities;
    }

    // ===== Format Duration =====
    function formatDuration(minutes) {
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
    }

    // ===== Escape HTML =====
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ===== Render Schedule Results =====
    function renderScheduleResults(scheduleResult, userId) {
      const container = document.getElementById('results');
      container.style.display = 'block';
      
      const businessUnitId = document.getElementById('businessUnitSelect').value;
      const activities = extractUserActivitiesFromSearchResult(scheduleResult, userId, businessUnitId);
      
      console.log('Rendering schedule with activities:', activities);
      
      if (activities.length === 0) {
        container.innerHTML = `<div class="info-message">No schedule found for the selected period.</div>`;
        return;
      }

      let html = `
        <h3 class="section-title">Schedule for ${escapeHtml(usersById[userId]?.name || userId)}</h3>
        <table class="schedule-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Start</th>
              <th>End</th>
              <th>Duration</th>
              <th>Activities</th>
            </tr>
          </thead>
          <tbody>
      `;

      activities.forEach(activity => {
        const startTime = formatTime(activity.start);
        const endTime = formatTime(activity.end);
        const duration = formatDuration(activity.durationMinutes);
        
        let activityDetails = '';
        if (activity.activities && activity.activities.length > 0) {
          activityDetails = activity.activities.map(a => 
            `${getActivityName(businessUnitId, a.activityCodeId)} (${formatDuration(a.lengthMinutes)})`
          ).join('<br>');
        } else if (activity.isFullDayOff) {
          activityDetails = getActivityName(businessUnitId, activity.activityCodeId) || 'Time Off';
        } else {
          activityDetails = 'Work';
        }

        html += `
          <tr>
            <td>${escapeHtml(activity.date)}</td>
            <td>${escapeHtml(activity.type)}</td>
            <td>${startTime}</td>
            <td>${endTime}</td>
            <td>${duration}</td>
            <td>${activityDetails}</td>
          </tr>
        `;
      });

      html += `</tbody></table>`;
      container.innerHTML = html;
    }

    // ===== Load Activity Codes =====
    async function loadActivityCodes(businessUnitId) {
      if (activityCodesByBuId[businessUnitId]) {
        return activityCodesByBuId[businessUnitId];
      }

      try {
        const response = await authorizedFetchJson(
          `${apiBase}/api/v2/workforcemanagement/businessunits/${businessUnitId}/activitycodes`
        );
        activityCodesByBuId[businessUnitId] = response.entities || [];
        return activityCodesByBuId[businessUnitId];
      } catch (err) {
        console.error('Error loading activity codes:', err);
        return [];
      }
    }

    // ===== Get Activity Name =====
    function getActivityName(businessUnitId, activityCodeId) {
      const codes = activityCodesByBuId[businessUnitId] || [];
      const code = codes.find(c => c.id === activityCodeId);
      return code ? code.name : activityCodeId;
    }

    // ===== Format Time =====
    function formatTime(d) {
      if (!d) return '';
      return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // ===== Overtime Analysis =====
    async function analyzeOvertime() {
      const buId = document.getElementById('overtimeBuSelect').value;
      const muId = document.getElementById('overtimeMuSelect').value;
      const teamId = document.getElementById('overtimeTeamSelect').value;
      const startDate = document.getElementById('overtimeStartDate').value;
      const endDate = document.getElementById('overtimeEndDate').value;
      const weeklyThreshold = parseFloat(document.getElementById('overtimeThreshold').value) || 40;
      const dailyThreshold = parseFloat(document.getElementById('dailyThreshold').value) || 8;

      if (!buId || !muId || !startDate || !endDate) {
        showMessage('Please select business unit, management unit, and date range', 'error');
        return;
      }

      const button = document.getElementById('analyzeOvertimeBtn');
      const originalLabel = button.textContent;
      button.disabled = true;
      button.textContent = 'Analyzing...';

      try {
        // Get users based on filters
        let users = await getUsersForAnalytics(muId, teamId);
        
        console.log(`Analyzing overtime for ${users.length} users`);
        
        const overtimeData = {
          daily: [],
          weekly: [],
          monthly: []
        };
        
        const startDateIso = `${startDate}T00:00:00.000Z`;
        const endDateIso = `${endDate}T23:59:59.999Z`;

        // Analyze each user's schedule
        for (const user of users) {
          try {
            console.log(`Analyzing user: ${user.name}`);
            const schedule = await searchSchedules(muId, user.id, startDateIso, endDateIso, true);
            const userOvertime = calculateOvertimeDetails(schedule, user.id, weeklyThreshold, dailyThreshold);
            
            // Add user data to each time period
            overtimeData.daily.push(...userOvertime.daily);
            overtimeData.weekly.push(...userOvertime.weekly);
            overtimeData.monthly.push(...userOvertime.monthly);
            
          } catch (err) {
            console.error(`Error analyzing user ${user.name}:`, err);
          }
        }

        renderOvertimeResults(overtimeData, weeklyThreshold, dailyThreshold);
      } catch (err) {
        console.error('Error analyzing overtime:', err);
        showMessage(`Error analyzing overtime: ${err.message}`, 'error');
      } finally {
        button.disabled = false;
        button.textContent = originalLabel;
      }
    }

    // ===== Absence Analysis =====
    async function analyzeAbsence() {
      const buId = document.getElementById('absenceBuSelect').value;
      const muId = document.getElementById('absenceMuSelect').value;
      const teamId = document.getElementById('absenceTeamSelect').value;
      const startDate = document.getElementById('absenceStartDate').value;
      const endDate = document.getElementById('absenceEndDate').value;
      const thresholdHours = parseFloat(document.getElementById('absenceThreshold').value) || 16;

      if (!buId || !muId || !startDate || !endDate) {
        showMessage('Please select business unit, management unit, and date range', 'error');
        return;
      }

      const button = document.getElementById('analyzeAbsenceBtn');
      const originalLabel = button.textContent;
      button.disabled = true;
      button.textContent = 'Analyzing...';

      try {
        // Load activity codes for absence types
        await loadActivityCodes(buId);
        
        let users = await getUsersForAnalytics(muId, teamId);
        const absenceData = [];
        const startDateIso = `${startDate}T00:00:00.000Z`;
        const endDateIso = `${endDate}T23:59:59.999Z`;

        console.log(`Analyzing absence for ${users.length} users`);

        for (const user of users) {
          try {
            console.log(`Analyzing absence for user: ${user.name}`);
            const schedule = await searchSchedules(muId, user.id, startDateIso, endDateIso, true);
            const absenceStats = calculateAbsenceStats(schedule, user.id, buId);
            
            if (absenceStats.totalHours > 0) {
              absenceData.push({
                user: user.name,
                totalHours: absenceStats.totalHours,
                absenceDays: absenceStats.days,
                instances: absenceStats.instances,
                exceedsThreshold: absenceStats.totalHours >= thresholdHours
              });
            }
          } catch (err) {
            console.error(`Error analyzing user ${user.name}:`, err);
          }
        }

        renderAbsenceResults(absenceData, thresholdHours, startDate, endDate);
      } catch (err) {
        console.error('Error analyzing absence:', err);
        showMessage(`Error analyzing absence: ${err.message}`, 'error');
      } finally {
        button.disabled = false;
        button.textContent = originalLabel;
      }
    }

    // ===== Helper Functions =====
    async function getUsersForAnalytics(muId, teamId) {
      let users = [];
      
      if (teamId) {
        const teamMembers = await fetchAllPages(
          `${apiBase}/api/v2/teams/${encodeURIComponent(teamId)}/members`
        );
        users = teamMembers || [];
      } else {
        const muUsers = await fetchAllPages(
          `${apiBase}/api/v2/workforcemanagement/managementunits/${encodeURIComponent(muId)}/users`
        );
        users = muUsers || [];
      }
      
      // Map to our cached user objects to get proper names
      return users.map(uRef => {
        const user = usersById[uRef.id] || uRef;
        return {
          id: user.id,
          name: user.name || user.id
        };
      }).filter(u => u && u.name);
    }

    function calculateOvertimeDetails(schedule, userId, weeklyThreshold, dailyThreshold) {
      const activities = extractUserActivitiesFromSearchResult(schedule, userId, document.getElementById('overtimeBuSelect').value);
      
      const dailyData = {};
      const weeklyData = {};
      const monthlyData = {};
      
      // Group activities by date and calculate work periods
      activities.forEach(activity => {
        if (activity.type === 'shift' && activity.countsAsPaidTime) {
          const date = new Date(activity.date);
          const dateKey = activity.date;
          const weekKey = getWeekKey(date);
          const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
          
          // Initialize data structures
          if (!dailyData[dateKey]) {
            dailyData[dateKey] = {
              date: dateKey,
              totalHours: 0,
              workPeriods: [],
              user: usersById[userId]?.name || userId
            };
          }
          if (!weeklyData[weekKey]) {
            weeklyData[weekKey] = {
              week: weekKey,
              totalHours: 0,
              days: new Set(),
              user: usersById[userId]?.name || userId
            };
          }
          if (!monthlyData[monthKey]) {
            monthlyData[monthKey] = {
              month: monthKey,
              totalHours: 0,
              user: usersById[userId]?.name || userId
            };
          }
          
          // Add hours
          const hours = activity.durationMinutes / 60;
          dailyData[dateKey].totalHours += hours;
          weeklyData[weekKey].totalHours += hours;
          monthlyData[monthKey].totalHours += hours;
          
          // Add work period
          dailyData[dateKey].workPeriods.push({
            start: activity.start,
            end: activity.end,
            hours: hours
          });
          
          // Track days in week
          weeklyData[weekKey].days.add(dateKey);
        }
      });
      
      // Calculate overtime and format results
      const result = {
        daily: [],
        weekly: [],
        monthly: []
      };
      
      // Daily overtime
      Object.values(dailyData).forEach(day => {
        if (day.totalHours > dailyThreshold) {
          result.daily.push({
            user: day.user,
            date: day.date,
            totalHours: day.totalHours,
            overtimeHours: day.totalHours - dailyThreshold,
            workPeriods: day.workPeriods
          });
        }
      });
      
      // Weekly overtime
      Object.values(weeklyData).forEach(week => {
        if (week.totalHours > weeklyThreshold) {
          result.weekly.push({
            user: week.user,
            period: week.week,
            totalHours: week.totalHours,
            overtimeHours: week.totalHours - weeklyThreshold,
            daysWorked: week.days.size
          });
        }
      });
      
      // Monthly overtime (anything over 4x weekly threshold)
      const monthlyThreshold = weeklyThreshold * 4;
      Object.values(monthlyData).forEach(month => {
        if (month.totalHours > monthlyThreshold) {
          result.monthly.push({
            user: month.user,
            period: month.month,
            totalHours: month.totalHours,
            overtimeHours: month.totalHours - monthlyThreshold
          });
        }
      });
      
      return result;
    }

    function calculateAbsenceStats(schedule, userId, businessUnitId) {
      const activities = extractUserActivitiesFromSearchResult(schedule, userId, businessUnitId);
      let totalHours = 0;
      const absenceDays = new Set();
      let instances = 0;
      
      console.log('Analyzing activities for absence:', activities);
      
      activities.forEach(activity => {
        const activityName = getActivityName(businessUnitId, activity.activityCodeId);
        
        // Count anything that's NOT work-related
        const isWorkActivity = activityName === 'On Queue' || 
                              activityName === 'Off Queue' || 
                              activityName === 'Break' || 
                              activityName === 'Meal' ||
                              activityName === 'Meeting' ||
                              activityName === 'Training';
        
        if (!isWorkActivity || activity.type === 'fullDayOff') {
          totalHours += activity.durationMinutes / 60;
          absenceDays.add(activity.date);
          instances++;
          console.log(`✓ Counted as absence: ${activityName} (${activity.durationMinutes/60}h)`);
        }
      });
      
      console.log(`Total absence: ${totalHours}h over ${absenceDays.size} days, ${instances} instances`);
      
      return {
        totalHours: parseFloat(totalHours.toFixed(1)),
        days: absenceDays.size,
        instances: instances
      };
    }

    function getWeekKey(date) {
      const year = date.getFullYear();
      const week = getWeekNumber(date);
      return `${year}-W${week.toString().padStart(2, '0')}`;
    }

    function getWeekNumber(date) {
      const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
      const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
      return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
    }

    // ===== Rendering Functions =====
    function renderOvertimeResults(data, weeklyThreshold, dailyThreshold) {
      const container = document.getElementById('overtimeResults');
      container.style.display = 'block';
      
      if (data.daily.length === 0 && data.weekly.length === 0 && data.monthly.length === 0) {
        container.innerHTML = `<div class="info-message">No overtime detected for the selected period.</div>`;
        return;
      }
      
      let html = `
        <h3 class="section-title">Overtime Report</h3>
        <div class="schedule-meta">
          <span class="pill">Weekly Threshold: ${weeklyThreshold} hours</span>
          &nbsp;
          <span class="pill">Daily Threshold: ${dailyThreshold} hours</span>
          &nbsp;
          <span class="pill">Cases: ${data.daily.length} daily, ${data.weekly.length} weekly, ${data.monthly.length} monthly</span>
        </div>
        
        <div class="sub-tabs">
          <div class="sub-tab active" data-subtab="daily">Daily Breakdown</div>
          <div class="sub-tab" data-subtab="weekly">Weekly Summary</div>
          <div class="sub-tab" data-subtab="monthly">Monthly Overview</div>
        </div>
        
        <div id="daily-overtime" class="sub-tab-content active">
          <h4>Daily Overtime (Over ${dailyThreshold}h/day)</h4>
          <table class="schedule-table">
            <thead>
              <tr>
                <th>Agent</th>
                <th>Date</th>
                <th>Total Hours</th>
                <th>Overtime Hours</th>
                <th>Work Periods</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      data.daily.forEach(item => {
        const timeRanges = item.workPeriods.map(period => 
          `<span class="time-range">${formatTime(period.start)}-${formatTime(period.end)}</span>`
        ).join('');
        
        html += `
          <tr>
            <td>${escapeHtml(item.user)}</td>
            <td>${escapeHtml(item.date)}</td>
            <td><strong>${item.totalHours.toFixed(1)}h</strong></td>
            <td><span class="overtime-badge">+${item.overtimeHours.toFixed(1)}h</span></td>
            <td><div class="time-details">${timeRanges}</div></td>
          </tr>
        `;
      });
      
      html += `</tbody></table></div>`;
      
      html += `
        <div id="weekly-overtime" class="sub-tab-content">
          <h4>Weekly Overtime (Over ${weeklyThreshold}h/week)</h4>
          <table class="schedule-table">
            <thead>
              <tr>
                <th>Agent</th>
                <th>Week</th>
                <th>Total Hours</th>
                <th>Overtime Hours</th>
                <th>Days Worked</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      data.weekly.forEach(item => {
        html += `
          <tr>
            <td>${escapeHtml(item.user)}</td>
            <td>${escapeHtml(item.period)}</td>
            <td><strong>${item.totalHours.toFixed(1)}h</strong></td>
            <td><span class="overtime-badge">+${item.overtimeHours.toFixed(1)}h</span></td>
            <td>${item.daysWorked}</td>
          </tr>
        `;
      });
      
      html += `</tbody></table></div>`;
      
      html += `
        <div id="monthly-overtime" class="sub-tab-content">
          <h4>Monthly Overtime (Over ${weeklyThreshold * 4}h/month)</h4>
          <table class="schedule-table">
            <thead>
              <tr>
                <th>Agent</th>
                <th>Month</th>
                <th>Total Hours</th>
                <th>Overtime Hours</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      data.monthly.forEach(item => {
        html += `
          <tr>
            <td>${escapeHtml(item.user)}</td>
            <td>${escapeHtml(item.period)}</td>
            <td><strong>${item.totalHours.toFixed(1)}h</strong></td>
            <td><span class="overtime-badge">+${item.overtimeHours.toFixed(1)}h</span></td>
          </tr>
        `;
      });
      
      html += `</tbody></table></div>`;
      
      container.innerHTML = html;
      
      // Initialize sub-tabs
      initializeSubTabs();
    }

    function initializeSubTabs() {
      document.querySelectorAll('.sub-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          // Remove active class from all sub-tabs and contents
          document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.sub-tab-content').forEach(c => c.classList.remove('active'));
          
          // Add active class to clicked sub-tab and corresponding content
          tab.classList.add('active');
          const subtabId = tab.getAttribute('data-subtab');
          document.getElementById(`${subtabId}-overtime`).classList.add('active');
        });
      });
    }

    function renderAbsenceResults(data, thresholdHours, startDate, endDate) {
      const container = document.getElementById('absenceResults');
      container.style.display = 'block';
      
      if (data.length === 0) {
        container.innerHTML = `<div class="info-message">No absence detected for the selected period.</div>`;
        return;
      }
      
      // Sort by total hours (descending)
      data.sort((a, b) => b.totalHours - a.totalHours);
      
      let html = `
        <h3 class="section-title">Absence Report</h3>
        <div class="schedule-meta">
          <span class="pill">Period: ${startDate} to ${endDate}</span>
          &nbsp;
          <span class="pill">Threshold: ${thresholdHours} hours</span>
          &nbsp;
          <span class="pill">Agents with absence: ${data.length}</span>
        </div>
        
        <table class="schedule-table">
          <thead>
            <tr>
              <th>Agent</th>
              <th>Total Absence Hours</th>
              <th>Absence Days</th>
              <th>Instances</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      data.forEach(item => {
        const statusClass = item.exceedsThreshold ? 'warning-row' : '';
        const statusBadge = item.exceedsThreshold 
          ? `<span class="absence-badge">Above Threshold</span>` 
          : `<span class="pill">Within Limits</span>`;
        
        html += `
          <tr class="${statusClass}">
            <td>${escapeHtml(item.user)}</td>
            <td><strong>${item.totalHours.toFixed(1)}h</strong></td>
            <td>${item.absenceDays}</td>
            <td>${item.instances}</td>
            <td>${statusBadge}</td>
          </tr>
        `;
      });
      
      html += `</tbody></table>`;
      container.innerHTML = html;
    }
  </script>
</body>
</html>
